<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script src="config.js"></script>

    <style>
        :root {
            --primary-bg: #0f0f0f;
            --secondary-bg: #1a1a1a;
            --accent-color: #ff2d95;
            --accent-glow: 0 0 15px rgba(255, 45, 149, 0.7);
            --text-color: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #333333;
            --success-color: #00c853;
            --warning-color: #ffcc00;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--primary-bg);
            color: var(--text-color);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--secondary-bg);
            padding: 20px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
            color: var(--accent-color);
            text-shadow: var(--accent-glow);
        }

        .nav-item {
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }

        .nav-item:hover {
            background-color: rgba(255, 45, 149, 0.1);
        }

        .nav-item.active {
            background-color: rgba(255, 45, 149, 0.2);
            color: var(--accent-color);
            box-shadow: var(--accent-glow);
        }

        .nav-icon {
            margin-right: 10px;
            font-size: 18px;
        }

        .user-info {
            margin-top: auto;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .time-display {
            font-size: 28px;
            font-weight: bold;
            text-shadow: var(--accent-glow);
        }

        .date-display {
            color: var(--text-secondary);
            font-size: 18px;
        }

        /* Tombol Logout yang Lebih Kecil */
        .logout-btn {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            position: absolute;
            top: 0;
            right: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 10px rgba(108, 117, 125, 0.7);
        }

        /* Main Dashboard Layout */
        .dashboard-main {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 30px;
        }

        /* Attendance Hub - Larger Design */
        .attendance-hub {
            background: linear-gradient(135deg, #1a1a1a, #2a1a2a);
            border-radius: 16px;
            padding: 40px;
            border: 1px solid rgba(255, 45, 149, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .attendance-hub::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,45,149,0.15) 0%, rgba(255,45,149,0) 70%);
            z-index: 0;
        }

        /* Container dropdown custom */
        .custom-select-container {
            position: relative;
            width: 100%;
        }

        #employeeSelect {
            width: 100%;
            padding: 18px 25px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            background: linear-gradient(145deg, rgba(26, 26, 26, 0.9), rgba(40, 40, 40, 0.9));
            color: var(--text-color);
            font-size: 16px;
            font-weight: 500;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            backdrop-filter: blur(10px);
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.3),
                0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Custom arrow untuk dropdown */
        .custom-select-container::after {
            content: "‚ñº";
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            color: var(--accent-color);
            font-size: 12px;
            pointer-events: none;
            transition: transform 0.3s ease;
        }

        .custom-select-container:hover::after {
            transform: translateY(-50%) scale(1.2);
        }

        /* Hover effect pada dropdown */
        #employeeSelect:hover {
            border-color: rgba(255, 45, 149, 0.5);
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.3),
                0 4px 20px rgba(255, 45, 149, 0.15);
            background: linear-gradient(145deg, rgba(30, 30, 30, 0.95), rgba(45, 45, 45, 0.95));
        }

        /* Focus effect pada dropdown */
        #employeeSelect:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.3),
                0 0 0 3px rgba(255, 45, 149, 0.1),
                0 4px 25px rgba(255, 45, 149, 0.25);
            background: linear-gradient(145deg, rgba(35, 35, 35, 1), rgba(50, 50, 50, 1));
            transform: translateY(-2px);
        }

        /* Styling untuk option dalam dropdown */
        #employeeSelect option {
            background-color: var(--secondary-bg);
            color: var(--text-color);
            padding: 15px 20px;
            font-size: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        /* Option pertama (placeholder) */
        #employeeSelect option[value=""] {
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }

        /* Grouping untuk kategori karyawan */
        .optgroup {
            font-weight: bold;
            color: var(--accent-color) !important;
            background: rgba(255, 45, 149, 0.1) !important;
            padding: 10px 15px !important;
            font-size: 14px !important;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* Placeholder styling */
        #employeeSelect option:first-child {
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Animasi untuk dropdown ketika dipilih */
        @keyframes selectPulse {
            0% {
                box-shadow: 
                    inset 0 2px 4px rgba(0, 0, 0, 0.3),
                    0 0 0 0 rgba(255, 45, 149, 0.4);
            }
            70% {
                box-shadow: 
                    inset 0 2px 4px rgba(0, 0, 0, 0.3),
                    0 0 0 15px rgba(255, 45, 149, 0);
            }
            100% {
                box-shadow: 
                    inset 0 2px 4px rgba(0, 0, 0, 0.3),
                    0 0 0 0 rgba(255, 45, 149, 0);
            }
        }

        #employeeSelect:focus {
            animation: selectPulse 1.5s ease;
        }

        /* Styling untuk dropdown saat valid (telah memilih) */
        #employeeSelect:valid {
            border-color: var(--success-color);
            color: var(--text-color);
        }

        /* Error state untuk dropdown */
        #employeeSelect.error {
            border-color: #ff4757;
            animation: errorShake 0.5s ease;
        }

        @keyframes errorShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* Success state untuk dropdown */
        #employeeSelect.success {
            border-color: var(--success-color);
            animation: successGlow 1s ease;
        }

        @keyframes successGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(0, 200, 83, 0); }
            50% { box-shadow: 0 0 20px rgba(0, 200, 83, 0.5); }
        }

        /* Styling untuk tombol navigasi mingguan */
        .week-nav-btn {
            padding: 8px 16px !important;
            font-size: 12px !important;
            border-radius: 6px !important;
            font-weight: 500 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            border: 1px solid var(--border-color) !important;
            transition: all 0.3s ease !important;
            cursor: pointer !important;
        }

        .week-nav-prev {
            background: linear-gradient(135deg, #6c757d, #495057) !important;
            color: white !important;
        }

        .week-nav-next {
            background: linear-gradient(135deg, var(--accent-color), #ff5e9c) !important;
            color: white !important;
        }

        .week-nav-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
        }

        .week-nav-prev:hover {
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3) !important;
        }

        .week-nav-next:hover {
            box-shadow: 0 4px 12px rgba(255, 45, 149, 0.3) !important;
        }

        /* Container untuk navigasi mingguan */
        .week-nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .week-range-display {
            font-weight: bold;
            color: var(--accent-color);
            font-size: 14px;
            text-align: center;
            flex-grow: 1;
            padding: 0 10px;
        }

        .attendance-hub-content {
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .hub-title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--accent-color);
            text-shadow: var(--accent-glow);
        }

        .hub-subtitle {
            color: var(--text-secondary);
            margin-bottom: 40px;
            font-size: 18px;
        }

        .divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-color), transparent);
            margin: 30px 0;
        }

        .current-time-label {
            color: var(--text-secondary);
            font-size: 16px;
            margin-bottom: 10px;
        }

        .current-time {
            font-size: 42px;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: var(--accent-glow);
        }

        .current-date {
            color: var(--text-secondary);
            font-size: 20px;
            margin-bottom: 40px;
        }

        .status-container {
            margin: 30px 0;
        }

        .status-message {
            font-size: 22px;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 25px;
            font-weight: bold;
        }

        .checked-out {
            background-color: rgba(255, 45, 149, 0.15);
            color: var(--accent-color);
            border: 2px solid rgba(255, 45, 149, 0.4);
        }

        .checked-in {
            background-color: rgba(0, 200, 83, 0.15);
            color: var(--success-color);
            border: 2px solid rgba(0, 200, 83, 0.4);
        }

        .duration-display {
            font-size: 28px;
            font-weight: bold;
            margin: 20px 0;
            color: var(--accent-color);
            text-shadow: var(--accent-glow);
        }

        .action-buttons {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .checkin-btn {
            background: linear-gradient(135deg, var(--accent-color), #ff5e9c);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 12px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            box-shadow: var(--accent-glow);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .modal-overlay.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }

        .checkin-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 25px rgba(255, 17, 156, 0.9);
        }

        .checkin-btn:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .checkout-btn {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 12px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .checkout-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 15px rgba(108, 117, 125, 0.7);
        }

        .checkout-btn:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Side Panel */
        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .card {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .card:hover {
            box-shadow: var(--accent-glow);
            transform: translateY(-5px);
        }

        .card-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--accent-color);
            display: flex;
            align-items: center;
        }

        .card-icon {
            margin-right: 10px;
            font-size: 22px;
        }

        .attendance-list {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .attendance-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .attendance-time {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .active-employee {
            color: var(--accent-color);
            font-weight: bold;
        }

        /* Bottom Section */
        .dashboard-bottom {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .warning {
            color: var(--warning-color);
            background-color: rgba(255, 204, 0, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid var(--warning-color);
        }

        .employee-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .employee-card {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .employee-card:hover {
            background-color: rgba(255, 45, 149, 0.1);
            transform: translateY(-3px);
        }

        .employee-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .employee-position {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .hours-warning {
            color: #ff6b6b;
            font-size: 12px;
            margin-top: 5px;
        }

        /* Login Popup */
        .login-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-in-out;
        }

        .login-popup.hidden {
            display: none;
        }

        .login-popup-content {
            background: linear-gradient(135deg, #1a1a1a, #2a1a2a);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 500px;
            border: 2px solid var(--accent-color);
            box-shadow: var(--accent-glow);
            animation: slideUp 0.4s ease-out;
            position: relative;
            overflow: hidden;
        }

        .login-popup-content::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,45,149,0.1) 0%, rgba(255,45,149,0) 70%);
            z-index: 0;
        }

        .login-popup-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }

        .login-popup-title {
            font-size: 32px;
            font-weight: bold;
            color: var(--accent-color);
            text-shadow: var(--accent-glow);
            margin-bottom: 10px;
        }

        .login-popup-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
            z-index: 1;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-size: 16px;
            color: var(--text-color);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(255, 45, 149, 0.3);
        }

        .password-input-container {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
        }

        .login-popup-btn {
            background: linear-gradient(135deg, var(--accent-color), #ff5e9c);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
            box-shadow: var(--accent-glow);
            position: relative;
            z-index: 1;
        }

        .login-popup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(255, 45, 149, 0.9);
        }

        .hidden {
            display: none;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Password Modal */
        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            animation: fadeIn 0.3s ease-in-out;
        }

        .password-modal.hidden {
            display: none;
        }

        .password-modal-content {
            background: linear-gradient(135deg, #1a1a1a, #2a1a2a);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 450px;
            border: 2px solid var(--accent-color);
            box-shadow: var(--accent-glow);
            animation: slideUp 0.4s ease-out;
            position: relative;
            overflow: hidden;
        }

        .password-modal-content::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,45,149,0.1) 0%, rgba(255,45,149,0) 70%);
            z-index: 0;
        }

        .password-modal-title {
            text-align: center;
            margin-bottom: 20px;
            color: var(--accent-color);
            font-size: 28px;
            font-weight: bold;
            text-shadow: var(--accent-glow);
            position: relative;
            z-index: 1;
        }

        .selected-employee {
            text-align: center;
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 45, 149, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 45, 149, 0.3);
            position: relative;
            z-index: 1;
        }

        .employee-role-badge {
            display: inline-block;
            padding: 4px 12px;
            background: var(--accent-color);
            color: white;
            border-radius: 6px;
            font-size: 12px;
            margin-left: 8px;
            font-weight: bold;
        }

        /* Weekly Overview Styles */
        .week-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .day-card {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .day-card:hover {
            background-color: rgba(255, 45, 149, 0.1);
            transform: translateY(-3px);
        }

        .day-name {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .day-date {
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 5px;
        }

        .day-hours {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .low-hours {
            color: #ff6b6b;
        }

        .good-hours {
            color: var(--success-color);
        }

        /* Daily Attendance Details */
        .daily-details {
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        .daily-details-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--accent-color);
        }

        .daily-attendance-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .daily-attendance-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .daily-attendance-info {
            flex: 1;
        }

        .daily-attendance-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .daily-attendance-time {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .daily-attendance-duration {
            color: var(--accent-color);
            font-weight: bold;
            font-size: 14px;
        }

        .no-data {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
            font-style: italic;
        }

        /* Check-in Details */
        .checkin-details {
            background: rgba(255, 45, 149, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 45, 149, 0.3);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .detail-label {
            color: var(--text-secondary);
        }

        .detail-value {
            font-weight: bold;
            color: var(--accent-color);
        }

        /* Weekly Summary */
        .weekly-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .summary-label {
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* Employee Detail Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--secondary-bg);
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--accent-color);
            box-shadow: var(--accent-glow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 24px;
            color: var(--accent-color);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .close-btn:hover {
            color: var(--accent-color);
        }

        .employee-detail-info {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .detail-week-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
        }

        .week-range {
            font-weight: bold;
            color: var(--accent-color);
        }

        .employee-detail-week {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .employee-day-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
        }

        .employee-day-card.has-data {
            background: rgba(255, 45, 149, 0.1);
            border: 1px solid rgba(255, 45, 149, 0.3);
        }

        .employee-day-card:hover {
            transform: translateY(-2px);
        }

        .employee-day-sessions {
            margin-top: 10px;
            font-size: 12px;
        }

        .employee-session {
            margin-bottom: 5px;
            padding: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        /* Notifikasi */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #1a1a1a, #2a1a2a);
            color: var(--text-color);
            padding: 15px 20px;
            border-radius: 10px;
            border: 2px solid var(--accent-color);
            box-shadow: var(--accent-glow);
            z-index: 9999;
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-icon {
            color: var(--accent-color);
            font-size: 20px;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            color: var(--accent-color);
            font-weight: bold;
            margin-bottom: 5px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Login Popup -->
    <div id="loginPopup" class="login-popup">
        <div class="login-popup-content">
            <div class="login-popup-header">
                <h1 class="login-popup-title">ATTENDANCE SYSTEM</h1>
                <p class="login-popup-subtitle">Silakan pilih karyawan untuk melanjutkan</p>
            </div>
            <div class="form-group">
                <label class="form-label">Nama Karyawan</label>
                <select id="employeeSelect" class="form-input">
                    <option value="">Pilih Karyawan</option>
                    <!-- Options akan diisi oleh JavaScript -->
                </select>
            </div>
            <button id="loginBtn" class="login-popup-btn">Login ke Dashboard</button>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="password-modal hidden">
        <div class="password-modal-content">
            <h2 class="password-modal-title">Password Required</h2>
            <div class="selected-employee">
                <strong id="selectedEmployeeName">Nama Karyawan</strong>
                <span class="employee-role-badge" id="selectedEmployeeRole">Role</span>
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <div class="password-input-container">
                    <input type="password" id="passwordInput" class="form-input" placeholder="Masukkan password">
                    <button type="button" class="toggle-password" id="togglePassword">üëÅÔ∏è</button>
                </div>
            </div>
            <div class="form-group">
                <button id="submitPassword" class="login-popup-btn">Submit Password</button>
                <button id="cancelPassword" class="checkout-btn" style="width: 100%; margin-top: 10px; padding: 15px; border-radius: 10px;">Kembali</button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="container hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">ATTENDANCE</div>
            <div class="nav-item active" data-tab="dashboard-tab">
                <span class="nav-icon">üìä</span> Dashboard
            </div>
            <div class="nav-item" data-tab="history-tab">
                <span class="nav-icon">üìÖ</span> History
            </div>
            <div id="bossNav" class="nav-item hidden" data-tab="employees-tab">
                <span class="nav-icon">üë•</span> Employees Data
            </div>
            <div id="weeklyNav" class="nav-item hidden" data-tab="weekly-tab">
                <span class="nav-icon">üìà</span> Weekly Recap
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div>
                    <div id="userName">User</div>
                    <div id="userRole" style="font-size: 12px; color: var(--text-secondary);">Role</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <div>
                    <div class="time-display" id="currentTime">00:00:00</div>
                    <div class="date-display" id="currentDate">Hari, Tanggal</div>
                </div>
                <!-- Tombol Logout yang Lebih Kecil di Pojok Kanan Atas -->
                <button id="logoutBtn" class="logout-btn">Logout</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content">
                <div class="dashboard-main">
                    <!-- Attendance Hub - Larger Design -->
                    <div class="attendance-hub">
                        <div class="attendance-hub-content">
                            <h2 class="hub-title">Attendance Hub</h2>
                            <p class="hub-subtitle">This attendance will be checked against the attendance log recorded in the city</p>
                            
                            <div class="divider"></div>
                            
                            <div class="current-time-label">Current Time</div>
                            <div class="current-time" id="hubCurrentTime">06:07:00</div>
                            <div class="current-date" id="hubCurrentDate">Monday, December 1, 2025</div>
                            
                            <div class="status-container">
                                <div id="statusMessage" class="status-message checked-out">
                                    You are currently checked out.
                                </div>
                                
                                <div id="durationDisplay" class="duration-display">0h 0m</div>
                                
                                <div id="checkinDetails" class="checkin-details hidden">
                                    <div class="detail-row">
                                        <span class="detail-label">Checked in at:</span>
                                        <span class="detail-value" id="checkinTimeValue">--:--:--</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Duration:</span>
                                        <span class="detail-value" id="currentDurationValue">0h 0m</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="action-buttons">
                                <button id="checkinBtn" class="checkin-btn">Check In</button>
                                <button id="checkoutBtn" class="checkout-btn" disabled>Check Out</button>
                            </div>
                        </div>
                    </div>

                    <!-- Side Panel -->
                    <div class="side-panel">
                        <!-- Today's Check-ins -->
                        <div class="card">
                            <h3 class="card-title">
                                <span class="card-icon">üìã</span> Today's Check-Ins
                            </h3>
                            <ul class="attendance-list" id="todayCheckins">
                                <li>Loading...</li>
                            </ul>
                        </div>

                        <!-- Currently Active -->
                        <div class="card">
                            <h3 class="card-title">
                                <span class="card-icon">‚è±Ô∏è</span> Currently Active
                            </h3>
                            <div id="activeEmployees">
                                <p>Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bottom Section -->
                <div class="dashboard-bottom">
                    <!-- Attendance History -->
                    <div class="card">
                        <h3 class="card-title">
                            <span class="card-icon">üìä</span> Attendance History
                        </h3>
                        <p>Your recent attendance records:</p>
                        <ul class="attendance-list" id="attendanceHistory">
                            <li>Loading...</li>
                        </ul>
                    </div>

                    <!-- Weekly Hours Warning -->
                    <div id="weeklyWarning" class="card hidden">
                        <h3 class="card-title">
                            <span class="card-icon">‚ö†Ô∏è</span> Weekly Hours Alert
                        </h3>
                        <div id="warningContent">
                            <!-- Warning content will be added here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history-tab" class="tab-content hidden">
                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üìÖ</span> Full Attendance History
                    </h3>
                    <div id="fullHistory">
                        <!-- Full history will be added here -->
                    </div>
                </div>
            </div>

            <!-- Employees Tab (Boss Only) -->
            <div id="employees-tab" class="tab-content hidden">
                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üë•</span> All Employees
                    </h3>
                    <div class="employee-list" id="allEmployees">
                        <!-- All employees will be listed here -->
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üìä</span> Weekly Attendance Overview
                    </h3>
                    <div id="weeklyOverview">
                        <!-- Weekly overview will be added here -->
                    </div>
                </div>
            </div>

            <!-- Weekly Report Tab (Boss Only) -->
            <div id="weekly-tab" class="tab-content hidden">
                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üìà</span> Laporan Absensi Mingguan
                    </h3>
                    
                    <!-- Weekly Summary -->
                    <div class="weekly-summary">
                        <div class="summary-card">
                            <div class="summary-value" id="totalEmployees">0</div>
                            <div class="summary-label">Total Karyawan</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value" id="avgHours">0h</div>
                            <div class="summary-label">Rata-rata Jam/Minggu</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value" id="underperforming">0</div>
                            <div class="summary-label">Kurang dari 21 jam</div>
                        </div>
                    </div>

                    <!-- Week Navigation -->
                    <div class="week-nav-container">
                        <button id="prevWeek" class="week-nav-btn week-nav-prev">Minggu Sebelumnya</button>
                        <div id="currentWeekRange" class="week-range-display">Minggu 1-7 Des 2025</div>
                        <button id="nextWeek" class="week-nav-btn week-nav-next">Minggu Berikutnya</button>
                    </div>

                    <!-- Weekly Calendar View -->
                    <div class="week-view" id="weeklyCalendar">
                        <!-- Calendar days will be populated here -->
                    </div>

                    <!-- Daily Attendance Details -->
                    <div class="daily-details">
                        <h4 class="daily-details-title" id="selectedDayTitle">Pilih hari untuk melihat detail absensi</h4>
                        <div class="daily-attendance-list" id="dailyAttendanceList">
                            <div class="no-data">Pilih salah satu hari di atas untuk melihat detail absensi</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Employee Detail -->
    <div id="employeeDetailModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="employeeDetailTitle">Detail Karyawan</h2>
                <button class="close-btn" id="closeEmployeeDetail">&times;</button>
            </div>
            <div class="employee-detail-info" id="employeeDetailInfo">
                <!-- Employee info will be populated here -->
            </div>
                <div class="week-nav-container">
                    <button id="prevEmployeeWeek" class="week-nav-btn week-nav-prev">Minggu Sebelumnya</button>
                    <div class="week-range-display" id="employeeWeekRange">Minggu 1-7 Des 2025</div>
                    <button id="nextEmployeeWeek" class="week-nav-btn week-nav-next">Minggu Berikutnya</button>
                </div>
            <div class="employee-detail-week" id="employeeDetailWeek">
                <!-- Employee weekly attendance will be populated here -->
            </div>
            <div class="daily-details">
                <h4 class="daily-details-title" id="employeeSelectedDayTitle">Pilih hari untuk melihat detail absensi</h4>
                <div class="daily-attendance-list" id="employeeDailyAttendanceList">
                    <div class="no-data">Pilih salah satu hari di atas untuk melihat detail absensi</div>
                </div>
            </div>
        </div>
    </div>

    <script>

        // Inisialisasi Firebase
        firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.firestore();

        // Data karyawan
        const employees = [
            { id: 1, name: "Admin User", role: "admin", position: "Administrator" },
            { id: 2, name: "Enzy", role: "boss", position: "boss" },
            { id: 3, name: "Don Oska", role: "boss", position: "boss" },
            { id: 4, name: "Ace", role: "boss", position: "boss" },
            { id: 5, name: "Marco", role: "boss", position: "boss" },
            { id: 6, name: "Cartenz", role: "boss", position: "boss" },
            { id: 7, name: "Giw", role: "boss", position: "boss" },
            { id: 8, name: "Vyan", role: "boss", position: "boss" },
            { id: 9, name: "Ryota", role: "boss", position: "boss" },
            { id: 10, name: "Tommm", role: "employee", position: "Manager" },
            { id: 11, name: "Beckham Durrel", role: "employee", position: "Manager" },
            { id: 12, name: "Goby Chana", role: "employee", position: "Manager" },
            { id: 13, name: "Cihyi Mori", role: "employee", position: "Manager" },
            { id: 14, name: "Kyra", role: "employee", position: "Manager" },
            { id: 15, name: "Koko", role: "employee", position: "Manager" },
            { id: 16, name: "Broklyn", role: "employee", position: "Manager" },
            { id: 17, name: "Andre", role: "employee", position: "Manager" },
            { id: 18, name: "Vinsaka", role: "employee", position: "Manager" },
            { id: 19, name: "Yori", role: "employee", position: "Manager" },
            { id: 20, name: "Berhala", role: "employee", position: "Senior Mechanic" },
            { id: 21, name: "Ruby", role: "employee", position: "Senior Mechanic" },
            { id: 22, name: "Maudy", role: "employee", position: "Senior Mechanic" },
            { id: 23, name: "Zairen", role: "employee", position: "Senior Mechanic" },
            { id: 24, name: "Gwen", role: "employee", position: "Senior Mechanic" },
            { id: 25, name: "Aidan", role: "employee", position: "Senior Mechanic" },
            { id: 26, name: "Dahyun", role: "employee", position: "Senior Mechanic" },
            { id: 27, name: "Ruuna", role: "employee", position: "Senior Mechanic" },
            { id: 28, name: "Rachel", role: "employee", position: "Senior Mechanic" },
            { id: 29, name: "Angie", role: "employee", position: "Senior Mechanic" },
            { id: 30, name: "Ucok", role: "employee", position: "Senior Mechanic" },
            { id: 31, name: "Cabe", role: "employee", position: "Senior Mechanic" },
            { id: 32, name: "Saul", role: "employee", position: "Senior Mechanic" },
            { id: 33, name: "Blitz", role: "employee", position: "Senior Mechanic" },
            { id: 35, name: "Muller", role: "employee", position: "Mechanic" },
            { id: 36, name: "Zumi", role: "employee", position: "Mechanic" },
            { id: 37, name: "Ajat", role: "employee", position: "Mechanic" },
            { id: 38, name: "Molly", role: "employee", position: "Mechanic" },
            { id: 39, name: "Mai", role: "employee", position: "Mechanic" },
            { id: 40, name: "Tuffy", role: "employee", position: "Mechanic" },
            { id: 41, name: "Darel", role: "employee", position: "Mechanic" },
            { id: 42, name: "Lucas", role: "employee", position: "Mechanic" },
            { id: 43, name: "Aceng", role: "employee", position: "Mechanic" },
            { id: 44, name: "Vera", role: "employee", position: "Mechanic" },
            { id: 45, name: "Athena", role: "employee", position: "Mechanic" },
            { id: 46, name: "Jeni Unggrr", role: "employee", position: "Mechanic" },
            { id: 47, name: "Latisha", role: "employee", position: "Mechanic" },
            { id: 48, name: "Janiece", role: "employee", position: "Mechanic" },
            { id: 49, name: "Meisya", role: "employee", position: "Mechanic" },
            { id: 50, name: "Yuki", role: "employee", position: "Mechanic" },
            { id: 51, name: "Jonathan", role: "employee", position: "Mechanic" },
            { id: 52, name: "Summer", role: "employee", position: "Training" },
            { id: 53, name: "Cia", role: "employee", position: "Training" },
            { id: 54, name: "Kaguya", role: "employee", position: "Training" },
            { id: 55, name: "Castella", role: "employee", position: "Training" },
            { id: 56, name: "jejeng", role: "employee", position: "Training" },
            { id: 57, name: "Ismaya", role: "employee", position: "Training" },
            { id: 58, name: "Celiste", role: "employee", position: "Mechanic" },
            { id: 59, name: "Lexy", role: "employee", position: "Mechanic" },
            { id: 60, name: "Ami", role: "employee", position: "Senior Mechanic" },
        ];

        // State aplikasi
        let currentUser = null;
        let checkInTime = null;
        let timerInterval = null;
        let currentSessionId = null;
        let currentWeekOffset = 0;
        let currentEmployeeWeekOffset = 0;
        let selectedEmployee = null;
        let pendingEmployee = null;
        let dayChangeInterval = null;

        // Real-time listeners
        let activeListeners = {
            todayCheckins: null,
            activeEmployees: null,
            attendanceHistory: null,
            currentStatus: null,
            fullHistory: null,
            allEmployees: null,
            weeklyOverview: null,
            dailyAttendance: null,
            employeeDetail: null
        };

        // ==================== FUNGSI UTILITY ====================

        // Fungsi untuk mendapatkan waktu WIB
        function getWIBTime() {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const wibTime = new Date(utc + (7 * 3600000));
            return wibTime;
        }

        // Format waktu
        function formatTime(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        function formatDate(date) {
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                timeZone: 'Asia/Jakarta'
            };
            return date.toLocaleDateString('id-ID', options);
        }

        function getTimestampData(data, field) {
            if (!data || !data[field]) return null;
            
            if (data[field] instanceof Date) {
                return data[field];
            }
            
            if (data[field] && typeof data[field].toDate === 'function') {
                return data[field].toDate();
            }
            
            if (typeof data[field] === 'string') {
                return new Date(data[field]);
            }
            
            if (typeof data[field] === 'number') {
                return new Date(data[field]);
            }
            
            return null;
        }

        function formatShortDate(date) {
            const options = { 
                day: 'numeric',
                month: 'short',
                timeZone: 'Asia/Jakarta'
            };
            return date.toLocaleDateString('id-ID', options);
        }

        // Fungsi untuk mendapatkan awal minggu (Senin)
        function getStartOfWeek(date) {
            const day = date.getDay(); // 0 = Minggu, 1 = Senin, ..., 6 = Sabtu
            const diff = day === 0 ? 6 : day - 1;
            const startOfWeek = new Date(date);
            startOfWeek.setDate(date.getDate() - diff);
            startOfWeek.setHours(0, 0, 0, 0);
            return startOfWeek;
        }

        // Fungsi untuk mendapatkan akhir minggu (Minggu)
        function getEndOfWeek(date) {
            const startOfWeek = getStartOfWeek(date);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
            return endOfWeek;
        }

        // Fungsi untuk mendapatkan hari tertentu dalam minggu
        function getDayOfWeek(startOfWeek, dayIndex) {
            const day = new Date(startOfWeek);
            day.setDate(startOfWeek.getDate() + dayIndex);
            return day;
        }

        // Fungsi untuk mendapatkan tanggal mingguan
        function getWeekDates(weekOffset = 0) {
            const today = getWIBTime();
            const startOfWeek = getStartOfWeek(today);
            
            const start = new Date(startOfWeek);
            start.setDate(start.getDate() + (weekOffset * 7));
            
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            end.setHours(23, 59, 59, 999);
            
            return { start, end };
        }

        // Update waktu real-time
        function updateTime() {
            const wibTime = getWIBTime();
            document.getElementById('currentTime').textContent = formatTime(wibTime);
            document.getElementById('currentDate').textContent = formatDate(wibTime);
            document.getElementById('hubCurrentTime').textContent = formatTime(wibTime);
            document.getElementById('hubCurrentDate').textContent = formatDate(wibTime);
        }

        // Hitung durasi
        function calculateDuration(startTime) {
            const now = getWIBTime();
            const diffMs = now - startTime;
            const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            return `${diffHrs}h ${diffMins}m`;
        }

        // Update durasi secara real-time
        function updateDuration() {
            if (checkInTime) {
                const duration = calculateDuration(checkInTime);
                document.getElementById('durationDisplay').textContent = duration;
                document.getElementById('currentDurationValue').textContent = duration;
            }
        }

        // Update status check-in/check-out
        function updateStatusUI() {
            const statusMessage = document.getElementById('statusMessage');
            const checkinBtn = document.getElementById('checkinBtn');
            const checkoutBtn = document.getElementById('checkoutBtn');
            const checkinDetails = document.getElementById('checkinDetails');
            const checkinTimeValue = document.getElementById('checkinTimeValue');
            
            if (checkInTime) {
                statusMessage.textContent = "You are currently checked in.";
                statusMessage.className = "status-message checked-in";
                checkinBtn.disabled = true;
                checkoutBtn.disabled = false;
                checkinDetails.classList.remove('hidden');
                checkinTimeValue.textContent = formatTime(checkInTime);
            } else {
                statusMessage.textContent = "You are currently checked out.";
                statusMessage.className = "status-message checked-out";
                checkinBtn.disabled = false;
                checkoutBtn.disabled = true;
                checkinDetails.classList.add('hidden');
                document.getElementById('durationDisplay').textContent = "0h 0m";
            }
        }

        // ==================== SISTEM AUTO DAY CHANGE ====================

        // Fungsi untuk memeriksa dan menangani pergantian hari
        function handleDayChange() {
            if (!currentUser || !checkInTime) return;
            
            const now = getWIBTime();
            const currentHour = getCurrentHour();
            
            // Jika sudah lewat tengah malam (00:00 - 04:00) dan masih check-in
            if (currentHour >= 0 && currentHour < 4) {
                const checkInDate = checkInTime.toISOString().split('T')[0];
                const currentDate = now.toISOString().split('T')[0];
                
                if (checkInDate !== currentDate) {
                    console.log('Pergantian hari terdeteksi, melakukan auto checkout dan checkin...');
                    
                    // Simpan waktu check-out di hari sebelumnya (23:59:59)
                    const yesterdayEnd = new Date(checkInTime);
                    yesterdayEnd.setDate(yesterdayEnd.getDate());
                    yesterdayEnd.setHours(23, 59, 59, 999);
                    
                    // Pastikan yesterdayEnd tidak lebih besar dari sekarang
                    if (yesterdayEnd > now) {
                        yesterdayEnd.setTime(now.getTime() - 60000);
                    }
                    
                    // Hitung durasi untuk hari kemarin
                    const durationYesterday = calculateDurationForPeriod(checkInTime, yesterdayEnd);
                    
                    // Update check-out untuk session kemarin
                    if (currentSessionId) {
                        db.collection('attendance').doc(currentSessionId).update({
                            checkOut: firebase.firestore.Timestamp.fromDate(yesterdayEnd),
                            duration: durationYesterday,
                            status: 'completed',
                            autoCheckout: true,
                            note: 'Automatically closed due to day change'
                        }).then(() => {
                            console.log('Auto checkout berhasil untuk hari kemarin');
                            
                            // Tunggu 2 detik lalu buat check-in baru
                            setTimeout(() => {
                                createNewCheckInForToday();
                            }, 2000);
                        }).catch(error => {
                            console.error('Error auto checkout:', error);
                        });
                    }
                }
            }
        }

        // Fungsi untuk menghitung durasi untuk periode tertentu
        function calculateDurationForPeriod(startTime, endTime) {
            const diffMs = endTime - startTime;
            const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            return `${diffHrs}h ${diffMins}m`;
        }

        // Fungsi untuk membuat check-in baru untuk hari ini
        function createNewCheckInForToday() {
            const now = getWIBTime();
            
            db.collection('attendance').add({
                employeeId: currentUser.id,
                employeeName: currentUser.name,
                checkIn: firebase.firestore.Timestamp.fromDate(now),
                date: now.toISOString().split('T')[0],
                status: 'active',
                autoCheckin: true
            }).then((docRef) => {
                currentSessionId = docRef.id;
                checkInTime = now;
                
                // Update UI
                updateStatusUI();
                timerInterval = setInterval(updateDuration, 60000);
                updateDuration();
                
                console.log('Auto checkin berhasil untuk hari ini');
                
                // Tampilkan notifikasi
                showNotification('System telah melakukan auto checkout dan checkin untuk pergantian hari');
            }).catch(error => {
                console.error('Error auto checkin:', error);
            });
        }

        // Fungsi untuk mendapatkan jam sekarang
        function getCurrentHour() {
            const now = getWIBTime();
            return now.getHours();
        }

        // Fungsi untuk memeriksa session yang belum checkout saat login
        function checkUnclosedSessions() {
            if (!currentUser) return;
            
            const today = getWIBTime();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            // Cari session yang masih aktif dari kemarin
            db.collection('attendance')
                .where('employeeId', '==', currentUser.id)
                .where('date', '==', yesterdayStr)
                .where('status', '==', 'active')
                .get()
                .then(querySnapshot => {
                    if (!querySnapshot.empty) {
                        querySnapshot.forEach(doc => {
                            const data = doc.data();
                            const checkInTimeData = getTimestampData(data, 'checkIn');
                            
                            // Jika check-in dari kemarin dan belum checkout
                            if (checkInTimeData && checkInTimeData.getDate() !== today.getDate()) {
                                console.log('Menemukan session yang belum checkout dari kemarin');
                                
                                // Auto checkout untuk session kemarin
                                const yesterdayEnd = new Date(checkInTimeData);
                                yesterdayEnd.setHours(23, 59, 59, 999);
                                const durationYesterday = calculateDurationForPeriod(checkInTimeData, yesterdayEnd);
                                
                                db.collection('attendance').doc(doc.id).update({
                                    checkOut: firebase.firestore.Timestamp.fromDate(yesterdayEnd),
                                    duration: durationYesterday,
                                    status: 'completed',
                                    autoCheckout: true,
                                    note: 'Auto closed by system due to day change'
                                }).then(() => {
                                    console.log('Session kemarin telah di auto checkout');
                                    
                                    // Buat check-in untuk hari ini
                                    createNewCheckInForToday();
                                });
                            }
                        });
                    }
                }).catch(error => {
                    console.error('Error checking unclosed sessions:', error);
                });
        }

        // Mulai monitor pergantian hari
        function startDayChangeMonitor() {
            // Hentikan interval sebelumnya jika ada
            if (dayChangeInterval) {
                clearInterval(dayChangeInterval);
            }
            
            // Mulai monitor pergantian hari setiap menit
            dayChangeInterval = setInterval(handleDayChange, 60000);
            
            // Juga cek setiap 30 detik untuk akurasi yang lebih baik
            setInterval(handleDayChange, 30000);
        }

        // ==================== REAL-TIME LISTENERS ====================

        // Fungsi untuk membersihkan semua listener
        function cleanupAllListeners() {
            Object.keys(activeListeners).forEach(key => {
                if (activeListeners[key]) {
                    activeListeners[key]();
                    activeListeners[key] = null;
                }
            });
        }

        // Setup real-time listener untuk today's check-ins
        function setupTodayCheckinsListener() {
            const today = getWIBTime().toISOString().split('T')[0];
            const todayCheckinsElement = document.getElementById('todayCheckins');
            
            // Hapus listener sebelumnya jika ada
            if (activeListeners.todayCheckins) {
                activeListeners.todayCheckins();
            }
            
            // Setup real-time listener
            activeListeners.todayCheckins = db.collection('attendance')
                .where('date', '==', today)
                .orderBy('checkIn', 'desc')
                .onSnapshot(querySnapshot => {
                    todayCheckinsElement.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        todayCheckinsElement.innerHTML = '<li>Tidak ada check-in hari ini</li>';
                        return;
                    }
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const checkInTime = getTimestampData(data, 'checkIn');
                        const checkOutTime = getTimestampData(data, 'checkOut');
                        
                        const listItem = document.createElement('li');
                        listItem.className = 'attendance-item';
                        
                        let statusHtml = '';
                        if (checkInTime) {
                            if (checkOutTime) {
                                statusHtml = `<span class="attendance-time">${formatTime(checkInTime)} - ${formatTime(checkOutTime)}</span>`;
                            } else {
                                statusHtml = `<span class="attendance-time active-employee">${formatTime(checkInTime)} - Active</span>`;
                            }
                            
                            listItem.innerHTML = `
                                <span>${data.employeeName}</span>
                                ${statusHtml}
                            `;
                            todayCheckinsElement.appendChild(listItem);
                        }
                    });
                }, error => {
                    console.error('Error listening to today check-ins:', error);
                    todayCheckinsElement.innerHTML = '<li>Error loading data</li>';
                });
        }

        // Setup real-time listener untuk active employees
        function setupActiveEmployeesListener() {
            const activeEmployeesElement = document.getElementById('activeEmployees');
            
            // Hapus listener sebelumnya jika ada
            if (activeListeners.activeEmployees) {
                activeListeners.activeEmployees();
            }
            
            // Setup real-time listener
            activeListeners.activeEmployees = db.collection('attendance')
                .where('status', '==', 'active')
                .onSnapshot(querySnapshot => {
                    activeEmployeesElement.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        activeEmployeesElement.innerHTML = '<p>There are no active employees</p>';
                        return;
                    }
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const checkInTime = getTimestampData(data, 'checkIn');
                        
                        if (checkInTime) {
                            const duration = calculateDuration(checkInTime);
                            
                            const employeeDiv = document.createElement('div');
                            employeeDiv.className = 'attendance-item active-employee';
                            employeeDiv.innerHTML = `
                                <span>${data.employeeName}</span>
                                <span class="attendance-time">${duration}</span>
                            `;
                            activeEmployeesElement.appendChild(employeeDiv);
                        }
                    });
                }, error => {
                    console.error('Error listening to active employees:', error);
                    activeEmployeesElement.innerHTML = '<p>Error loading data</p>';
                });
        }

        // Setup real-time listener untuk attendance history
        function setupAttendanceHistoryListener() {
            const historyElement = document.getElementById('attendanceHistory');
            
            if (!currentUser) return;
            
            // Hapus listener sebelumnya jika ada
            if (activeListeners.attendanceHistory) {
                activeListeners.attendanceHistory();
            }
            
            // Setup real-time listener
            activeListeners.attendanceHistory = db.collection('attendance')
                .where('employeeId', '==', currentUser.id)
                .orderBy('checkIn', 'desc')
                .limit(5)
                .onSnapshot(querySnapshot => {
                    historyElement.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        historyElement.innerHTML = '<li>Tidak ada riwayat</li>';
                        return;
                    }
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const checkInTime = getTimestampData(data, 'checkIn');
                        const checkOutTime = getTimestampData(data, 'checkOut');
                        
                        if (checkInTime) {
                            const listItem = document.createElement('li');
                            listItem.className = 'attendance-item';
                            
                            if (checkOutTime) {
                                listItem.innerHTML = `
                                    <span>${formatDate(checkInTime)}</span>
                                    <span class="attendance-time">${formatTime(checkInTime)} - ${formatTime(checkOutTime)}</span>
                                `;
                            } else {
                                listItem.innerHTML = `
                                    <span>${formatDate(checkInTime)}</span>
                                    <span class="attendance-time active-employee">${formatTime(checkInTime)} - Active</span>
                                `;
                            }
                            
                            historyElement.appendChild(listItem);
                        }
                    });
                }, error => {
                    console.error('Error listening to attendance history:', error);
                    historyElement.innerHTML = '<li>Error loading data</li>';
                });
        }

        // Setup real-time listener untuk current status
        function setupCurrentStatusListener() {
            if (!currentUser) return;
            
            // Hapus listener sebelumnya jika ada
            if (activeListeners.currentStatus) {
                activeListeners.currentStatus();
            }
            
            // Setup real-time listener untuk status aktif user saat ini
            activeListeners.currentStatus = db.collection('attendance')
                .where('employeeId', '==', currentUser.id)
                .where('status', '==', 'active')
                .onSnapshot(querySnapshot => {
                    if (querySnapshot.empty) {
                        // Tidak ada session aktif
                        if (checkInTime) {
                            checkInTime = null;
                            currentSessionId = null;
                            clearInterval(timerInterval);
                            updateStatusUI();
                        }
                    } else {
                        // Ada session aktif
                        const doc = querySnapshot.docs[0];
                        const data = doc.data();
                        const checkInTimeData = getTimestampData(data, 'checkIn');
                        const now = getWIBTime();
                        
                        // Periksa apakah session ini dari hari yang berbeda
                        if (checkInTimeData && checkInTimeData.getDate() !== now.getDate()) {
                            // Session dari hari berbeda, auto checkout dan buat baru
                            handleDayChange();
                        } else if (!checkInTime || checkInTime.getTime() !== checkInTimeData.getTime()) {
                            // Session baru atau berbeda, update state
                            checkInTime = checkInTimeData;
                            currentSessionId = doc.id;
                            
                            updateStatusUI();
                            
                            // Hentikan timer lama dan mulai yang baru
                            clearInterval(timerInterval);
                            timerInterval = setInterval(updateDuration, 60000);
                            updateDuration();
                        }
                    }
                }, error => {
                    console.error('Error listening to current status:', error);
                });
        }

        // Setup real-time listener untuk full history
        function setupFullHistoryListener() {
            const fullHistoryElement = document.getElementById('fullHistory');
            
            if (!currentUser) return;
            
            // Hapus listener sebelumnya jika ada
            if (activeListeners.fullHistory) {
                activeListeners.fullHistory();
            }
            
            // Setup real-time listener
            activeListeners.fullHistory = db.collection('attendance')
                .where('employeeId', '==', currentUser.id)
                .orderBy('checkIn', 'desc')
                .onSnapshot(querySnapshot => {
                    fullHistoryElement.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        fullHistoryElement.innerHTML = '<p>Tidak ada riwayat absensi</p>';
                        return;
                    }
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const checkInTime = getTimestampData(data, 'checkIn');
                        const checkOutTime = getTimestampData(data, 'checkOut');
                        
                        if (checkInTime) {
                            const historyItem = document.createElement('div');
                            historyItem.className = 'attendance-item';
                            
                            if (checkOutTime) {
                                historyItem.innerHTML = `
                                    <div>
                                        <strong>${formatDate(checkInTime)}</strong>
                                        <div class="attendance-time">${formatTime(checkInTime)} - ${formatTime(checkOutTime)}</div>
                                    </div>
                                    <div>${data.duration || calculateDuration(checkInTime)}</div>
                                `;
                            } else {
                                historyItem.innerHTML = `
                                    <div>
                                        <strong>${formatDate(checkInTime)}</strong>
                                        <div class="attendance-time active-employee">${formatTime(checkInTime)} - Active</div>
                                    </div>
                                    <div class="active-employee">Sedang aktif</div>
                                `;
                            }
                            
                            fullHistoryElement.appendChild(historyItem);
                        }
                    });
                }, error => {
                    console.error('Error listening to full history:', error);
                    fullHistoryElement.innerHTML = '<p>Error loading data</p>';
                });
        }

        // Setup real-time listener untuk all employees (boss view)
        function setupAllEmployeesListener() {
            const allEmployeesElement = document.getElementById('allEmployees');
            
            // Hapus listener sebelumnya jika ada
            if (activeListeners.allEmployees) {
                activeListeners.allEmployees();
            }
            
            const { start, end } = getWeekDates();
            
            // Setup real-time listener
            activeListeners.allEmployees = db.collection('attendance')
                .where('checkIn', '>=', start)
                .where('checkIn', '<=', end)
                .onSnapshot(querySnapshot => {
                    allEmployeesElement.innerHTML = '';
                    
                    // Buat peta untuk menyimpan jam kerja per karyawan
                    const employeeHoursMap = new Map();
                    
                    // Hitung jam kerja untuk setiap karyawan
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.checkOut) {
                            const checkInTime = getTimestampData(data, 'checkIn');
                            const checkOutTime = getTimestampData(data, 'checkOut');
                            
                            if (checkInTime && checkOutTime) {
                                const diffMs = checkOutTime - checkInTime;
                                const diffHours = diffMs / (1000 * 60 * 60);
                                
                                if (!employeeHoursMap.has(data.employeeId)) {
                                    employeeHoursMap.set(data.employeeId, {
                                        name: data.employeeName,
                                        totalHours: 0
                                    });
                                }
                                
                                const employeeData = employeeHoursMap.get(data.employeeId);
                                employeeData.totalHours += diffHours;
                            }
                        }
                    });
                    
                    // Tampilkan semua karyawan
                    employees.forEach(employee => {
                        if (employee.role !== 'admin') {
                            const employeeCard = document.createElement('div');
                            employeeCard.className = 'employee-card';
                            
                            // Dapatkan jam kerja dari map atau default 0
                            const hoursData = employeeHoursMap.get(employee.id) || { totalHours: 0 };
                            const hours = hoursData.totalHours;
                            
                            let warningHtml = '';
                            if (hours < 21) {
                                warningHtml = `<div class="hours-warning">${hours.toFixed(1)} jam (kurang dari 21 jam)</div>`;
                            }
                            
                            employeeCard.innerHTML = `
                                <div class="employee-name">${employee.name}</div>
                                <div class="employee-position">${employee.position}</div>
                                ${warningHtml}
                            `;
                            
                            employeeCard.addEventListener('click', function() {
                                showEmployeeDetail(employee);
                            });
                            
                            allEmployeesElement.appendChild(employeeCard);
                        }
                    });
                }, error => {
                    console.error('Error listening to all employees:', error);
                    allEmployeesElement.innerHTML = '<div class="no-data">Error loading employee data</div>';
                });
        }

        // Setup real-time listener untuk weekly overview
        function setupWeeklyOverviewListener() {
            const overviewElement = document.getElementById('weeklyOverview');
            
            // Hapus listener sebelumnya jika ada
            if (activeListeners.weeklyOverview) {
                activeListeners.weeklyOverview();
            }
            
            const { start, end } = getWeekDates();
            
            // Setup real-time listener
            activeListeners.weeklyOverview = db.collection('attendance')
                .where('checkIn', '>=', start)
                .where('checkIn', '<=', end)
                .onSnapshot(querySnapshot => {
                    const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];
                    const weekView = document.createElement('div');
                    weekView.className = 'week-view';
                    
                    const today = getWIBTime();
                    const startOfWeek = getStartOfWeek(today);
                    
                    // Buat array untuk menyimpan jam per hari
                    const dayHours = new Array(7).fill(0);
                    
                    // Hitung jam untuk setiap hari
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.checkOut) {
                            const checkInTime = getTimestampData(data, 'checkIn');
                            const checkOutTime = getTimestampData(data, 'checkOut');
                            
                            if (checkInTime && checkOutTime) {
                                const dayIndex = (checkInTime.getDay() + 6) % 7; // Konversi ke Senin-Minggu
                                const diffMs = checkOutTime - checkInTime;
                                const diffHours = diffMs / (1000 * 60 * 60);
                                
                                if (dayIndex >= 0 && dayIndex < 7) {
                                    dayHours[dayIndex] += diffHours;
                                }
                            }
                        }
                    });
                    
                    // Buat card untuk setiap hari
                    for (let i = 0; i < 7; i++) {
                        const day = new Date(startOfWeek);
                        day.setDate(startOfWeek.getDate() + i);
                        
                        const dayCard = document.createElement('div');
                        dayCard.className = 'day-card';
                        
                        const hours = dayHours[i];
                        let hoursClass = '';
                        if (hours < 3) {
                            hoursClass = 'low-hours';
                        } else {
                            hoursClass = 'good-hours';
                        }
                        
                        dayCard.innerHTML = `
                            <div class="day-name">${days[i]}</div>
                            <div class="day-hours ${hoursClass}">${hours.toFixed(1)} jam</div>
                        `;
                        
                        weekView.appendChild(dayCard);
                    }
                    
                    overviewElement.innerHTML = '';
                    overviewElement.appendChild(weekView);
                }, error => {
                    console.error('Error listening to weekly overview:', error);
                    overviewElement.innerHTML = '<div class="no-data">Error loading weekly data</div>';
                });
        }

        // Setup semua real-time listeners
        function setupAllRealTimeListeners() {
            setupTodayCheckinsListener();
            setupActiveEmployeesListener();
            setupAttendanceHistoryListener();
            setupCurrentStatusListener();
            
            if (currentUser.role === 'boss' || currentUser.role === 'admin') {
                setupAllEmployeesListener();
                setupWeeklyOverviewListener();
            }
        }

        // ==================== NOTIFICATION SYSTEM ====================

        // Fungsi untuk menampilkan notifikasi
        function showNotification(message, type = 'info') {
            // Buat elemen notifikasi
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            let icon = '‚ÑπÔ∏è';
            if (type === 'success') icon = '‚úÖ';
            if (type === 'warning') icon = '‚ö†Ô∏è';
            if (type === 'error') icon = '‚ùå';
            
            notification.innerHTML = `
                <span class="notification-icon">${icon}</span>
                <div class="notification-content">
                    <div class="notification-title">System Notification</div>
                    <div>${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Hapus notifikasi setelah 5 detik
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        // ==================== EVENT HANDLERS ====================

        // Toggle password visibility
        document.getElementById('togglePassword').addEventListener('click', function() {
            const passwordInput = document.getElementById('passwordInput');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üîí';
        });

        // Login
        document.getElementById('loginBtn').addEventListener('click', function() {
            const employeeSelect = document.getElementById('employeeSelect');
            const selectedEmployeeId = parseInt(employeeSelect.value);
            
            if (!selectedEmployeeId) {
                alert('Pilih karyawan terlebih dahulu!');
                return;
            }
            
            const employee = employees.find(emp => emp.id === selectedEmployeeId);
            if (employee) {
                // Cek apakah karyawan memerlukan password
                if (employee.role === 'boss' || employee.role === 'admin') {
                    // Tampilkan modal password
                    pendingEmployee = employee;
                    showPasswordModal(employee);
                } else {
                    // Login langsung untuk employee biasa
                    currentUser = employee;
                    showDashboard();
                }
            }
        });

        // Fungsi submit password - menggunakan EMPLOYEE_PASSWORDS dari config.js
        document.getElementById('submitPassword').addEventListener('click', function() {
            const passwordInput = document.getElementById('passwordInput');
            const password = passwordInput.value;
            
            if (!password) {
                alert('Masukkan password terlebih dahulu!');
                return;
            }
            
            if (pendingEmployee) {
                const correctPassword = EMPLOYEE_PASSWORDS[pendingEmployee.name];
                
                if (password === correctPassword) {
                    // Password benar
                    currentUser = pendingEmployee;
                    pendingEmployee = null;
                    passwordInput.value = '';
                    document.getElementById('passwordModal').classList.add('hidden');
                    showDashboard();
                    showNotification('Login berhasil!', 'success');
                } else {
                    alert('Password salah! Silakan coba lagi.');
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            }
        });

        // Cancel password
        document.getElementById('cancelPassword').addEventListener('click', function() {
            pendingEmployee = null;
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordModal').classList.add('hidden');
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (checkInTime) {
                if (!confirm('Anda masih dalam keadaan check in. Yakin ingin logout?')) {
                    return;
                }
            }
            
            // Bersihkan semua listener
            cleanupAllListeners();
            
            currentUser = null;
            checkInTime = null;
            currentSessionId = null;
            clearInterval(timerInterval);
            
            // Hentikan monitor pergantian hari
            if (dayChangeInterval) {
                clearInterval(dayChangeInterval);
                dayChangeInterval = null;
            }
            
            showLoginPopup();
            showNotification('Anda telah logout dari sistem', 'info');
        });

        // Check In
        document.getElementById('checkinBtn').addEventListener('click', function() {
            if (!currentUser) return;
            
            const wibTime = getWIBTime();
            checkInTime = wibTime;
            
            // Simpan ke Firebase
            db.collection('attendance').add({
                employeeId: currentUser.id,
                employeeName: currentUser.name,
                checkIn: firebase.firestore.Timestamp.fromDate(wibTime),
                date: wibTime.toISOString().split('T')[0],
                status: 'active'
            }).then((docRef) => {
                currentSessionId = docRef.id;
                showNotification('Check-in berhasil!', 'success');
            }).catch(error => {
                console.error('Error saving check-in:', error);
                showNotification('Gagal melakukan check-in. Silakan coba lagi.', 'error');
            });
        });

        // Check Out
        document.getElementById('checkoutBtn').addEventListener('click', function() {
            if (!currentUser || !checkInTime || !currentSessionId) return;
            
            const wibTime = getWIBTime();
            const duration = calculateDuration(checkInTime);
            
            // Update di Firebase
            db.collection('attendance').doc(currentSessionId).update({
                checkOut: firebase.firestore.Timestamp.fromDate(wibTime),
                duration: duration,
                status: 'completed'
            }).then(() => {
                checkInTime = null;
                currentSessionId = null;
                clearInterval(timerInterval);
                showNotification('Check-out berhasil!', 'success');
            }).catch(error => {
                console.error('Error updating check-out:', error);
                showNotification('Gagal melakukan check-out. Silakan coba lagi.', 'error');
            });
        });

        // Navigasi tab
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.nav-item').forEach(nav => {
                    nav.classList.remove('active');
                });
                
                this.classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.add('hidden');
                });
                
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.remove('hidden');
                
                if (tabId === 'history-tab') {
                    setupFullHistoryListener();
                } else if (tabId === 'weekly-tab') {
                    loadWeeklyReport();
                }
            });
        });

        // Navigasi mingguan
        document.getElementById('prevWeek').addEventListener('click', function() {
            currentWeekOffset--;
            loadWeeklyReport();
        });

        document.getElementById('nextWeek').addEventListener('click', function() {
            currentWeekOffset++;
            loadWeeklyReport();
        });

        // Navigasi mingguan di modal karyawan
        document.getElementById('prevEmployeeWeek').addEventListener('click', function() {
            currentEmployeeWeekOffset--;
            loadEmployeeWeeklyDetail(selectedEmployee);
        });

        document.getElementById('nextEmployeeWeek').addEventListener('click', function() {
            currentEmployeeWeekOffset++;
            loadEmployeeWeeklyDetail(selectedEmployee);
        });

        // Tutup modal karyawan
        document.getElementById('closeEmployeeDetail').addEventListener('click', function() {
            document.getElementById('employeeDetailModal').classList.add('hidden');
        });

        // ==================== DASHBOARD FUNCTIONS ====================

        // Tampilkan login popup
        function showLoginPopup() {
            document.getElementById('loginPopup').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('employeeDetailModal').classList.add('hidden');
            
            // Reset form
            document.getElementById('passwordInput').value = '';
            pendingEmployee = null;
            
            // Isi dropdown karyawan
            const employeeSelect = document.getElementById('employeeSelect');
            employeeSelect.innerHTML = '<option value="">Pilih Karyawan</option>';
            
            // Group karyawan berdasarkan role
            const groups = {
                'admin': 'Administrator',
                'boss': 'Pimpinan',
                'employee': 'Karyawan'
            };
            
            Object.keys(groups).forEach(role => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = groups[role];
                optgroup.className = 'optgroup';
                
                employees.forEach(employee => {
                    if (employee.role === role) {
                        const option = document.createElement('option');
                        option.value = employee.id;
                        option.textContent = `${employee.name} (${employee.position})`;
                        optgroup.appendChild(option);
                    }
                });
                
                if (optgroup.children.length > 0) {
                    employeeSelect.appendChild(optgroup);
                }
            });
        }

        // Tampilkan modal password
        function showPasswordModal(employee) {
            document.getElementById('selectedEmployeeName').textContent = employee.name;
            document.getElementById('selectedEmployeeRole').textContent = employee.role.toUpperCase();
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordInput').focus();
            document.getElementById('passwordModal').classList.remove('hidden');
        }

        // Tampilkan dashboard
        function showDashboard() {
            document.getElementById('loginPopup').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('passwordModal').classList.add('hidden');
            
            // Update info user
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.position;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
            
            // Tampilkan/hilangkan menu boss
            if (currentUser.role === 'boss' || currentUser.role === 'admin') {
                document.getElementById('bossNav').classList.remove('hidden');
                document.getElementById('weeklyNav').classList.remove('hidden');
            } else {
                document.getElementById('bossNav').classList.add('hidden');
                document.getElementById('weeklyNav').classList.add('hidden');
            }
            
            // Setup semua real-time listeners
            setupAllRealTimeListeners();
            
            // Cek session yang belum checkout dari kemarin
            checkUnclosedSessions();
            
            // Mulai monitor pergantian hari
            startDayChangeMonitor();
            
            // Update status UI awal
            updateStatusUI();
        }

        // ==================== EMPLOYEE DETAIL FUNCTIONS ====================

        // Tampilkan modal detail karyawan
        function showEmployeeDetail(employee) {
            selectedEmployee = employee;
            currentEmployeeWeekOffset = 0;
            
            document.getElementById('employeeDetailTitle').textContent = `Detail Karyawan - ${employee.name}`;
            document.getElementById('employeeDetailInfo').innerHTML = `
                <div><strong>Nama:</strong> ${employee.name}</div>
                <div><strong>Posisi:</strong> ${employee.position}</div>
                <div><strong>Role:</strong> ${employee.role}</div>
            `;
            
            loadEmployeeWeeklyDetail(employee);
            document.getElementById('employeeDetailModal').classList.remove('hidden');
        }

        // Load detail mingguan untuk karyawan tertentu
        function loadEmployeeWeeklyDetail(employee) {
            const { start, end } = getWeekDates(currentEmployeeWeekOffset);
            
            document.getElementById('employeeWeekRange').textContent = `Minggu ${formatShortDate(start)} - ${formatShortDate(end)}`;
            displayEmployeeWeeklyCalendar(employee, start);
        }

        // Tampilkan kalender mingguan untuk karyawan tertentu
        function displayEmployeeWeeklyCalendar(employee, startOfWeek) {
            const employeeDetailWeekElement = document.getElementById('employeeDetailWeek');
            employeeDetailWeekElement.innerHTML = '';
            
            const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];
            
            for (let i = 0; i < 7; i++) {
                const day = getDayOfWeek(startOfWeek, i);
                const dateString = day.toISOString().split('T')[0];
                
                const dayCard = document.createElement('div');
                dayCard.className = 'employee-day-card';
                dayCard.setAttribute('data-date', dateString);
                
                getEmployeeDayAttendance(employee.id, dateString).then(attendanceData => {
                    let totalHours = 0;
                    let sessionsHtml = '';
                    
                    if (attendanceData.length > 0) {
                        dayCard.classList.add('has-data');
                        
                        attendanceData.forEach(session => {
                            if (session.checkIn) {
                                const checkInTime = formatTime(session.checkIn);
                                const checkOutTime = session.checkOut ? formatTime(session.checkOut) : 'Active';
                                const duration = session.duration || (session.checkOut ? calculateDuration(session.checkIn) : '0h 0m');
                                
                                sessionsHtml += `<div class="employee-session">${checkInTime} - ${checkOutTime}</div>`;
                                
                                if (session.checkOut) {
                                    const diffMs = session.checkOut - session.checkIn;
                                    totalHours += diffMs / (1000 * 60 * 60);
                                }
                            }
                        });
                    }
                    
                    dayCard.innerHTML = `
                        <div class="day-name">${days[i]}</div>
                        <div class="day-date">${formatShortDate(day)}</div>
                        ${attendanceData.length > 0 ? 
                            `<div class="day-hours">${totalHours.toFixed(1)} jam</div>
                            <div class="employee-day-sessions">${sessionsHtml}</div>` : 
                            '<div class="day-hours">0 jam</div>'
                        }
                    `;
                    
                    dayCard.addEventListener('click', function() {
                        const selectedDate = this.getAttribute('data-date');
                        loadEmployeeDailyAttendance(employee, selectedDate);
                    });
                });
                
                employeeDetailWeekElement.appendChild(dayCard);
            }
        }

        // Ambil data absensi karyawan untuk hari tertentu
        function getEmployeeDayAttendance(employeeId, dateString) {
            return new Promise((resolve) => {
                db.collection('attendance')
                    .where('employeeId', '==', employeeId)
                    .where('date', '==', dateString)
                    .get()
                    .then(querySnapshot => {
                        const attendanceData = [];
                        
                        querySnapshot.forEach(doc => {
                            const data = doc.data();
                            attendanceData.push({
                                checkIn: getTimestampData(data, 'checkIn'),
                                checkOut: getTimestampData(data, 'checkOut'),
                                duration: data.duration
                            });
                        });
                        
                        resolve(attendanceData);
                    }).catch(error => {
                        console.error('Error fetching employee day attendance:', error);
                        resolve([]);
                    });
            });
        }

        function loadEmployeeDailyAttendance(employee, dateString) {
            const employeeSelectedDayTitle = document.getElementById('employeeSelectedDayTitle');
            const employeeDailyAttendanceList = document.getElementById('employeeDailyAttendanceList');
            
            const date = new Date(dateString);
            employeeSelectedDayTitle.textContent = `Detail Absensi ${employee.name} - ${formatDate(date)}`;
            
            getEmployeeDayAttendance(employee.id, dateString).then(attendanceData => {
                employeeDailyAttendanceList.innerHTML = '';
                
                if (attendanceData.length === 0) {
                    employeeDailyAttendanceList.innerHTML = '<div class="no-data">Tidak ada absensi pada hari ini</div>';
                    return;
                }
                
                let totalDurationMinutes = 0;
                
                attendanceData.forEach(session => {
                    if (session.checkIn) {
                        const sessionItem = document.createElement('div');
                        sessionItem.className = 'daily-attendance-item';
                        
                        const checkInTime = formatTime(session.checkIn);
                        const checkOutTime = session.checkOut ? formatTime(session.checkOut) : 'Active';
                        const duration = session.duration || (session.checkOut ? calculateDuration(session.checkIn) : '0h 0m');
                        
                        sessionItem.innerHTML = `
                            <div class="daily-attendance-info">
                                <div class="daily-attendance-time">${checkInTime} - ${checkOutTime}</div>
                            </div>
                            <div class="daily-attendance-duration">${duration}</div>
                        `;
                        
                        employeeDailyAttendanceList.appendChild(sessionItem);
                        
                        if (session.checkOut) {
                            const diffMs = session.checkOut - session.checkIn;
                            totalDurationMinutes += diffMs / (1000 * 60);
                        }
                    }
                });
                
                const totalHours = Math.floor(totalDurationMinutes / 60);
                const totalMins = Math.floor(totalDurationMinutes % 60);
                const totalItem = document.createElement('div');
                totalItem.className = 'daily-attendance-item';
                totalItem.style.borderTop = '2px solid var(--accent-color)';
                totalItem.style.fontWeight = 'bold';
                totalItem.innerHTML = `
                    <div class="daily-attendance-info">
                        <div class="daily-attendance-name">Total</div>
                    </div>
                    <div class="daily-attendance-duration">${totalHours}h ${totalMins}m</div>
                `;
                
                employeeDailyAttendanceList.appendChild(totalItem);
            });
        }

        // ==================== WEEKLY REPORT FUNCTIONS ====================

        // Load weekly report for boss
        function loadWeeklyReport() {
            if (!currentUser || (currentUser.role !== 'boss' && currentUser.role !== 'admin')) return;
            
            const { start, end } = getWeekDates(currentWeekOffset);
            
            document.getElementById('currentWeekRange').textContent = `Minggu ${formatShortDate(start)} - ${formatShortDate(end)}`;
            calculateWeeklyStats(start, end);
            displayWeeklyCalendar(start);
        }

        // Hitung statistik mingguan
        function calculateWeeklyStats(startOfWeek, endOfWeek) {
            const totalEmployeesElement = document.getElementById('totalEmployees');
            const avgHoursElement = document.getElementById('avgHours');
            const underperformingElement = document.getElementById('underperforming');
            
            const totalEmployees = employees.filter(emp => emp.role !== 'admin').length;
            totalEmployeesElement.textContent = totalEmployees;
            
            let totalHoursAll = 0;
            let underperformingCount = 0;
            let employeeCount = 0;
            
            const promises = employees
                .filter(emp => emp.role !== 'admin')
                .map(employee => {
                    return calculateEmployeeWeeklyHoursForDateRange(employee.id, startOfWeek, endOfWeek)
                        .then(hours => {
                            totalHoursAll += hours;
                            employeeCount++;
                            if (hours < 21) {
                                underperformingCount++;
                            }
                        });
                });
            
            Promise.all(promises).then(() => {
                const avgHours = employeeCount > 0 ? totalHoursAll / employeeCount : 0;
                avgHoursElement.textContent = `${avgHours.toFixed(1)}h`;
                underperformingElement.textContent = underperformingCount;
            });
        }

        // Hitung jam kerja mingguan untuk rentang tanggal tertentu
        function calculateEmployeeWeeklyHoursForDateRange(employeeId, startDate, endDate) {
            return new Promise((resolve) => {
                db.collection('attendance')
                    .where('employeeId', '==', employeeId)
                    .get()
                    .then(querySnapshot => {
                        let totalMinutes = 0;
                        
                        querySnapshot.forEach(doc => {
                            const data = doc.data();
                            const checkInTime = getTimestampData(data, 'checkIn');
                            
                            if (checkInTime >= startDate && checkInTime <= endDate && data.checkOut) {
                                const checkOutTime = getTimestampData(data, 'checkOut');
                                const diffMs = checkOutTime - checkInTime;
                                totalMinutes += diffMs / (1000 * 60);
                            }
                        });
                        
                        const totalHours = totalMinutes / 60;
                        resolve(totalHours);
                    }).catch(error => {
                        console.error('Error calculating employee weekly hours:', error);
                        resolve(0);
                    });
            });
        }

        // Tampilkan kalender mingguan
        function displayWeeklyCalendar(startOfWeek) {
            const weeklyCalendarElement = document.getElementById('weeklyCalendar');
            weeklyCalendarElement.innerHTML = '';
            
            const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];
            
            for (let i = 0; i < 7; i++) {
                const day = getDayOfWeek(startOfWeek, i);
                
                const dayCard = document.createElement('div');
                dayCard.className = 'day-card';
                dayCard.setAttribute('data-date', day.toISOString().split('T')[0]);
                
                calculateDayTotalHours(day).then(totalHours => {
                    let hoursClass = '';
                    if (totalHours === 0) {
                        hoursClass = 'low-hours';
                    } else if (totalHours < 10) {
                        hoursClass = 'low-hours';
                    } else {
                        hoursClass = 'good-hours';
                    }
                    
                    dayCard.innerHTML = `
                        <div class="day-name">${days[i]}</div>
                        <div class="day-date">${formatShortDate(day)}</div>
                        <div class="day-hours ${hoursClass}">${totalHours.toFixed(1)} jam</div>
                    `;
                });
                
                dayCard.addEventListener('click', function() {
                    const selectedDate = this.getAttribute('data-date');
                    loadDailyAttendance(selectedDate);
                });
                
                weeklyCalendarElement.appendChild(dayCard);
            }
        }

        // Hitung total jam untuk hari tertentu (semua karyawan)
        function calculateDayTotalHours(date) {
            return new Promise((resolve) => {
                const startOfDay = new Date(date);
                startOfDay.setHours(0, 0, 0, 0);
                
                const endOfDay = new Date(date);
                endOfDay.setHours(23, 59, 59, 999);
                
                db.collection('attendance')
                    .where('checkIn', '>=', startOfDay)
                    .where('checkIn', '<=', endOfDay)
                    .get()
                    .then(querySnapshot => {
                        let totalMinutes = 0;
                        
                        querySnapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.checkOut) {
                                const checkInTime = getTimestampData(data, 'checkIn');
                                const checkOutTime = getTimestampData(data, 'checkOut');
                                const diffMs = checkOutTime - checkInTime;
                                totalMinutes += diffMs / (1000 * 60);
                            }
                        });
                        
                        const totalHours = totalMinutes / 60;
                        resolve(totalHours);
                    }).catch(error => {
                        console.error('Error calculating day total hours:', error);
                        resolve(0);
                    });
            });
        }

        // Load daily attendance details
        function loadDailyAttendance(dateString) {
            const selectedDayTitle = document.getElementById('selectedDayTitle');
            const dailyAttendanceList = document.getElementById('dailyAttendanceList');
            
            const date = new Date(dateString);
            selectedDayTitle.textContent = `Detail Absensi - ${formatDate(date)}`;
            
            db.collection('attendance')
                .where('date', '==', dateString)
                .get()
                .then(querySnapshot => {
                    dailyAttendanceList.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        dailyAttendanceList.innerHTML = '<div class="no-data">Tidak ada absensi pada hari ini</div>';
                        return;
                    }
                    
                    const attendanceByEmployee = {};
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const employeeId = data.employeeId;
                        
                        if (!attendanceByEmployee[employeeId]) {
                            attendanceByEmployee[employeeId] = {
                                name: data.employeeName,
                                sessions: []
                            };
                        }
                        
                        attendanceByEmployee[employeeId].sessions.push({
                            checkIn: getTimestampData(data, 'checkIn'),
                            checkOut: getTimestampData(data, 'checkOut'),
                            duration: data.duration
                        });
                    });
                    
                    Object.values(attendanceByEmployee).forEach(employeeData => {
                        const employeeItem = document.createElement('div');
                        employeeItem.className = 'daily-attendance-item';
                        
                        let totalDurationMinutes = 0;
                        let sessionsHtml = '';
                        
                        employeeData.sessions.forEach(session => {
                            const checkInTime = formatTime(session.checkIn);
                            const checkOutTime = session.checkOut ? formatTime(session.checkOut) : 'Active';
                            const duration = session.duration || (session.checkOut ? calculateDuration(session.checkIn) : '0h 0m');
                            
                            sessionsHtml += `<div class="daily-attendance-time">${checkInTime} - ${checkOutTime}</div>`;
                            
                            if (session.checkOut) {
                                const diffMs = session.checkOut - session.checkIn;
                                totalDurationMinutes += diffMs / (1000 * 60);
                            }
                        });
                        
                        const totalHours = Math.floor(totalDurationMinutes / 60);
                        const totalMins = Math.floor(totalDurationMinutes % 60);
                        const totalDuration = `${totalHours}h ${totalMins}m`;
                        
                        employeeItem.innerHTML = `
                            <div class="daily-attendance-info">
                                <div class="daily-attendance-name">${employeeData.name}</div>
                                ${sessionsHtml}
                            </div>
                            <div class="daily-attendance-duration">${totalDuration}</div>
                        `;
                        
                        dailyAttendanceList.appendChild(employeeItem);
                    });
                }).catch(error => {
                    console.error('Error loading daily attendance:', error);
                    dailyAttendanceList.innerHTML = '<div class="no-data">Error loading data</div>';
                });
        }

        // ==================== INITIALIZATION ====================

        // Inisialisasi aplikasi
        function initApp() {
            setInterval(updateTime, 1000);
            updateTime();
            
            document.getElementById('employeeDetailModal').classList.add('hidden');
            document.getElementById('passwordModal').classList.add('hidden');
            
            showLoginPopup();
            
            // Mulai monitor global untuk semua user (untuk keamanan)
            setInterval(() => {
                if (currentUser && checkInTime) {
                    handleDayChange();
                }
            }, 30000);
            
            console.log('Attendance System initialized with real-time sync and auto day change');
        }

        // Jalankan aplikasi saat halaman dimuat
        window.addEventListener('load', initApp);

        // Tambahkan event listener untuk dropdown
        document.getElementById('employeeSelect').addEventListener('change', function() {
            const select = this;
            
            // Reset semua class
            select.classList.remove('error', 'success', 'loading');
            
            if (select.value) {
                select.classList.add('success');
            } else {
                select.classList.add('error');
            }
        });
    </script>
</body>
</html>