<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICR Attendance</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #3a86ff;
            --primary-light: #e6f0ff;
            --secondary: #00b894;
            --secondary-light: #e8f8f5;
            --danger: #ff6b6b;
            --danger-light: #ffeaea;
            --warning: #ffd166;
            --warning-light: #fff9e6;
            --dark: #2d3436;
            --light: #f8f9fa;
            --gray: #adb5bd;
            --gray-light: #e9ecef;
            --border: #dee2e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-light: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

         /* Tambahan styling untuk fitur export */
        .export-section {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .export-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-btn:hover {
            background: #00a885;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 184, 148, 0.3);
        }
        
        .warning-card {
            background: var(--warning-light);
            border-left: 4px solid var(--warning);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        
        .warning-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .warning-title {
            font-weight: 600;
            color: #e6a700;
        }
        
        .warning-list {
            list-style-type: none;
        }
        
        .warning-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(230, 167, 0, 0.2);
        }
        
        .warning-item:last-child {
            border-bottom: none;
        }
        
        .employee-name {
            font-weight: 600;
        }
        
        .hours-count {
            color: var(--danger);
            font-weight: 600;
        }
        
        .icon-excel::before { content: "üìä"; }
        .icon-warning::before { content: "‚ö†Ô∏è"; }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Layout Dashboard */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: white;
            border-right: 1px solid var(--border);
            padding: 24px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            box-shadow: var(--shadow-light);
        }

        .sidebar-header {
            padding: 0 24px 24px;
            margin-bottom: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 22px;
            font-weight: 700;
            color: var(--primary);
        }

        .logo .icon {
            font-size: 24px;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 0 16px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 10px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.2s ease;
            font-weight: 500;
            cursor: pointer;
        }

        .nav-item:hover {
            background: var(--primary-light);
            color: var(--primary);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item .icon {
            font-size: 18px;
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 0;
        }

        /* Top Header */
        .top-header {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 18px 32px;
            position: sticky;
            top: 0;
            z-index: 99;
            box-shadow: var(--shadow-light);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--dark);
        }

        .current-date {
            color: var(--gray);
            font-size: 14px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-selector {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-dropdown {
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background-color: white;
            color: var(--dark);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 180px;
        }

        .user-role {
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Content Area */
        .content-area {
            padding: 32px;
        }

        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-light);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: var(--primary-light);
            color: var(--primary);
        }

        .stat-trend {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            background: var(--secondary);
            color: white;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--dark);
        }

        .stat-label {
            color: var(--gray);
            font-size: 14px;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-light);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        /* Attendance Action Card */
        .attendance-action {
            background: white;
            text-align: center;
            padding: 32px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-light);
        }

        .attendance-action.checked-in {
            border-left: 4px solid var(--secondary);
        }

        .attendance-time {
            font-size: 48px;
            font-weight: 700;
            margin: 16px 0;
            color: var(--dark);
        }

        .attendance-date {
            font-size: 16px;
            color: var(--gray);
            margin-bottom: 24px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        /* Buttons */
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #2a75f0;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(58, 134, 255, 0.3);
        }

        .btn-success {
            background: var(--secondary);
            color: white;
        }

        .btn-success:hover {
            background: #00a885;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 184, 148, 0.3);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--dark);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .status-checked-in {
            background: var(--secondary-light);
            color: var(--secondary);
        }

        .status-not-checked-in {
            background: var(--warning-light);
            color: #e6a700;
        }

        /* Counter */
        .counter {
            display: flex;
            justify-content: space-between;
            background: var(--light);
            padding: 16px;
            border-radius: 10px;
            margin-top: 16px;
        }

        .counter-item {
            text-align: center;
            flex: 1;
        }

        .counter-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .counter-label {
            font-size: 12px;
            color: var(--gray);
        }

        .counter-warning {
            color: var(--danger);
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background-color: var(--light);
            font-weight: 600;
            color: var(--gray);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background-color: var(--light);
        }

        .status-present {
            color: var(--secondary);
            font-weight: bold;
        }

        .status-absent {
            color: var(--danger);
            font-weight: bold;
        }

        /* Recent Activity */
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            background: var(--light);
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            font-size: 16px;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .activity-time {
            font-size: 12px;
            color: var(--gray);
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 16px 24px;
            border-radius: 10px;
            color: white;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateX(100px);
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow);
        }

        .notification.success {
            background: var(--secondary);
        }

        .notification.error {
            background: var(--danger);
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        /* Filter Section */
        .filter-section {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 14px;
            color: var(--gray);
            font-weight: 500;
        }

        /* Welcome Card */
        .welcome-card {
            background: linear-gradient(135deg, var(--primary), #2a75f0);
            color: white;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            border: none;
            position: relative;
            overflow: hidden;
        }

        .welcome-card::before {
            content: "";
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .welcome-content {
            flex: 1;
            position: relative;
            z-index: 2;
        }

        .welcome-content h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .welcome-subtitle {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 500;
        }

        .welcome-icon {
            font-size: 64px;
            opacity: 0.8;
            margin-left: 20px;
            position: relative;
            z-index: 2;
        }

        /* Popup Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .modal-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--warning-light);
            color: #e6a700;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }

        .modal-body {
            margin-bottom: 24px;
            color: var(--dark);
            line-height: 1.6;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-secondary {
            background: var(--gray-light);
            color: var(--dark);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: var(--gray);
            color: white;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.1);
        }

        .form-input.error {
            border-color: var(--danger);
        }

        .error-message {
            color: var(--danger);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Password Modal */
        .password-modal .modal {
            max-width: 400px;
        }

        .password-instruction {
            background: var(--light);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            color: var(--dark);
        }

        .password-role {
            font-weight: 600;
            color: var(--primary);
        }

        /* Icons */
        .icon::before {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 900;
        }

        .icon-dashboard::before { content: "üìä"; }
        .icon-attendance::before { content: "üìÖ"; }
        .icon-history::before { content: "üïí"; }
        .icon-users::before { content: "üë•"; }
        .icon-settings::before { content: "‚öôÔ∏è"; }
        .icon-checkin::before { content: "‚úÖ"; }
        .icon-checkout::before { content: "üö™"; }
        .icon-clock::before { content: "‚è∞"; }
        .icon-calendar::before { content: "üìÖ"; }
        .icon-trend-up::before { content: "üìà"; }
        .icon-user::before { content: "üë§"; }
        .icon-eye::before { content: "üëÅÔ∏è"; }
        .icon-lock::before { content: "üîí"; }

        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                width: 80px;
            }
            
            .sidebar .nav-text {
                display: none;
            }
            
            .main-content {
                margin-left: 80px;
            }
            
            .logo span {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .quick-stats {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }
            
            .user-info {
                width: 100%;
                justify-content: space-between;
            }
            
            .filter-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .welcome-card {
                flex-direction: column;
                text-align: center;
                padding: 24px;
            }
            
            .welcome-content h2 {
                font-size: 22px;
            }
            
            .welcome-icon {
                margin-left: 0;
                margin-top: 16px;
                font-size: 48px;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none;
        }

        .text-center {
            text-align: center;
        }

        .mb-4 {
            margin-bottom: 24px;
        }

        .mt-4 {
            margin-top: 24px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2a75f0;
        }
    </style>
</head>
<body>
  <!-- Notification -->
    <div id="notification" class="notification">
        <span class="icon icon-checkin"></span>
        <span id="notificationText">Notification text</span>
    </div>
    
    <!-- Popup Modal untuk Pengingat -->
    <div id="userReminderModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon">
                    <span class="icon icon-user"></span>
                </div>
                <h3 class="modal-title">Pengingat</h3>
            </div>
            <div class="modal-body">
                <p>Anda saat ini login sebagai <strong id="currentUserInModal">Ahmad Fauzi</strong>.</p>
                <p>Jika Anda bukan <strong id="currentUserInModal2">Ahmad Fauzi</strong>, silakan ganti nama karyawan di pojok kanan atas untuk melihat data absensi yang sesuai.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="closeModalBtn">Tutup</button>
                <button class="btn btn-primary" id="changeUserBtn">Ganti Karyawan</button>
            </div>
        </div>
    </div>
    
    <!-- Password Modal untuk Admin/Boss -->
    <div id="passwordModal" class="modal-overlay password-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon">
                    <span class="icon icon-lock"></span>
                </div>
                <h3 class="modal-title">Autentikasi Diperlukan</h3>
            </div>
            <div class="modal-body">
                <div class="password-instruction">
                    Anda memilih <span id="selectedRole" class="password-role">Admin</span>. Masukkan password untuk melanjutkan.
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="passwordInput" class="form-input" placeholder="Masukkan password">
                    <div id="passwordError" class="error-message">Password salah. Silakan coba lagi.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancelPasswordBtn">Batal</button>
                <button class="btn btn-primary" id="submitPasswordBtn">Masuk</button>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Container -->
    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="icon icon-dashboard"></span>
                    <span>ICR Attendance</span>
                </div>
            </div>
            
            <div class="sidebar-nav">
                <a href="#" class="nav-item active" data-tab="dashboard">
                    <span class="icon icon-dashboard"></span>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-tab="history">
                    <span class="icon icon-history"></span>
                    <span class="nav-text">Riwayat Absensi</span>
                </a>
                <a href="#" class="nav-item" data-tab="employees" id="employeesNav">
                    <span class="icon icon-users"></span>
                    <span class="nav-text">Data Karyawan</span>
                </a>
                <a href="#" class="nav-item" data-tab="reports" id="reportsNav">
                    <span class="icon icon-excel"></span>
                    <span class="nav-text">Laporan & Export</span>
                </a>
            </div>
        </nav>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Header -->
            <header class="top-header">
                <div class="header-content">
                    <div class="header-left">
                        <h1 id="pageTitle">Dashboard Absensi</h1>
                        <div id="currentDate" class="current-date">
                            <!-- Tanggal akan diisi oleh JavaScript -->
                        </div>
                    </div>
                    
                    <div class="user-info">
                        <div class="user-selector">
                            <select id="userDropdown" class="user-dropdown">
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        <span id="currentUserRole" class="user-role">Karyawan</span>
                    </div>
                </div>
            </header>
            
            <!-- Content Area -->
            <div class="content-area">
                <!-- Loading Spinner -->
                <div id="loadingSpinner" class="spinner"></div>
                
                <!-- Dashboard Tab -->
                <div id="dashboardTab" class="tab-content active">
                    <!-- Welcome Message -->
                    <div class="welcome-card">
                        <div class="welcome-content">
                            <h2 id="welcomeMessage">Welcome Ahmad Fauzi, jangan lupa isi absen kalau mau dapat gaji !</h2>
                            <p class="welcome-subtitle">Semangat bekerja hari ini !</p>
                        </div>
                        <div class="welcome-icon">
                            <span class="icon icon-dashboard"></span>
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="quick-stats">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon">
                                    <span class="icon icon-clock"></span>
                                </div>
                                <span class="stat-trend">+5.2%</span>
                            </div>
                            <div class="stat-value" id="totalHoursWeek">0</div>
                            <div class="stat-label">Total Jam/Minggu</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon">
                                    <span class="icon icon-calendar"></span>
                                </div>
                                <span class="stat-trend">+2</span>
                            </div>
                            <div class="stat-value" id="workDaysWeek">0</div>
                            <div class="stat-label">Hari Kerja</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon">
                                    <span class="icon icon-trend-up"></span>
                                </div>
                                <span class="stat-trend">¬±0</span>
                            </div>
                            <div class="stat-value" id="avgHoursDay">0</div>
                            <div class="stat-label">Rata-rata Jam/Hari</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon">
                                    <span class="icon icon-user"></span>
                                </div>
                                <span class="stat-trend">100%</span>
                            </div>
                            <div class="stat-value" id="attendanceRate">0%</div>
                            <div class="stat-label">Rate Kehadiran</div>
                        </div>
                    </div>
                    
                    <!-- Dashboard Grid -->
                    <div class="dashboard-grid">
                        <!-- Left Column -->
                        <div class="left-column">
                            <!-- Attendance Action -->
                            <div class="card attendance-action" id="attendanceActionCard">
                                <h2>Absensi Hari Ini</h2>
                                <div class="status-badge status-checked-in" id="checkinStatus">Anda sedang Check-in</div>
                                <div class="attendance-time" id="currentTime">--:--</div>
                                <div class="attendance-date" id="todayDate">Hari ini</div>
                                <div class="action-buttons">
                                    <button class="btn btn-success" id="checkInBtn">
                                        <span class="icon icon-checkin"></span>
                                        Check In
                                    </button>
                                    <button class="btn btn-outline" id="checkOutBtn">
                                        <span class="icon icon-checkout"></span>
                                        Check Out
                                    </button>
                                </div>
                                <div class="counter">
                                    <div class="counter-item">
                                        <div class="counter-value" id="checkinCounter">3</div>
                                        <div class="counter-label">Sisa Check-in</div>
                                    </div>
                                    <div class="counter-item">
                                        <div class="counter-value" id="checkoutCounter">3</div>
                                        <div class="counter-label">Sisa Check-out</div>
                                    </div>
                                </div>
                            </div>
                                                        
                            <!-- Today's Attendance -->
                            <div class="card mt-4">
                                <div class="card-header">
                                    <h3 class="card-title">Riwayat Hari Ini</h3>
                                </div>
                                <table id="todayAttendance">
                                    <thead>
                                        <tr>
                                            <th>Waktu</th>
                                            <th>Jenis</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data akan diisi oleh JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Right Column -->
                        <div class="right-column">
                            <!-- Recent Activity -->
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Aktivitas Terbaru</h3>
                                </div>
                                <div class="activity-list" id="recentActivity">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </div>
                            </div>
                            
                            <!-- Weekly Summary -->
                            <div class="card mt-4">
                                <div class="card-header">
                                    <h3 class="card-title">Ringkasan Mingguan</h3>
                                </div>
                                <div id="weeklySummary">
                                    <div class="activity-item">
                                        <div class="activity-icon">
                                            <span class="icon icon-clock"></span>
                                        </div>
                                        <div class="activity-content">
                                            <div class="activity-title">Total Jam Kerja</div>
                                            <div class="activity-time" id="weeklyTotalHours">0 jam</div>
                                        </div>
                                    </div>
                                    <div class="activity-item">
                                        <div class="activity-icon">
                                            <span class="icon icon-calendar"></span>
                                        </div>
                                        <div class="activity-content">
                                            <div class="activity-title">Hari Hadir</div>
                                            <div class="activity-time" id="weeklyWorkDays">0 hari</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- History Tab -->
                <div id="historyTab" class="tab-content hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Riwayat Absensi</h3>
                            <div class="card-actions">
                                <select id="historyEmployeeFilter" class="user-dropdown">
                                    <!-- Options akan diisi berdasarkan role -->
                                </select>
                            </div>
                        </div>
                        <div class="filter-section">
                            <div class="filter-group">
                                <label class="filter-label">Periode</label>
                                <select id="historyPeriod" class="user-dropdown">
                                    <option value="week">Minggu Ini</option>
                                    <option value="month">Bulan Ini</option>
                                    <option value="all">Semua</option>
                                </select>
                            </div>
                        </div>
                        <div id="historyLoading" class="spinner"></div>
                        <table id="attendanceHistory">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Nama</th>
                                    <th>Check In</th>
                                    <th>Check Out</th>
                                    <th>Total Jam</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Employees Tab -->
                <div id="employeesTab" class="tab-content hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Data Absensi Karyawan</h3>
                            <div class="card-actions">
                                <select id="employeesPeriod" class="user-dropdown">
                                    <option value="week">Minggu Ini</option>
                                    <option value="month">Bulan Ini</option>
                                </select>
                            </div>
                        </div>
                        <div id="employeesLoading" class="spinner"></div>
                        <table id="employeesTable">
                            <thead>
                                <tr>
                                    <th>Nama</th>
                                    <th>Jabatan</th>
                                    <th>Total Jam</th>
                                    <th>Hari Kerja</th>
                                    <th>Rata-rata Jam/Hari</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Reports Tab -->
                <div id="reportsTab" class="tab-content hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Laporan & Export Data</h3>
                        </div>
                        
                        <!-- Export Section -->
                        <div class="export-section">
                            <div class="filter-group">
                                <label class="filter-label">Periode Laporan</label>
                                <select id="reportPeriod" class="user-dropdown">
                                    <option value="week">Minggu Ini</option>
                                    <option value="lastWeek">Minggu Lalu</option>
                                    <option value="month">Bulan Ini</option>
                                    <option value="lastMonth">Bulan Lalu</option>
                                </select>
                            </div>
                            
                            <button class="export-btn" id="exportExcelBtn">
                                <span class="icon icon-excel"></span>
                                Export ke Excel
                            </button>
                        </div>
                        
                        <!-- Warning Section untuk karyawan dengan jam kerja kurang dari 21 jam -->
                        <div id="warningSection" class="warning-card">
                            <div class="warning-header">
                                <span class="icon icon-warning"></span>
                                <h3 class="warning-title">Peringatan: Karyawan dengan Jam Kerja Kurang dari 21 Jam/Minggu</h3>
                            </div>
                            <ul id="warningList" class="warning-list">
                                <!-- Daftar karyawan akan diisi oleh JavaScript -->
                            </ul>
                        </div>
                        
                        <!-- Report Summary -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <h3 class="card-title">Ringkasan Laporan</h3>
                            </div>
                            <table id="reportSummary">
                                <thead>
                                    <tr>
                                        <th>Nama</th>
                                        <th>Jabatan</th>
                                        <th>Total Jam/Minggu</th>
                                        <th>Hari Kerja</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data akan diisi oleh JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD8YQ7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q",
            authDomain: "absen2-3de1a.firebaseapp.com",
            projectId: "absen2-3de1a",
            storageBucket: "absen2-3de1a.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Inisialisasi Firebase
        let db;
        let firestoreListener = null;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error('Error initializing Firebase:', error);
            showNotification('Error initializing Firebase: ' + error.message, 'error');
        }

        // Data karyawan
        const employees = [
            { id: 1, name: "Admin User", role: "admin", position: "Administrator", password: "admin123" },
            { id: 2, name: "Enzy", role: "boss", position: "boss", password: "boss123" },
            { id: 3, name: "Don Oska", role: "boss", position: "boss", password: "boss123" },
            { id: 4, name: "Ace", role: "boss", position: "boss", password: "boss123" },
            { id: 5, name: "Marco", role: "boss", position: "boss", password: "boss123" },
            { id: 6, name: "Cartenz", role: "boss", position: "boss", password: "boss123" },
            { id: 7, name: "Giw", role: "boss", position: "boss", password: "boss123" },
            { id: 8, name: "Vyan", role: "boss", position: "boss", password: "boss123" },
            { id: 9, name: "Ryota", role: "boss", position: "boss", password: "boss123" },
            { id: 10, name: "Enzy", role: "boss", position: "boss", password: "boss123" },
            { id: 11, name: "Beckham Durrel", role: "employee", position: "Manager" },
            { id: 12, name: "Goby Chana", role: "employee", position: "Manager" },
            { id: 13, name: "Cihyi Mori", role: "employee", position: "Manager" },
            { id: 14, name: "Kyra", role: "employee", position: "Manager" },
            { id: 15, name: "Molly", role: "employee", position: "Mechanic" }
        ];

        // State aplikasi
        let currentUser = employees[2];
        let allAttendanceData = [];
        let todayCheckins = 0;
        let todayCheckouts = 0;
        let maxCheckinsPerDay = 3;
        let maxCheckoutsPerDay = 3;
        let pendingUserChange = null;

        // DOM Elements
        const currentDateElement = document.getElementById('currentDate');
        const currentTimeElement = document.getElementById('currentTime');
        const todayDateElement = document.getElementById('todayDate');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const userDropdown = document.getElementById('userDropdown');
        const currentUserRole = document.getElementById('currentUserRole');
        const pageTitle = document.getElementById('pageTitle');
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Stats Elements
        const totalHoursWeek = document.getElementById('totalHoursWeek');
        const workDaysWeek = document.getElementById('workDaysWeek');
        const avgHoursDay = document.getElementById('avgHoursDay');
        const attendanceRate = document.getElementById('attendanceRate');
        const weeklyTotalHours = document.getElementById('weeklyTotalHours');
        const weeklyWorkDays = document.getElementById('weeklyWorkDays');
        
        // Action Elements
        const checkInBtn = document.getElementById('checkInBtn');
        const checkOutBtn = document.getElementById('checkOutBtn');
        const attendanceActionCard = document.getElementById('attendanceActionCard');
        const todayAttendance = document.getElementById('todayAttendance').querySelector('tbody');
        const recentActivity = document.getElementById('recentActivity');
        const checkinStatus = document.getElementById('checkinStatus');
        const checkinCounter = document.getElementById('checkinCounter');
        const checkoutCounter = document.getElementById('checkoutCounter');
        
        // History Tab Elements
        const historyEmployeeFilter = document.getElementById('historyEmployeeFilter');
        const historyPeriod = document.getElementById('historyPeriod');
        const historyLoading = document.getElementById('historyLoading');
        const attendanceHistory = document.getElementById('attendanceHistory').querySelector('tbody');
        
        // Employees Tab Elements
        const employeesPeriod = document.getElementById('employeesPeriod');
        const employeesLoading = document.getElementById('employeesLoading');
        const employeesTable = document.getElementById('employeesTable').querySelector('tbody');
        
        // Reports Tab Elements
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const reportPeriod = document.getElementById('reportPeriod');
        const warningSection = document.getElementById('warningSection');
        const warningList = document.getElementById('warningList');
        const reportSummary = document.getElementById('reportSummary').querySelector('tbody');
        
        // Notification
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');

        // DOM Elements untuk modal
        const userReminderModal = document.getElementById('userReminderModal');
        const currentUserInModal = document.getElementById('currentUserInModal');
        const currentUserInModal2 = document.getElementById('currentUserInModal2');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const changeUserBtn = document.getElementById('changeUserBtn');

        // DOM Elements untuk password modal
        const passwordModal = document.getElementById('passwordModal');
        const selectedRole = document.getElementById('selectedRole');
        const passwordInput = document.getElementById('passwordInput');
        const passwordError = document.getElementById('passwordError');
        const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
        const submitPasswordBtn = document.getElementById('submitPasswordBtn');

        // Fungsi untuk update waktu dan tanggal
        function updateDateTime() {
            const now = new Date();
            
            // Update time
            const time = now.toTimeString().split(' ')[0].substring(0, 5);
            currentTimeElement.textContent = time;
            
            // Update date
            const dateOptions = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const formattedDate = now.toLocaleDateString('id-ID', dateOptions);
            currentDateElement.textContent = formattedDate;
            
            // Update today date
            const todayOptions = { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long' 
            };
            const todayFormatted = now.toLocaleDateString('id-ID', todayOptions);
            todayDateElement.textContent = todayFormatted;
        }

        // Inisialisasi dropdown pengguna
        function initializeUserDropdown() {
            userDropdown.innerHTML = '';
            
            employees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = `${employee.name} (${employee.position})`;
                userDropdown.appendChild(option);
            });
            
            userDropdown.value = currentUser.id;
            updateUserRoleDisplay();
        }

        // Update role display dan kontrol akses
        function updateUserRoleDisplay() {
            if (currentUser.role === 'admin') {
                currentUserRole.textContent = 'Administrator';
            } else if (currentUser.role === 'boss') {
                currentUserRole.textContent = 'Boss';
            } else {
                currentUserRole.textContent = 'Karyawan';
            }
            
            // Kontrol akses berdasarkan role
            const employeesNav = document.getElementById('employeesNav');
            const reportsNav = document.getElementById('reportsNav');
            const canViewAllData = currentUser.role === 'admin' || currentUser.role === 'boss';
            
            if (canViewAllData) {
                employeesNav.style.display = 'flex';
                reportsNav.style.display = 'flex';
                attendanceActionCard.style.display = 'none'; // Sembunyikan absensi untuk admin/boss
            } else {
                employeesNav.style.display = 'none';
                reportsNav.style.display = 'none';
                attendanceActionCard.style.display = 'block';
            }
            
            // Update filter dropdown di history tab
            updateHistoryEmployeeFilter();
        }

        // Update filter karyawan di history tab
        function updateHistoryEmployeeFilter() {
            historyEmployeeFilter.innerHTML = '';
            
            if (currentUser.role === 'employee') {
                // Karyawan hanya bisa melihat data sendiri
                const option = document.createElement('option');
                option.value = currentUser.id;
                option.textContent = `${currentUser.name} (Data Saya)`;
                historyEmployeeFilter.appendChild(option);
                historyEmployeeFilter.disabled = true;
            } else {
                // Admin/Boss bisa melihat semua karyawan
                historyEmployeeFilter.disabled = false;
                
                // Tambahkan opsi untuk semua karyawan
                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = 'Semua Karyawan';
                historyEmployeeFilter.appendChild(allOption);
                
                employees.forEach(employee => {
                    if (employee.role === 'employee') {
                        const option = document.createElement('option');
                        option.value = employee.id;
                        option.textContent = `${employee.name} (${employee.position})`;
                        historyEmployeeFilter.appendChild(option);
                    }
                });
            }
        }

        // Navigation handler
        function setupNavigation() {
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = item.getAttribute('data-tab');
                    
                    // Update active nav item
                    navItems.forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Update active tab
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        content.classList.add('hidden');
                    });
                    
                    const activeTab = document.getElementById(tabId + 'Tab');
                    activeTab.classList.remove('hidden');
                    activeTab.classList.add('active');
                    
                    // Update page title
                    pageTitle.textContent = item.querySelector('.nav-text').textContent + ' - ICR Attendance';
                    
                    // Load data untuk tab yang dipilih
                    if (tabId === 'history') {
                        updateHistoryTab();
                    } else if (tabId === 'employees') {
                        updateEmployeesTab();
                    } else if (tabId === 'reports') {
                        updateReportsTab();
                    }
                });
            });
        }

        // Notification system
        function showNotification(message, type = 'success') {
            console.log(`Notification: ${message} (${type})`);
            notificationText.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Fungsi untuk menampilkan modal pengingat
        function showUserReminderModal() {
            // Tampilkan modal setiap kali halaman di-refresh
            // Update teks modal dengan nama user saat ini
            currentUserInModal.textContent = currentUser.name;
            currentUserInModal2.textContent = currentUser.name;
            
            // Tampilkan modal setelah delay singkat
            setTimeout(() => {
                userReminderModal.classList.add('show');
            }, 1000);
        }

        // Event listeners untuk modal
        closeModalBtn.addEventListener('click', () => {
            userReminderModal.classList.remove('show');
        });

        changeUserBtn.addEventListener('click', () => {
            userReminderModal.classList.remove('show');
            // Fokus ke dropdown user
            userDropdown.focus();
        });

        // Fungsi untuk menampilkan modal password
        function showPasswordModal(user) {
            pendingUserChange = user;
            selectedRole.textContent = user.role === 'admin' ? 'Administrator' : 'Boss';
            passwordInput.value = '';
            passwordError.classList.remove('show');
            passwordInput.classList.remove('error');
            passwordModal.classList.add('show');
            passwordInput.focus();
        }

        // Event listeners untuk password modal
        cancelPasswordBtn.addEventListener('click', () => {
            passwordModal.classList.remove('show');
            // Reset dropdown ke user sebelumnya
            userDropdown.value = currentUser.id;
            pendingUserChange = null;
        });

        submitPasswordBtn.addEventListener('click', () => {
            const enteredPassword = passwordInput.value.trim();
            
            if (!enteredPassword) {
                passwordInput.classList.add('error');
                passwordError.textContent = 'Password harus diisi';
                passwordError.classList.add('show');
                return;
            }
            
            if (pendingUserChange && enteredPassword === pendingUserChange.password) {
                // Password benar, lanjutkan perubahan user
                currentUser = pendingUserChange;
                passwordModal.classList.remove('show');
                updateUserRoleDisplay();
                updateUI();
                showNotification(`Berhasil login sebagai ${currentUser.name}`, 'success');
                pendingUserChange = null;
            } else {
                // Password salah
                passwordInput.classList.add('error');
                passwordError.textContent = 'Password salah. Silakan coba lagi.';
                passwordError.classList.add('show');
                passwordInput.value = '';
                passwordInput.focus();
            }
        });

        // Event listener untuk input password (Enter key)
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitPasswordBtn.click();
            }
        });

        // Update dashboard stats
        function updateDashboardStats() {
            const today = new Date().toISOString().split('T')[0];
            const { startDate, endDate } = getWeekDates();
            
            // Filter data untuk minggu ini berdasarkan user yang dipilih
            const weekRecords = allAttendanceData.filter(record => {
                const recordDate = new Date(record.date);
                return record.employeeId === currentUser.id && 
                       recordDate >= startDate && 
                       recordDate <= endDate;
            });
            
            // Hitung statistik
            let totalHours = 0;
            let workDays = 0;
            const dailyRecords = {};
            
            weekRecords.forEach(record => {
                if (!dailyRecords[record.date]) {
                    dailyRecords[record.date] = { checkIn: null, checkOut: null };
                }
                
                if (record.checkIn) dailyRecords[record.date].checkIn = record.checkIn;
                if (record.checkOut) dailyRecords[record.date].checkOut = record.checkOut;
            });
            
            Object.keys(dailyRecords).forEach(date => {
                const record = dailyRecords[date];
                if (record.checkIn && record.checkOut) {
                    const hours = calculateWorkHours(record.checkIn, record.checkOut);
                    totalHours += hours;
                    workDays++;
                }
            });
            
            // Update stats
            totalHoursWeek.textContent = totalHours.toFixed(1);
            workDaysWeek.textContent = workDays;
            avgHoursDay.textContent = workDays > 0 ? (totalHours / workDays).toFixed(1) : '0';
            attendanceRate.textContent = workDays > 0 ? '100%' : '0%';
            weeklyTotalHours.textContent = formatHoursToDetailed(totalHours);
            weeklyWorkDays.textContent = workDays + ' hari';
        }

        // Update today's attendance
        function updateTodayAttendance() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = allAttendanceData.filter(record => 
                record.employeeId === currentUser.id && 
                record.date === today
            );
            
            todayAttendance.innerHTML = '';
            
            if (todayRecords.length === 0) {
                todayAttendance.innerHTML = '<tr><td colspan="3" style="text-align: center;">Belum ada absensi hari ini</td></tr>';
            } else {
                todayRecords.forEach(record => {
                    const row = document.createElement('tr');
                    const time = record.checkIn || record.checkOut;
                    const type = record.checkIn ? 'Check In' : 'Check Out';
                    const status = record.checkIn ? 'Masuk' : 'Pulang';
                    
                    row.innerHTML = `
                        <td>${time}</td>
                        <td>${type}</td>
                        <td class="status-present">${status}</td>
                    `;
                    todayAttendance.appendChild(row);
                });
            }
            
            // Update status check-in dan counter
            updateCheckinStatus(todayRecords);
        }

        // Update status check-in dan counter
        function updateCheckinStatus(todayRecords) {
            const checkinsToday = todayRecords.filter(record => record.checkIn).length;
            const checkoutsToday = todayRecords.filter(record => record.checkOut).length;
            const hasActiveCheckin = todayRecords.some(record => record.checkIn && !record.checkOut);
            
            todayCheckins = checkinsToday;
            todayCheckouts = checkoutsToday;
            const remainingCheckins = maxCheckinsPerDay - checkinsToday;
            const remainingCheckouts = maxCheckoutsPerDay - checkoutsToday;
            
            console.log(`Check-ins today: ${checkinsToday}, Check-outs today: ${checkoutsToday}, Active: ${hasActiveCheckin}`);
            
            // Update counter
            checkinCounter.textContent = remainingCheckins;
            checkoutCounter.textContent = remainingCheckouts;
            
            // Update warna counter jika hampir habis
            if (remainingCheckins <= 1) {
                checkinCounter.classList.add('counter-warning');
            } else {
                checkinCounter.classList.remove('counter-warning');
            }
            
            if (remainingCheckouts <= 1) {
                checkoutCounter.classList.add('counter-warning');
            } else {
                checkoutCounter.classList.remove('counter-warning');
            }
            
            // Update status dan tampilan
            if (hasActiveCheckin) {
                checkinStatus.textContent = "Anda sedang Check-in";
                checkinStatus.className = "status-badge status-checked-in";
                attendanceActionCard.classList.add('checked-in');
                checkInBtn.disabled = true;
                checkOutBtn.disabled = remainingCheckouts <= 0;
            } else {
                checkinStatus.textContent = "Belum Check-in";
                checkinStatus.className = "status-badge status-not-checked-in";
                attendanceActionCard.classList.remove('checked-in');
                checkInBtn.disabled = remainingCheckins <= 0;
                checkOutBtn.disabled = true;
            }
        }

        // Update recent activity
        function updateRecentActivity() {
            const userRecords = allAttendanceData
                .filter(record => record.employeeId === currentUser.id)
                .sort((a, b) => new Date(b.date + ' ' + (b.checkIn || b.checkOut)) - new Date(a.date + ' ' + (a.checkIn || a.checkOut)))
                .slice(0, 5);
            
            recentActivity.innerHTML = '';
            
            userRecords.forEach(record => {
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                
                const isCheckIn = record.checkIn;
                const time = isCheckIn ? record.checkIn : record.checkOut;
                const title = isCheckIn ? 'Check In' : 'Check Out';
                const date = new Date(record.date).toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'short'
                });
                
                activityItem.innerHTML = `
                    <div class="activity-icon">
                        <span class="icon ${isCheckIn ? 'icon-checkin' : 'icon-checkout'}"></span>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${title}</div>
                        <div class="activity-time">${date} - ${time}</div>
                    </div>
                `;
                
                recentActivity.appendChild(activityItem);
            });
        }

        // Update history tab
        function updateHistoryTab() {
            const selectedEmployeeId = historyEmployeeFilter.value;
            const period = historyPeriod.value;
            
            historyLoading.style.display = 'block';
            attendanceHistory.innerHTML = '';
            
            // Filter data berdasarkan employee dan periode
            let filteredData = allAttendanceData;
            
            // Filter berdasarkan karyawan yang dipilih
            if (selectedEmployeeId !== 'all') {
                const employeeId = parseInt(selectedEmployeeId);
                filteredData = filteredData.filter(record => {
                    return record.employeeId === employeeId;
                });
            }
            
            // Filter berdasarkan periode
            if (period === 'week') {
                const { startDate, endDate } = getWeekDates();
                filteredData = filteredData.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate >= startDate && recordDate <= endDate;
                });
            } else if (period === 'month') {
                const { startDate, endDate } = getMonthDates();
                filteredData = filteredData.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate >= startDate && recordDate <= endDate;
                });
            }
            
            // Group by date untuk menghitung total jam per hari
            const dailyRecords = {};
            filteredData.forEach(record => {
                if (!dailyRecords[record.date]) {
                    dailyRecords[record.date] = {
                        employeeName: record.employeeName,
                        checkIn: null,
                        checkOut: null,
                        records: []
                    };
                }
                
                dailyRecords[record.date].records.push(record);
                
                if (record.checkIn) dailyRecords[record.date].checkIn = record.checkIn;
                if (record.checkOut) dailyRecords[record.date].checkOut = record.checkOut;
            });
            
            // Tampilkan data
            Object.keys(dailyRecords).sort().reverse().forEach(date => {
                const record = dailyRecords[date];
                const formattedDate = new Date(date).toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                let totalHours = '-';
                let status = '<span class="status-absent">Tidak Lengkap</span>';
                
                if (record.checkIn && record.checkOut) {
                    const hours = calculateWorkHours(record.checkIn, record.checkOut);
                    totalHours = formatHoursToDetailed(hours);
                    status = '<span class="status-present">Lengkap</span>';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${record.employeeName}</td>
                    <td>${record.checkIn || '-'}</td>
                    <td>${record.checkOut || '-'}</td>
                    <td>${totalHours}</td>
                    <td>${status}</td>
                `;
                
                attendanceHistory.appendChild(row);
            });
            
            historyLoading.style.display = 'none';
        }

        // Update employees tab
        function updateEmployeesTab() {
            const period = employeesPeriod.value;
            
            employeesLoading.style.display = 'block';
            employeesTable.innerHTML = '';
            
            // Filter data berdasarkan periode
            let filteredData = allAttendanceData;
            if (period === 'week') {
                const { startDate, endDate } = getWeekDates();
                filteredData = filteredData.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate >= startDate && recordDate <= endDate;
                });
            } else if (period === 'month') {
                const { startDate, endDate } = getMonthDates();
                filteredData = filteredData.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate >= startDate && recordDate <= endDate;
                });
            }
            
            // Hitung statistik per employee
            employees.forEach(employee => {
                if (employee.role === 'employee') {
                    const empRecords = filteredData.filter(record => record.employeeId === employee.id);
                    
                    const dailyRecords = {};
                    empRecords.forEach(record => {
                        if (!dailyRecords[record.date]) {
                            dailyRecords[record.date] = { checkIn: null, checkOut: null };
                        }
                        
                        if (record.checkIn) dailyRecords[record.date].checkIn = record.checkIn;
                        if (record.checkOut) dailyRecords[record.date].checkOut = record.checkOut;
                    });
                    
                    let totalWorkHours = 0;
                    let workDaysCount = 0;
                    
                    Object.keys(dailyRecords).forEach(date => {
                        const record = dailyRecords[date];
                        if (record.checkIn && record.checkOut) {
                            const hours = calculateWorkHours(record.checkIn, record.checkOut);
                            totalWorkHours += hours;
                            workDaysCount++;
                        }
                    });
                    
                    const avgHours = workDaysCount > 0 ? (totalWorkHours / workDaysCount) : 0;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${employee.name}</td>
                        <td>${employee.position}</td>
                        <td>${formatHoursToDetailed(totalWorkHours)}</td>
                        <td>${workDaysCount} hari</td>
                        <td>${formatHoursToDetailed(avgHours)}</td>
                        <td>
                            <button class="btn btn-primary view-employee-detail" data-employee-id="${employee.id}">
                                <span class="icon icon-eye"></span>
                                Detail
                            </button>
                        </td>
                    `;
                    
                    employeesTable.appendChild(row);
                }
            });
            
            // Add event listeners untuk tombol detail
            document.querySelectorAll('.view-employee-detail').forEach(button => {
                button.addEventListener('click', () => {
                    const employeeId = parseInt(button.getAttribute('data-employee-id'));
                    // Switch ke history tab dengan filter employee tersebut
                    historyEmployeeFilter.value = employeeId;
                    navItems.forEach(nav => nav.classList.remove('active'));
                    document.querySelector('[data-tab="history"]').classList.add('active');
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        content.classList.add('hidden');
                    });
                    document.getElementById('historyTab').classList.remove('hidden');
                    document.getElementById('historyTab').classList.add('active');
                    pageTitle.textContent = 'Riwayat Absensi - WorkSync';
                    updateHistoryTab();
                });
            });
            
            employeesLoading.style.display = 'none';
        }

        // Update reports tab
        function updateReportsTab() {
            const period = reportPeriod.value;
            let startDate, endDate;
            
            // Tentukan periode berdasarkan pilihan
            if (period === 'week') {
                ({ startDate, endDate } = getWeekDates());
            } else if (period === 'lastWeek') {
                ({ startDate, endDate } = getWeekDates(-1));
            } else if (period === 'month') {
                ({ startDate, endDate } = getMonthDates());
            } else if (period === 'lastMonth') {
                ({ startDate, endDate } = getMonthDates(-1));
            }
            
            // Filter data berdasarkan periode
            const filteredData = allAttendanceData.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate >= startDate && recordDate <= endDate;
            });
            
            // Hitung statistik per employee
            const employeeStats = [];
            const employeesWithLowHours = [];
            
            employees.forEach(employee => {
                if (employee.role === 'employee') {
                    const empRecords = filteredData.filter(record => record.employeeId === employee.id);
                    
                    const dailyRecords = {};
                    empRecords.forEach(record => {
                        if (!dailyRecords[record.date]) {
                            dailyRecords[record.date] = { checkIn: null, checkOut: null };
                        }
                        
                        if (record.checkIn) dailyRecords[record.date].checkIn = record.checkIn;
                        if (record.checkOut) dailyRecords[record.date].checkOut = record.checkOut;
                    });
                    
                    let totalWorkHours = 0;
                    let workDaysCount = 0;
                    
                    Object.keys(dailyRecords).forEach(date => {
                        const record = dailyRecords[date];
                        if (record.checkIn && record.checkOut) {
                            const hours = calculateWorkHours(record.checkIn, record.checkOut);
                            totalWorkHours += hours;
                            workDaysCount++;
                        }
                    });
                    
                    const status = totalWorkHours >= 21 ? 'Memenuhi' : 'Tidak Memenuhi';
                    
                    employeeStats.push({
                        name: employee.name,
                        position: employee.position,
                        totalHours: totalWorkHours,
                        workDays: workDaysCount,
                        status: status
                    });
                    
                    // Catat karyawan dengan jam kerja kurang dari 21 jam
                    if (totalWorkHours < 21) {
                        employeesWithLowHours.push({
                            name: employee.name,
                            position: employee.position,
                            totalHours: totalWorkHours
                        });
                    }
                }
            });
            
            // Update tabel ringkasan
            reportSummary.innerHTML = '';
            employeeStats.forEach(stat => {
                const row = document.createElement('tr');
                const statusClass = stat.status === 'Memenuhi' ? 'status-present' : 'status-absent';
                
                row.innerHTML = `
                    <td>${stat.name}</td>
                    <td>${stat.position}</td>
                    <td>${stat.totalHours.toFixed(1)} jam</td>
                    <td>${stat.workDays} hari</td>
                    <td class="${statusClass}">${stat.status}</td>
                `;
                
                reportSummary.appendChild(row);
            });
            
            // Update peringatan untuk karyawan dengan jam kerja kurang dari 21 jam
            warningList.innerHTML = '';
            
            if (employeesWithLowHours.length > 0) {
                warningSection.style.display = 'block';
                
                employeesWithLowHours.forEach(employee => {
                    const listItem = document.createElement('li');
                    listItem.className = 'warning-item';
                    listItem.innerHTML = `
                        <span class="employee-name">${employee.name}</span> (${employee.position}) - 
                        <span class="hours-count">${employee.totalHours.toFixed(1)} jam</span>
                    `;
                    warningList.appendChild(listItem);
                });
            } else {
                warningSection.style.display = 'none';
            }
        }

        // Export data ke Excel
        function exportToExcel() {
            const period = reportPeriod.value;
            let startDate, endDate;
            let periodLabel = '';
            
            // Tentukan periode berdasarkan pilihan
            if (period === 'week') {
                ({ startDate, endDate } = getWeekDates());
                periodLabel = 'Minggu Ini';
            } else if (period === 'lastWeek') {
                ({ startDate, endDate } = getWeekDates(-1));
                periodLabel = 'Minggu Lalu';
            } else if (period === 'month') {
                ({ startDate, endDate } = getMonthDates());
                periodLabel = 'Bulan Ini';
            } else if (period === 'lastMonth') {
                ({ startDate, endDate } = getMonthDates(-1));
                periodLabel = 'Bulan Lalu';
            }
            
            // Filter data berdasarkan periode
            const filteredData = allAttendanceData.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate >= startDate && recordDate <= endDate;
            });
            
            // Siapkan data untuk export
            const exportData = [];
            
            // Header
            exportData.push([
                'LAPORAN ABSENSI KARYAWAN',
                '',
                '',
                '',
                '',
                ''
            ]);
            
            exportData.push([
                `Periode: ${periodLabel}`,
                '',
                '',
                '',
                '',
                ''
            ]);
            
            exportData.push([
                `Tanggal Export: ${new Date().toLocaleDateString('id-ID')}`,
                '',
                '',
                '',
                '',
                ''
            ]);
            
            exportData.push([]); // Baris kosong
            
            // Header tabel
            exportData.push([
                'Nama Karyawan',
                'Jabatan',
                'Tanggal',
                'Check In',
                'Check Out',
                'Total Jam'
            ]);
            
            // Data absensi
            filteredData.forEach(record => {
                const employee = employees.find(emp => emp.id === record.employeeId);
                let totalHours = '-';
                
                if (record.checkIn && record.checkOut) {
                    totalHours = calculateWorkHours(record.checkIn, record.checkOut).toFixed(2);
                }
                
                exportData.push([
                    employee ? employee.name : 'Unknown',
                    employee ? employee.position : 'Unknown',
                    new Date(record.date).toLocaleDateString('id-ID'),
                    record.checkIn || '-',
                    record.checkOut || '-',
                    totalHours
                ]);
            });
            
            exportData.push([]); // Baris kosong
            
            // Ringkasan per karyawan
            exportData.push([
                'RINGKASAN PER KARYAWAN',
                '',
                '',
                '',
                '',
                ''
            ]);
            
            exportData.push([
                'Nama Karyawan',
                'Jabatan',
                'Total Jam Kerja',
                'Hari Kerja',
                'Rata-rata Jam/Hari',
                'Status'
            ]);
            
            // Hitung statistik per employee
            employees.forEach(employee => {
                if (employee.role === 'employee') {
                    const empRecords = filteredData.filter(record => record.employeeId === employee.id);
                    
                    const dailyRecords = {};
                    empRecords.forEach(record => {
                        if (!dailyRecords[record.date]) {
                            dailyRecords[record.date] = { checkIn: null, checkOut: null };
                        }
                        
                        if (record.checkIn) dailyRecords[record.date].checkIn = record.checkIn;
                        if (record.checkOut) dailyRecords[record.date].checkOut = record.checkOut;
                    });
                    
                    let totalWorkHours = 0;
                    let workDaysCount = 0;
                    
                    Object.keys(dailyRecords).forEach(date => {
                        const record = dailyRecords[date];
                        if (record.checkIn && record.checkOut) {
                            const hours = calculateWorkHours(record.checkIn, record.checkOut);
                            totalWorkHours += hours;
                            workDaysCount++;
                        }
                    });
                    
                    const avgHours = workDaysCount > 0 ? (totalWorkHours / workDaysCount) : 0;
                    const status = totalWorkHours >= 21 ? 'Memenuhi' : 'TIDAK MEMENUHI';
                    
                    exportData.push([
                        employee.name,
                        employee.position,
                        totalWorkHours.toFixed(2),
                        workDaysCount,
                        avgHours.toFixed(2),
                        status
                    ]);
                }
            });
            
            // Buat worksheet
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            
            // Buat workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Laporan Absensi');
            
            // Export ke file Excel
            const fileName = `Laporan_Absensi_${periodLabel.replace(' ', '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showNotification(`Laporan berhasil diexport sebagai ${fileName}`, 'success');
        }

        // Update welcome message
        function updateWelcomeMessage() {
            const welcomeMessage = document.getElementById('welcomeMessage');
            if (welcomeMessage) {
                welcomeMessage.textContent = `Welcome ${currentUser.name}, jangan lupa isi absen kalau mau dapat gaji!`;
            }
            
            // Update juga teks di modal jika modal sedang terbuka
            if (currentUserInModal) {
                currentUserInModal.textContent = currentUser.name;
                currentUserInModal2.textContent = currentUser.name;
            }
        }

        // Update UI
        function updateUI() {
            updateDashboardStats();
            updateTodayAttendance();
            updateRecentActivity();
            updateWelcomeMessage();
        }

        // Attendance actions
        async function submitAttendance(type) {
            if (currentUser.role !== 'employee') {
                showNotification('Hanya karyawan yang dapat melakukan absensi', 'error');
                return;
            }
            
            const now = new Date();
            const time = now.toTimeString().split(' ')[0].substring(0, 5);
            const todayDate = now.toISOString().split('T')[0];
            
            try {
                const todayRecords = allAttendanceData.filter(record => 
                    record.employeeId === currentUser.id && 
                    record.date === todayDate
                );
                
                const todayCheckInCount = todayRecords.filter(record => record.checkIn).length;
                const todayCheckOutCount = todayRecords.filter(record => record.checkOut).length;
                const hasActiveCheckin = todayRecords.some(record => record.checkIn && !record.checkOut);
                
                console.log(`Submitting ${type}: Check-ins today: ${todayCheckInCount}, Check-outs today: ${todayCheckOutCount}, Has active: ${hasActiveCheckin}`);
                
                if (type === 'checkin') {
                    if (todayCheckInCount >= maxCheckinsPerDay) {
                        showNotification(`Anda sudah mencapai batas maksimal ${maxCheckinsPerDay} check-in per hari!`, 'error');
                        return;
                    }
                    
                    if (hasActiveCheckin) {
                        showNotification('Anda sudah melakukan check in! Silakan check out terlebih dahulu.', 'error');
                        return;
                    }
                    
                    await db.collection('attendance').add({
                        employeeId: currentUser.id,
                        employeeName: currentUser.name,
                        date: todayDate,
                        checkIn: time,
                        checkOut: null,
                        notes: '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        timestamp: new Date().toISOString()
                    });
                    
                    showNotification('Check in berhasil!');
                    
                } else if (type === 'checkout') {
                    if (!hasActiveCheckin) {
                        showNotification('Anda belum melakukan check in hari ini!', 'error');
                        return;
                    }
                    
                    if (todayCheckOutCount >= maxCheckoutsPerDay) {
                        showNotification(`Anda sudah mencapai batas maksimal ${maxCheckoutsPerDay} check-out per hari!`, 'error');
                        return;
                    }
                    
                    const checkInRecord = todayRecords.find(record => record.checkIn && !record.checkOut);
                    
                    if (checkInRecord) {
                        await db.collection('attendance').doc(checkInRecord.id).update({
                            checkOut: time,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        showNotification('Check out berhasil!');
                    }
                }
                
            } catch (error) {
                console.error('Error submitting attendance:', error);
                showNotification('Terjadi kesalahan saat menyimpan data: ' + error.message, 'error');
            }
        }

        // Utility functions
        function getWeekDates(weekOffset = 0) {
            const today = new Date();
            const currentDay = today.getDay();
            const mondayOffset = currentDay === 0 ? -6 : 1 - currentDay;
            
            const startDate = new Date(today);
            startDate.setDate(today.getDate() + mondayOffset + (weekOffset * 7));
            startDate.setHours(0, 0, 0, 0);
            
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            endDate.setHours(23, 59, 59, 999);
            
            return { startDate, endDate };
        }

        function getMonthDates(monthOffset = 0) {
            const today = new Date();
            const startDate = new Date(today.getFullYear(), today.getMonth() + monthOffset, 1);
            const endDate = new Date(today.getFullYear(), today.getMonth() + 1 + monthOffset, 0);
            endDate.setHours(23, 59, 59, 999);
            
            return { startDate, endDate };
        }

        function calculateWorkHours(checkIn, checkOut) {
            if (!checkIn || !checkOut) return 0;
            
            const [inHours, inMinutes] = checkIn.split(':').map(Number);
            const [outHours, outMinutes] = checkOut.split(':').map(Number);
            
            const checkInTime = new Date();
            checkInTime.setHours(inHours, inMinutes, 0, 0);
            
            const checkOutTime = new Date();
            checkOutTime.setHours(outHours, outMinutes, 0, 0);
            
            if (checkOutTime < checkInTime) {
                checkOutTime.setDate(checkOutTime.getDate() + 1);
            }
            
            const diffMs = checkOutTime - checkInTime;
            return diffMs / (1000 * 60 * 60); // Convert to hours
        }

        // Format jam kerja menjadi format jam:menit
        function formatHoursToDetailed(hours) {
            const totalMinutes = Math.round(hours * 60);
            const workHours = Math.floor(totalMinutes / 60);
            const workMinutes = totalMinutes % 60;
            
            if (workHours === 0) {
                return `${workMinutes} menit`;
            } else if (workMinutes === 0) {
                return `${workHours} jam`;
            } else {
                return `${workHours} jam ${workMinutes} menit`;
            }
        }

        // Load data dari Firestore
        async function loadAttendanceData() {
            try {
                loadingSpinner.style.display = 'block';
                console.log("Loading attendance data from Firestore...");
                
                const snapshot = await db.collection('attendance').get();
                allAttendanceData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                console.log(`Loaded ${allAttendanceData.length} attendance records`);
                updateUI();
                loadingSpinner.style.display = 'none';
                
            } catch (error) {
                console.error('Error loading attendance data:', error);
                showNotification('Error loading data: ' + error.message, 'error');
                loadingSpinner.style.display = 'none';
            }
        }

        // Setup real-time listener untuk Firestore
        function setupFirestoreListener() {
            if (firestoreListener) {
                firestoreListener(); // Unsubscribe dari listener sebelumnya
            }
            
            firestoreListener = db.collection('attendance')
                .onSnapshot((snapshot) => {
                    console.log("Real-time update received from Firestore");
                    allAttendanceData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    updateUI();
                    
                    // Update tab yang aktif
                    const activeTab = document.querySelector('.tab-content.active');
                    if (activeTab.id === 'historyTab') {
                        updateHistoryTab();
                    } else if (activeTab.id === 'employeesTab') {
                        updateEmployeesTab();
                    } else if (activeTab.id === 'reportsTab') {
                        updateReportsTab();
                    }
                }, (error) => {
                    console.error('Error in Firestore listener:', error);
                    showNotification('Error in real-time updates: ' + error.message, 'error');
                });
        }

        // Event Listeners untuk dropdown user
        userDropdown.addEventListener('change', (e) => {
            const userId = parseInt(e.target.value);
            const selectedUser = employees.find(emp => emp.id === userId);
            
            // Jika user tidak berubah, tidak perlu melakukan apa-apa
            if (selectedUser.id === currentUser.id) {
                return;
            }
            
            // Jika memilih admin atau boss, minta password
            if (selectedUser.role === 'admin' || selectedUser.role === 'boss') {
                showPasswordModal(selectedUser);
            } else {
                // Untuk karyawan, langsung ganti tanpa password
                currentUser = selectedUser;
                console.log(`User changed to: ${currentUser.name} (${currentUser.role})`);
                updateUserRoleDisplay();
                updateUI();
                
                // Tutup modal jika terbuka
                if (userReminderModal.classList.contains('show')) {
                    userReminderModal.classList.remove('show');
                }
            }
        });

        checkInBtn.addEventListener('click', () => submitAttendance('checkin'));
        checkOutBtn.addEventListener('click', () => submitAttendance('checkout'));

        historyEmployeeFilter.addEventListener('change', updateHistoryTab);
        historyPeriod.addEventListener('change', updateHistoryTab);
        employeesPeriod.addEventListener('change', updateEmployeesTab);
        exportExcelBtn.addEventListener('click', exportToExcel);
        reportPeriod.addEventListener('change', updateReportsTab);

        // Inisialisasi aplikasi
        async function initApp() {
            console.log("Initializing WorkSync Attendance Dashboard...");
            updateDateTime();
            initializeUserDropdown();
            setupNavigation();
            
            // Update waktu setiap detik
            setInterval(updateDateTime, 1000);
            
            await loadAttendanceData();
            setupFirestoreListener();
            
            // Tampilkan modal pengingat (akan muncul setiap refresh)
            showUserReminderModal();
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>