<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance ICR</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script src="config.js"></script>

    <style>
        :root {
            --primary-bg: #0f0f0f;
            --secondary-bg: #1a1a1a;
            --accent-color: #ff2d95;
            --accent-glow: 0 0 15px rgba(255, 45, 149, 0.7);
            --text-color: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #333333;
            --success-color: #00c853;
            --warning-color: #ffcc00;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--primary-bg);
            color: var(--text-color);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--secondary-bg);
            padding: 20px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
            color: var(--accent-color);
            text-shadow: var(--accent-glow);
        }

        .nav-item {
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }

        .nav-item:hover {
            background-color: rgba(255, 45, 149, 0.1);
        }

        .nav-item.active {
            background-color: rgba(255, 45, 149, 0.2);
            color: var(--accent-color);
            box-shadow: var(--accent-glow);
        }

        .nav-icon {
            margin-right: 10px;
            font-size: 18px;
        }

        .user-info {
            margin-top: auto;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .time-display {
            font-size: 28px;
            font-weight: bold;
            text-shadow: var(--accent-glow);
        }

        .date-display {
            color: var(--text-secondary);
            font-size: 18px;
        }

        /* Tombol Logout yang Lebih Kecil */
        .logout-btn {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            position: absolute;
            top: 0;
            right: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 10px rgba(108, 117, 125, 0.7);
        }

        /* Main Dashboard Layout */
        .dashboard-main {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 30px;
        }

        /* Attendance Hub - Larger Design */
        .attendance-hub {
            background: linear-gradient(135deg, #1a1a1a, #2a1a2a);
            border-radius: 16px;
            padding: 40px;
            border: 1px solid rgba(255, 45, 149, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .attendance-hub::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,45,149,0.15) 0%, rgba(255,45,149,0) 70%);
            z-index: 0;
        }

        /* Container dropdown custom */
        .custom-select-container {
            position: relative;
            width: 100%;
        }

        #employeeSelect {
            width: 100%;
            padding: 18px 25px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            background: linear-gradient(145deg, rgba(26, 26, 26, 0.9), rgba(40, 40, 40, 0.9));
            color: var(--text-color);
            font-size: 16px;
            font-weight: 500;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            backdrop-filter: blur(10px);
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.3),
                0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Custom arrow untuk dropdown */
        .custom-select-container::after {
            content: "‚ñº";
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            color: var(--accent-color);
            font-size: 12px;
            pointer-events: none;
            transition: transform 0.3s ease;
        }

        .custom-select-container:hover::after {
            transform: translateY(-50%) scale(1.2);
        }

        /* Hover effect pada dropdown */
        #employeeSelect:hover {
            border-color: rgba(255, 45, 149, 0.5);
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.3),
                0 4px 20px rgba(255, 45, 149, 0.15);
            background: linear-gradient(145deg, rgba(30, 30, 30, 0.95), rgba(45, 45, 45, 0.95));
        }

        /* Focus effect pada dropdown */
        #employeeSelect:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.3),
                0 0 0 3px rgba(255, 45, 149, 0.1),
                0 4px 25px rgba(255, 45, 149, 0.25);
            background: linear-gradient(145deg, rgba(35, 35, 35, 1), rgba(50, 50, 50, 1));
            transform: translateY(-2px);
        }

        /* Styling untuk option dalam dropdown */
        #employeeSelect option {
            background-color: var(--secondary-bg);
            color: var(--text-color);
            padding: 15px 20px;
            font-size: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        /* Option pertama (placeholder) */
        #employeeSelect option[value=""] {
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }

        /* Grouping untuk kategori karyawan */
        .optgroup {
            font-weight: bold;
            color: var(--accent-color) !important;
            background: rgba(255, 45, 149, 0.1) !important;
            padding: 10px 15px !important;
            font-size: 14px !important;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* Placeholder styling */
        #employeeSelect option:first-child {
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Animasi untuk dropdown ketika dipilih */
        @keyframes selectPulse {
            0% {
                box-shadow: 
                    inset 0 2px 4px rgba(0, 0, 0, 0.3),
                    0 0 0 0 rgba(255, 45, 149, 0.4);
            }
            70% {
                box-shadow: 
                    inset 0 2px 4px rgba(0, 0, 0, 0.3),
                    0 0 0 15px rgba(255, 45, 149, 0);
            }
            100% {
                box-shadow: 
                    inset 0 2px 4px rgba(0, 0, 0, 0.3),
                    0 0 0 0 rgba(255, 45, 149, 0);
            }
        }

        #employeeSelect:focus {
            animation: selectPulse 1.5s ease;
        }

        /* Styling untuk dropdown saat valid (telah memilih) */
        #employeeSelect:valid {
            border-color: var(--success-color);
            color: var(--text-color);
        }

        /* Error state untuk dropdown */
        #employeeSelect.error {
            border-color: #ff4757;
            animation: errorShake 0.5s ease;
        }

        @keyframes errorShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* Success state untuk dropdown */
        #employeeSelect.success {
            border-color: var(--success-color);
            animation: successGlow 1s ease;
        }

        @keyframes successGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(0, 200, 83, 0); }
            50% { box-shadow: 0 0 20px rgba(0, 200, 83, 0.5); }
        }

        /* Styling untuk tombol navigasi mingguan */
        .week-nav-btn {
            padding: 8px 16px !important;
            font-size: 12px !important;
            border-radius: 6px !important;
            font-weight: 500 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            border: 1px solid var(--border-color) !important;
            transition: all 0.3s ease !important;
            cursor: pointer !important;
        }

        .week-nav-prev {
            background: linear-gradient(135deg, #6c757d, #495057) !important;
            color: white !important;
        }

        .week-nav-next {
            background: linear-gradient(135deg, var(--accent-color), #ff5e9c) !important;
            color: white !important;
        }

        .week-nav-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
        }

        .week-nav-prev:hover {
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3) !important;
        }

        .week-nav-next:hover {
            box-shadow: 0 4px 12px rgba(255, 45, 149, 0.3) !important;
        }

        /* Container untuk navigasi mingguan */
        .week-nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .week-range-display {
            font-weight: bold;
            color: var(--accent-color);
            font-size: 14px;
            text-align: center;
            flex-grow: 1;
            padding: 0 10px;
        }

        .attendance-hub-content {
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .hub-title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--accent-color);
            text-shadow: var(--accent-glow);
        }

        .hub-subtitle {
            color: var(--text-secondary);
            margin-bottom: 40px;
            font-size: 18px;
        }

        .divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-color), transparent);
            margin: 30px 0;
        }

        .current-time-label {
            color: var(--text-secondary);
            font-size: 16px;
            margin-bottom: 10px;
        }

        .current-time {
            font-size: 42px;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: var(--accent-glow);
        }

        .current-date {
            color: var(--text-secondary);
            font-size: 20px;
            margin-bottom: 40px;
        }

        .status-container {
            margin: 30px 0;
        }

        .status-message {
            font-size: 22px;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 25px;
            font-weight: bold;
        }

        .checked-out {
            background-color: rgba(255, 45, 149, 0.15);
            color: var(--accent-color);
            border: 2px solid rgba(255, 45, 149, 0.4);
        }

        .checked-in {
            background-color: rgba(0, 200, 83, 0.15);
            color: var(--success-color);
            border: 2px solid rgba(0, 200, 83, 0.4);
        }

        .duration-display {
            font-size: 28px;
            font-weight: bold;
            margin: 20px 0;
            color: var(--accent-color);
            text-shadow: var(--accent-glow);
        }

        .action-buttons {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .checkin-btn {
            background: linear-gradient(135deg, var(--accent-color), #ff5e9c);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 12px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            box-shadow: var(--accent-glow);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .modal-overlay.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }

        .checkin-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 25px rgba(255, 17, 156, 0.9);
        }

        .checkin-btn:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .checkout-btn {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 12px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .checkout-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 15px rgba(108, 117, 125, 0.7);
        }

        .checkout-btn:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Side Panel */
        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .card {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .card:hover {
            box-shadow: var(--accent-glow);
            transform: translateY(-5px);
        }

        .card-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--accent-color);
            display: flex;
            align-items: center;
        }

        .card-icon {
            margin-right: 10px;
            font-size: 22px;
        }

        .attendance-list {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .attendance-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .attendance-time {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .active-employee {
            color: var(--accent-color);
            font-weight: bold;
        }

        /* Bottom Section */
        .dashboard-bottom {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .warning {
            color: var(--warning-color);
            background-color: rgba(255, 204, 0, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid var(--warning-color);
        }

        .employee-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .employee-card {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .employee-card:hover {
            background-color: rgba(255, 45, 149, 0.1);
            transform: translateY(-3px);
        }

        .employee-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .employee-position {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .hours-warning {
            color: #ff6b6b;
            font-size: 12px;
            margin-top: 5px;
        }

        /* Login Popup */
        .login-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-in-out;
        }

        .login-popup.hidden {
            display: none;
        }

            .force-checkout-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #ff4757, #ff3838);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        z-index: 9998;
        box-shadow: 0 4px 15px rgba(255, 71, 87, 0.5);
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .force-checkout-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(255, 71, 87, 0.7);
    }

    .force-checkout-btn.hidden {
        display: none;
    }

    /* Modal force checkout */
    .force-checkout-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1002;
        animation: fadeIn 0.3s ease-in-out;
    }

    .force-checkout-modal.hidden {
        display: none;
    }

    .force-checkout-modal-content {
        background: linear-gradient(135deg, #1a1a1a, #2a1a2a);
        border-radius: 20px;
        padding: 40px;
        width: 90%;
        max-width: 500px;
        border: 2px solid #ff4757;
        box-shadow: 0 0 20px rgba(255, 71, 87, 0.5);
        animation: slideUp 0.4s ease-out;
        position: relative;
        overflow: hidden;
    }

    .force-checkout-modal-content::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,71,87,0.1) 0%, rgba(255,71,87,0) 70%);
        z-index: 0;
    }

    .force-checkout-modal-title {
        text-align: center;
        margin-bottom: 20px;
        color: #ff4757;
        font-size: 28px;
        font-weight: bold;
        text-shadow: 0 0 10px rgba(255, 71, 87, 0.5);
        position: relative;
        z-index: 1;
    }

    .force-checkout-warning {
        background: rgba(255, 71, 87, 0.1);
        border-radius: 10px;
        padding: 15px;
        margin: 20px 0;
        border: 1px solid rgba(255, 71, 87, 0.3);
        position: relative;
        z-index: 1;
    }

    .force-checkout-warning-title {
        color: #ff4757;
        font-weight: bold;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .force-checkout-options {
        margin: 20px 0;
        position: relative;
        z-index: 1;
    }

    .force-checkout-option {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
        border: 1px solid var(--border-color);
    }

    .force-checkout-option:hover {
        background: rgba(255, 71, 87, 0.1);
        border-color: #ff4757;
    }

    .force-checkout-option.selected {
        background: rgba(255, 71, 87, 0.15);
        border-color: #ff4757;
    }

    .option-title {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .option-desc {
        color: var(--text-secondary);
        font-size: 12px;
    }

    .force-checkout-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        position: relative;
        z-index: 1;
    }

    .force-checkout-confirm {
        background: linear-gradient(135deg, #ff4757, #ff3838);
        color: white;
        border: none;
        padding: 15px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        flex: 1;
        transition: all 0.3s;
    }

    .force-checkout-confirm:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 15px rgba(255, 71, 87, 0.7);
    }

    .force-checkout-cancel {
        background: linear-gradient(135deg, #6c757d, #495057);
        color: white;
        border: none;
        padding: 15px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        flex: 1;
        transition: all 0.3s;
    }

    .force-checkout-cancel:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 10px rgba(108, 117, 125, 0.7);
    }

        .login-popup-content {
            background: linear-gradient(135deg, #1a1a1a, #2a1a2a);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 500px;
            border: 2px solid var(--accent-color);
            box-shadow: var(--accent-glow);
            animation: slideUp 0.4s ease-out;
            position: relative;
            overflow: hidden;
        }

        .login-popup-content::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,45,149,0.1) 0%, rgba(255,45,149,0) 70%);
            z-index: 0;
        }

        .login-popup-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }

        .login-popup-title {
            font-size: 32px;
            font-weight: bold;
            color: var(--accent-color);
            text-shadow: var(--accent-glow);
            margin-bottom: 10px;
        }

        .login-popup-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
            z-index: 1;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-size: 16px;
            color: var(--text-color);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(255, 45, 149, 0.3);
        }

        .password-input-container {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
        }

        .login-popup-btn {
            background: linear-gradient(135deg, var(--accent-color), #ff5e9c);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
            box-shadow: var(--accent-glow);
            position: relative;
            z-index: 1;
        }

        .login-popup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(255, 45, 149, 0.9);
        }

        .hidden {
            display: none;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Password Modal */
        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            animation: fadeIn 0.3s ease-in-out;
        }

        .password-modal.hidden {
            display: none;
        }

        .password-modal-content {
            background: linear-gradient(135deg, #1a1a1a, #2a1a2a);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 450px;
            border: 2px solid var(--accent-color);
            box-shadow: var(--accent-glow);
            animation: slideUp 0.4s ease-out;
            position: relative;
            overflow: hidden;
        }

        .password-modal-content::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,45,149,0.1) 0%, rgba(255,45,149,0) 70%);
            z-index: 0;
        }

        .password-modal-title {
            text-align: center;
            margin-bottom: 20px;
            color: var(--accent-color);
            font-size: 28px;
            font-weight: bold;
            text-shadow: var(--accent-glow);
            position: relative;
            z-index: 1;
        }

        .selected-employee {
            text-align: center;
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 45, 149, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 45, 149, 0.3);
            position: relative;
            z-index: 1;
        }

        .employee-role-badge {
            display: inline-block;
            padding: 4px 12px;
            background: var(--accent-color);
            color: white;
            border-radius: 6px;
            font-size: 12px;
            margin-left: 8px;
            font-weight: bold;
        }

        /* Weekly Overview Styles */
        .week-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .day-card {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .day-card:hover {
            background-color: rgba(255, 45, 149, 0.1);
            transform: translateY(-3px);
        }

        .day-name {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .day-date {
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 5px;
        }

        .day-hours {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .low-hours {
            color: #ff6b6b;
        }

        .good-hours {
            color: var(--success-color);
        }

        /* Daily Attendance Details */
        .daily-details {
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        .daily-details-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--accent-color);
        }

        .daily-attendance-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .daily-attendance-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .daily-attendance-info {
            flex: 1;
        }

        .daily-attendance-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .daily-attendance-time {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .daily-attendance-duration {
            color: var(--accent-color);
            font-weight: bold;
            font-size: 14px;
        }

        .no-data {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
            font-style: italic;
        }

        /* Check-in Details */
        .checkin-details {
            background: rgba(255, 45, 149, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 45, 149, 0.3);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .detail-label {
            color: var(--text-secondary);
        }

        .detail-value {
            font-weight: bold;
            color: var(--accent-color);
        }

        /* Weekly Summary */
        .weekly-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .summary-label {
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* Employee Detail Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--secondary-bg);
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--accent-color);
            box-shadow: var(--accent-glow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 24px;
            color: var(--accent-color);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .close-btn:hover {
            color: var(--accent-color);
        }

        .employee-detail-info {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .detail-week-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
        }

        .week-range {
            font-weight: bold;
            color: var(--accent-color);
        }

        .employee-detail-week {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .employee-day-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
        }

        .employee-day-card.has-data {
            background: rgba(255, 45, 149, 0.1);
            border: 1px solid rgba(255, 45, 149, 0.3);
        }

        .employee-day-card:hover {
            transform: translateY(-2px);
        }

        .employee-day-sessions {
            margin-top: 10px;
            font-size: 12px;
        }

        .employee-session {
            margin-bottom: 5px;
            padding: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        /* Notifikasi */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #1a1a1a, #2a1a2a);
            color: var(--text-color);
            padding: 15px 20px;
            border-radius: 10px;
            border: 2px solid var(--accent-color);
            box-shadow: var(--accent-glow);
            z-index: 9999;
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-icon {
            color: var(--accent-color);
            font-size: 20px;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            color: var(--accent-color);
            font-weight: bold;
            margin-bottom: 5px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Login Popup -->
    <div id="loginPopup" class="login-popup">
        <div class="login-popup-content">
            <div class="login-popup-header">
                <h1 class="login-popup-title">ATTENDANCE SYSTEM</h1>
                <p class="login-popup-subtitle">Silakan pilih karyawan untuk melanjutkan</p>
            </div>
            <div class="form-group">
                <label class="form-label">Nama Karyawan</label>
                <select id="employeeSelect" class="form-input">
                    <option value="">Pilih Karyawan</option>
                    <!-- Options akan diisi oleh JavaScript -->
                </select>
            </div>
            <button id="loginBtn" class="login-popup-btn">Login ke Dashboard</button>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="password-modal hidden">
        <div class="password-modal-content">
            <h2 class="password-modal-title">Password Required</h2>
            <div class="selected-employee">
                <strong id="selectedEmployeeName">Nama Karyawan</strong>
                <span class="employee-role-badge" id="selectedEmployeeRole">Role</span>
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <div class="password-input-container">
                    <input type="password" id="passwordInput" class="form-input" placeholder="Masukkan password">
                    <button type="button" class="toggle-password" id="togglePassword">üëÅÔ∏è</button>
                </div>
            </div>
            <div class="form-group">
                <button id="submitPassword" class="login-popup-btn">Submit Password</button>
                <button id="cancelPassword" class="checkout-btn" style="width: 100%; margin-top: 10px; padding: 15px; border-radius: 10px;">Kembali</button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="container hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">ICR ATTENDANCE</div>
            <div class="nav-item active" data-tab="dashboard-tab">
                <span class="nav-icon">üìä</span> Dashboard
            </div>
            <div class="nav-item" data-tab="history-tab">
                <span class="nav-icon">üìÖ</span> History
            </div>
            <div id="bossNav" class="nav-item hidden" data-tab="employees-tab">
                <span class="nav-icon">üë•</span> Employees Data
            </div>
            <div id="weeklyNav" class="nav-item hidden" data-tab="weekly-tab">
                <span class="nav-icon">üìà</span> Weekly Recap
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div>
                    <div id="userName">User</div>
                    <div id="userRole" style="font-size: 12px; color: var(--text-secondary);">Role</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <div>
                    <div class="time-display" id="currentTime">00:00:00</div>
                    <div class="date-display" id="currentDate">Hari, Tanggal</div>
                </div>
                <!-- Tombol Logout yang Lebih Kecil di Pojok Kanan Atas -->
                <button id="logoutBtn" class="logout-btn">Logout</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content">
                <div class="dashboard-main">
                    <!-- Attendance Hub - Larger Design -->
                    <div class="attendance-hub">
                        <div class="attendance-hub-content">
                            <h2 class="hub-title">Attendance Hub</h2>
                            <p class="hub-subtitle">This attendance will be checked against the attendance log recorded in the city</p>
                            
                            <div class="divider"></div>
                            
                            <div class="current-time-label">Current Time</div>
                            <div class="current-time" id="hubCurrentTime">06:07:00</div>
                            <div class="current-date" id="hubCurrentDate">Monday, December 1, 2025</div>
                            
                            <div class="status-container">
                                <div id="statusMessage" class="status-message checked-out">
                                    You are currently checked out.
                                </div>
                                
                                <div id="durationDisplay" class="duration-display">0h 0m</div>
                                
                                <div id="checkinDetails" class="checkin-details hidden">
                                    <div class="detail-row">
                                        <span class="detail-label">Checked in at:</span>
                                        <span class="detail-value" id="checkinTimeValue">--:--:--</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Duration:</span>
                                        <span class="detail-value" id="currentDurationValue">0h 0m</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="action-buttons">
                                <button id="checkinBtn" class="checkin-btn">Check In</button>
                                <button id="checkoutBtn" class="checkout-btn" disabled>Check Out</button>
                            </div>
                        </div>
                    </div>

                    <!-- Side Panel -->
                    <div class="side-panel">
                        <!-- Today's Check-ins -->
                        <div class="card">
                            <h3 class="card-title">
                                <span class="card-icon">üìã</span> Today's Check-Ins
                            </h3>
                            <ul class="attendance-list" id="todayCheckins">
                                <li>Loading...</li>
                            </ul>
                        </div>

                        <!-- Currently Active -->
                        <div class="card">
                            <h3 class="card-title">
                                <span class="card-icon">‚è±Ô∏è</span> Currently Active
                            </h3>
                            <div id="activeEmployees">
                                <p>Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bottom Section -->
                <div class="dashboard-bottom">
                    <!-- Attendance History -->
                    <div class="card">
                        <h3 class="card-title">
                            <span class="card-icon">üìä</span> Attendance History
                        </h3>
                        <p>Your recent attendance records:</p>
                        <ul class="attendance-list" id="attendanceHistory">
                            <li>Loading...</li>
                        </ul>
                    </div>

                    <!-- Weekly Hours Warning -->
                    <div id="weeklyWarning" class="card hidden">
                        <h3 class="card-title">
                            <span class="card-icon">‚ö†Ô∏è</span> Weekly Hours Alert
                        </h3>
                        <div id="warningContent">
                            <!-- Warning content will be added here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history-tab" class="tab-content hidden">
                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üìÖ</span> Full Attendance History
                    </h3>
                    <div id="fullHistory">
                        <!-- Full history will be added here -->
                    </div>
                </div>
            </div>

            <!-- Employees Tab (Boss Only) -->
            <div id="employees-tab" class="tab-content hidden">
                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üë•</span> All Employees
                    </h3>
                    <div class="employee-list" id="allEmployees">
                        <!-- All employees will be listed here -->
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üìä</span> Weekly Attendance Overview
                    </h3>
                    <div id="weeklyOverview">
                        <!-- Weekly overview will be added here -->
                    </div>
                </div>
            </div>

            <!-- Weekly Report Tab (Boss Only) -->
            <div id="weekly-tab" class="tab-content hidden">
                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üìà</span> Laporan Absensi Mingguan
                    </h3>
                    
                    <!-- Weekly Summary -->
                    <div class="weekly-summary">
                        <div class="summary-card">
                            <div class="summary-value" id="totalEmployees">0</div>
                            <div class="summary-label">Total Karyawan</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value" id="avgHours">0h</div>
                            <div class="summary-label">Rata-rata Jam/Minggu</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value" id="underperforming">0</div>
                            <div class="summary-label">Kurang dari 21 jam</div>
                        </div>
                    </div>

                    <!-- Week Navigation -->
                    <div class="week-nav-container">
                        <button id="prevWeek" class="week-nav-btn week-nav-prev">Minggu Sebelumnya</button>
                        <div id="currentWeekRange" class="week-range-display">Minggu 1-7 Des 2025</div>
                        <button id="nextWeek" class="week-nav-btn week-nav-next">Minggu Berikutnya</button>
                    </div>

                    <!-- Weekly Calendar View -->
                    <div class="week-view" id="weeklyCalendar">
                        <!-- Calendar days will be populated here -->
                    </div>

                    <!-- Daily Attendance Details -->
                    <div class="daily-details">
                        <h4 class="daily-details-title" id="selectedDayTitle">Pilih hari untuk melihat detail absensi</h4>
                        <div class="daily-attendance-list" id="dailyAttendanceList">
                            <div class="no-data">Pilih salah satu hari di atas untuk melihat detail absensi</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Employee Detail -->
    <div id="employeeDetailModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="employeeDetailTitle">Detail Karyawan</h2>
                <button class="close-btn" id="closeEmployeeDetail">&times;</button>
            </div>
            <div class="employee-detail-info" id="employeeDetailInfo">
                <!-- Employee info will be populated here -->
            </div>
                <div class="week-nav-container">
                    <button id="prevEmployeeWeek" class="week-nav-btn week-nav-prev">Minggu Sebelumnya</button>
                    <div class="week-range-display" id="employeeWeekRange">Minggu 1-7 Des 2025</div>
                    <button id="nextEmployeeWeek" class="week-nav-btn week-nav-next">Minggu Berikutnya</button>
                </div>
            <div class="employee-detail-week" id="employeeDetailWeek">
                <!-- Employee weekly attendance will be populated here -->
            </div>
            <div class="daily-details">
                <h4 class="daily-details-title" id="employeeSelectedDayTitle">Pilih hari untuk melihat detail absensi</h4>
                <div class="daily-attendance-list" id="employeeDailyAttendanceList">
                    <div class="no-data">Pilih salah satu hari di atas untuk melihat detail absensi</div>
                </div>
            </div>
        </div>
    </div>

    <button id="forceCheckoutBtn" class="force-checkout-btn hidden">üîß Force Checkout</button>

    <div id="forceCheckoutModal" class="force-checkout-modal hidden">
    <div class="force-checkout-modal-content">
        <h2 class="force-checkout-modal-title">üîß Force Checkout</h2>
        
        <div class="force-checkout-warning">
            <div class="force-checkout-warning-title">‚ö†Ô∏è PERHATIAN</div>
            <div>Fitur ini digunakan untuk mengatasi masalah session yang terjebak. Pastikan Anda memahami konsekuensinya.</div>
        </div>
        
        <div class="selected-employee">
            <strong>Karyawan:</strong> <span id="forceCheckoutEmployeeName">-</span>
            <br>
            <strong>Status:</strong> <span id="forceCheckoutStatus">-</span>
        </div>
        
        <div class="force-checkout-options">
            <div class="force-checkout-option" data-option="current">
                <div class="option-title">Checkout Session Saat Ini</div>
                <div class="option-desc">Menutup session aktif Anda saat ini</div>
            </div>
            
            <div class="force-checkout-option" data-option="all">
                <div class="option-title">Checkout Semua Session Aktif</div>
                <div class="option-desc">Menutup SEMUA session aktif Anda (jika ada lebih dari satu)</div>
            </div>
            
            <div class="force-checkout-option" data-option="clear">
                <div class="option-title">Bersihkan & Reset</div>
                <div class="option-desc">Bersihkan localStorage dan reset semua session</div>
            </div>
        </div>
        
        <div id="forceCheckoutNote" style="margin: 15px 0; padding: 10px; background: rgba(255,71,87,0.1); border-radius: 8px; font-size: 12px; color: var(--text-secondary);">
            <!-- Catatan akan ditampilkan di sini -->
        </div>
        
        <div class="force-checkout-actions">
            <button id="forceCheckoutConfirm" class="force-checkout-confirm">Konfirmasi</button>
            <button id="forceCheckoutCancel" class="force-checkout-cancel">Batal</button>
        </div>
    </div>
</div>

    <script>

        // Inisialisasi Firebase
        firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.firestore();

        // Data karyawan
        const employees = [
            { id: 1, name: "Admin User", role: "admin", position: "Administrator" },
            { id: 2, name: "Enzy", role: "boss", position: "boss" },
            { id: 3, name: "Don Oska", role: "boss", position: "boss" },
            { id: 4, name: "Ace", role: "boss", position: "boss" },
            { id: 5, name: "Marco", role: "boss", position: "boss" },
            { id: 6, name: "Cartenz", role: "boss", position: "boss" },
            { id: 7, name: "Giw", role: "boss", position: "boss" },
            { id: 8, name: "Vyan", role: "boss", position: "boss" },
            { id: 9, name: "Ryota", role: "boss", position: "boss" },
            { id: 10, name: "Tommm", role: "employee", position: "Manager" },
            { id: 11, name: "Beckham Durrel", role: "employee", position: "Manager" },
            { id: 12, name: "Goby Chana", role: "employee", position: "Manager" },
            { id: 13, name: "Cihyi Mori", role: "employee", position: "Manager" },
            { id: 14, name: "Kyra", role: "employee", position: "Manager" },
            { id: 15, name: "Koko", role: "employee", position: "Manager" },
            { id: 16, name: "Broklyn", role: "employee", position: "Manager" },
            { id: 17, name: "Andre", role: "employee", position: "Manager" },
            { id: 18, name: "Vinsaka", role: "employee", position: "Manager" },
            { id: 19, name: "Yori", role: "employee", position: "Manager" },
            { id: 20, name: "Berhala", role: "employee", position: "Senior Mechanic" },
            { id: 21, name: "Ruby", role: "employee", position: "Senior Mechanic" },
            { id: 22, name: "Maudy", role: "employee", position: "Senior Mechanic" },
            { id: 23, name: "Zairen", role: "employee", position: "Senior Mechanic" },
            { id: 24, name: "Gwen", role: "employee", position: "Senior Mechanic" },
            { id: 25, name: "Aidan", role: "employee", position: "Senior Mechanic" },
            { id: 26, name: "Dahyun", role: "employee", position: "Senior Mechanic" },
            { id: 27, name: "Ruuna", role: "employee", position: "Senior Mechanic" },
            { id: 28, name: "Rachel", role: "employee", position: "Senior Mechanic" },
            { id: 29, name: "Angie", role: "employee", position: "Senior Mechanic" },
            { id: 30, name: "Ucok", role: "employee", position: "Senior Mechanic" },
            { id: 31, name: "Cabe", role: "employee", position: "Senior Mechanic" },
            { id: 32, name: "Saul", role: "employee", position: "Senior Mechanic" },
            { id: 33, name: "Blitz", role: "employee", position: "Senior Mechanic" },
            { id: 35, name: "Muller", role: "employee", position: "Mechanic" },
            { id: 36, name: "Zumi", role: "employee", position: "Mechanic" },
            { id: 37, name: "Ajat", role: "employee", position: "Mechanic" },
            { id: 38, name: "Molly", role: "employee", position: "Mechanic" },
            { id: 39, name: "Mai", role: "employee", position: "Mechanic" },
            { id: 40, name: "Tuffy", role: "employee", position: "Mechanic" },
            { id: 41, name: "Darel", role: "employee", position: "Mechanic" },
            { id: 42, name: "Lucas", role: "employee", position: "Mechanic" },
            { id: 43, name: "Aceng", role: "employee", position: "Mechanic" },
            { id: 44, name: "Vera", role: "employee", position: "Mechanic" },
            { id: 45, name: "Athena", role: "employee", position: "Mechanic" },
            { id: 46, name: "Jeni Unggrr", role: "employee", position: "Mechanic" },
            { id: 47, name: "Latisha", role: "employee", position: "Mechanic" },
            { id: 48, name: "Janice", role: "employee", position: "Mechanic" },
            { id: 49, name: "Meisya", role: "employee", position: "Mechanic" },
            { id: 50, name: "Yuki", role: "employee", position: "Mechanic" },
            { id: 51, name: "Jonathan", role: "employee", position: "Mechanic" },
            { id: 52, name: "Summer", role: "employee", position: "Training" },
            { id: 53, name: "Cia", role: "employee", position: "Training" },
            { id: 54, name: "Kaguya", role: "employee", position: "Training" },
            { id: 55, name: "Castella", role: "employee", position: "Training" },
            { id: 56, name: "jejeng", role: "employee", position: "Training" },
            { id: 57, name: "Ismaya", role: "employee", position: "Training" },
            { id: 58, name: "Celiste", role: "employee", position: "Mechanic" },
            { id: 59, name: "Lexy", role: "employee", position: "Mechanic" },
            { id: 60, name: "Ami", role: "employee", position: "Senior Mechanic" },
            { id: 61, name: "Lika", role: "employee", position: "Training" },
        ];

        // State aplikasi
        let currentUser = null;
        let checkInTime = null;
        let timerInterval = null;
        let currentSessionId = null;
        let currentWeekOffset = 0;
        let currentEmployeeWeekOffset = 0;
        let selectedEmployee = null;
        let pendingEmployee = null;
        let dayChangeInterval = null;
        let isCheckingIn = false;

        // Real-time listeners
        let activeListeners = {
            todayCheckins: null,
            activeEmployees: null,
            attendanceHistory: null,
            currentStatus: null,
            fullHistory: null,
            allEmployees: null,
            weeklyOverview: null,
            dailyAttendance: null,
            employeeDetail: null
        };

        // Key untuk localStorage
        const STORAGE_KEYS = {
            CURRENT_USER: 'attendance_current_user',
            CHECKIN_DATA: 'attendance_checkin_data',
            LAST_ACTIVITY: 'attendance_last_activity'
        };

        // Simpan state ke localStorage
        function saveStateToLocalStorage() {
            try {
                if (currentUser) {
                    localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify({
                        id: currentUser.id,
                        name: currentUser.name,
                        role: currentUser.role,
                        position: currentUser.position
                    }));
                }
                
                if (checkInTime && currentSessionId) {
                    localStorage.setItem(STORAGE_KEYS.CHECKIN_DATA, JSON.stringify({
                        checkInTime: checkInTime.toISOString(),
                        sessionId: currentSessionId
                    }));
                }
                
                localStorage.setItem(STORAGE_KEYS.LAST_ACTIVITY, Date.now().toString());
            } catch (error) {
                console.error('Error saving state to localStorage:', error);
            }
        }

        // Load state dari localStorage
        function loadStateFromLocalStorage() {
            try {
                // Load current user
                const userData = localStorage.getItem(STORAGE_KEYS.CURRENT_USER);
                if (userData) {
                    const user = JSON.parse(userData);
                    // Cari user di daftar employees
                    const employee = employees.find(emp => emp.id === user.id);
                    if (employee) {
                        currentUser = employee;
                    }
                }
                
                // Load checkin data
                const checkinData = localStorage.getItem(STORAGE_KEYS.CHECKIN_DATA);
                if (checkinData) {
                    const data = JSON.parse(checkinData);
                    if (data.checkInTime && data.sessionId) {
                        checkInTime = new Date(data.checkInTime);
                        currentSessionId = data.sessionId;
                    }
                }
                
                return {
                    hasUser: !!userData,
                    hasCheckin: !!checkinData
                };
            } catch (error) {
                console.error('Error loading state from localStorage:', error);
                return { hasUser: false, hasCheckin: false };
            }
        }

        // Clear state dari localStorage
        function clearStateFromLocalStorage() {
            try {
                localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
                localStorage.removeItem(STORAGE_KEYS.CHECKIN_DATA);
                localStorage.removeItem(STORAGE_KEYS.LAST_ACTIVITY);
            } catch (error) {
                console.error('Error clearing state from localStorage:', error);
            }
        }

        // Periksa dan recover session yang masih aktif
        async function checkAndRecoverSession() {
            const state = loadStateFromLocalStorage();
            
            if (state.hasUser && state.hasCheckin) {
                console.log('Mencoba recover session dari localStorage...');
                
                try {
                    // Verifikasi session masih valid di Firebase
                    if (currentSessionId) {
                        const sessionDoc = await db.collection('attendance').doc(currentSessionId).get();
                        
                        if (sessionDoc.exists) {
                            const sessionData = sessionDoc.data();
                            
                            // Jika session masih aktif di Firebase
                            if (sessionData.status === 'active') {
                                console.log('Session berhasil di-recover');
                                
                                // Update checkInTime dari data Firebase (lebih akurat)
                                const checkInTimeData = getTimestampData(sessionData, 'checkIn');
                                if (checkInTimeData) {
                                    checkInTime = checkInTimeData;
                                }
                                
                                // Langsung login ke dashboard
                                showDashboard();
                                
                                // Tampilkan notifikasi
                                showNotification('Session sebelumnya berhasil di-recover. Anda masih dalam keadaan check-in.', 'info');
                                
                                return true;
                            } else {
                                console.log('Session sudah tidak aktif, membersihkan localStorage...');
                                clearStateFromLocalStorage();
                                showLoginPopup();
                            }
                        } else {
                            console.log('Session tidak ditemukan di Firebase, membersihkan localStorage...');
                            clearStateFromLocalStorage();
                            showLoginPopup();
                        }
                    }
                } catch (error) {
                    console.error('Error recovering session:', error);
                    clearStateFromLocalStorage();
                    showLoginPopup();
                }
            }
            
            return false;
        }

        // Event untuk menyimpan state sebelum browser/tab ditutup
        function setupBeforeUnloadListener() {
            window.addEventListener('beforeunload', function(event) {
                saveStateToLocalStorage();
            });
            
            // Juga simpan secara periodik untuk keamanan
            setInterval(saveStateToLocalStorage, 30000); // Setiap 30 detik
            
            // Simpan saat user melakukan check-in/check-out
            const originalCheckin = document.getElementById('checkinBtn').onclick;
            document.getElementById('checkinBtn').onclick = function() {
                if (originalCheckin) originalCheckin.call(this);
                saveStateToLocalStorage();
            };
            
            const originalCheckout = document.getElementById('checkoutBtn').onclick;
            document.getElementById('checkoutBtn').onclick = function() {
                if (originalCheckout) originalCheckout.call(this);
                clearStateFromLocalStorage();
            };
        }


        // ==================== FUNGSI UTILITY ====================

        // Fungsi untuk mendapatkan waktu WIB
        function getWIBTime() {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const wibTime = new Date(utc + (7 * 3600000));
            return wibTime;
        }

        // Format waktu
        function formatTime(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        function formatDate(date) {
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                timeZone: 'Asia/Jakarta'
            };
            return date.toLocaleDateString('id-ID', options);
        }

        function getTimestampData(data, field) {
            if (!data || !data[field]) return null;
            
            if (data[field] instanceof Date) {
                return data[field];
            }
            
            if (data[field] && typeof data[field].toDate === 'function') {
                return data[field].toDate();
            }
            
            if (typeof data[field] === 'string') {
                return new Date(data[field]);
            }
            
            if (typeof data[field] === 'number') {
                return new Date(data[field]);
            }
            
            return null;
        }

        // Format tanggal singkat - DIPERBAIKI untuk konsistensi
        function formatShortDate(date) {
            const monthNames = [
                'Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun',
                'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'
            ];
            
            const day = date.getDate();
            const month = monthNames[date.getMonth()];
            
            return `${day} ${month}`;
        }

        // Fungsi untuk mendapatkan awal minggu (Senin) - DIPERBAIKI
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay(); // 0 = Minggu, 1 = Senin, ..., 6 = Sabtu
            
            // Hitung berapa hari mundur ke Senin
            let diff = day - 1; // default: mundur ke Senin
            
            // Jika hari Minggu (0), mundur 6 hari ke Senin minggu lalu
            if (day === 0) {
                diff = -6; // Minggu -> mundur 6 hari ke Senin
            }
            // Jika hari Senin (1), tidak perlu mundur
            else if (day === 1) {
                diff = 0;
            }
            // Untuk hari lain, mundur ke Senin
            else {
                diff = day - 1;
            }
            
            d.setDate(d.getDate() - diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        // Fungsi untuk mendapatkan awal minggu (Senin) - VERSI SIMPLE
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay(); // 0 = Minggu, 1 = Senin, ..., 6 = Sabtu
            
            // Hitung berapa hari mundur ke Senin
            // Jika hari Minggu (0) -> mundur 6 hari
            // Jika hari Senin (1) -> tidak mundur
            // Jika hari Selasa (2) -> mundur 1 hari
            // dst...
            let daysToSubtract = 0;
            
            if (day === 0) { // Minggu
                daysToSubtract = 6; // mundur ke Senin minggu lalu
            } else {
                daysToSubtract = day - 1; // mundur ke Senin minggu ini
            }
            
            d.setDate(d.getDate() - daysToSubtract);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        // Fungsi untuk mendapatkan hari tertentu dalam minggu - DIPERBAIKI
        function getDayOfWeek(startOfWeek, dayIndex) {
            const day = new Date(startOfWeek);
            
            // Karena startOfWeek sudah Senin, tidak perlu adjustment
            // dayIndex 0 = Senin, 1 = Selasa, ..., 6 = Minggu
            day.setDate(startOfWeek.getDate() + dayIndex);
            
            // Pastikan jam 00:00:00 untuk konsistensi query
            day.setHours(0, 0, 0, 0);
            return day;
        }

        // Fungsi untuk mendapatkan tanggal mingguan - DIPERBAIKI
        function getWeekDates(weekOffset = 0) {
            const today = getWIBTime();
            const startOfWeek = getStartOfWeek(today);
            
            const start = new Date(startOfWeek);
            start.setDate(start.getDate() + (weekOffset * 7));
            
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            end.setHours(23, 59, 59, 999);
            
            return { start, end };
        }

        // Format range mingguan - DIPERBAIKI
        function formatWeekRange(startDate, endDate) {
            const options = { 
                day: 'numeric',
                month: 'short',
                timeZone: 'Asia/Jakarta'
            };
            
            const startStr = startDate.toLocaleDateString('id-ID', options);
            const endStr = endDate.toLocaleDateString('id-ID', options);
            return `${startStr} - ${endStr}`;
        }

        // Ganti pemanggilan langsung dengan interval terbatas
        function startSessionCleanupMonitor() {
            // Hanya jalankan setiap 30 detik, bukan terus menerus
            setInterval(() => {
                if (currentUser && checkInTime && !isCheckingIn) {
                    ensureSingleActiveSession();
                }
            }, 30000);
        }

        // Format tanggal dengan format Indonesia (dd MMM)
        function formatIndonesianDate(date) {
            const monthNames = [
                'Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun',
                'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'
            ];
            
            const day = date.getDate();
            const month = monthNames[date.getMonth()];
            
            return `${day} ${month}`;
        }

        // Gunakan di formatWeekRange
        function formatWeekRange(startDate, endDate) {
            const startStr = formatIndonesianDate(startDate);
            const endStr = formatIndonesianDate(endDate);
            return `${startStr} - ${endStr}`;
        }

        // Update waktu real-time
        function updateTime() {
            const wibTime = getWIBTime();
            document.getElementById('currentTime').textContent = formatTime(wibTime);
            document.getElementById('currentDate').textContent = formatDate(wibTime);
            document.getElementById('hubCurrentTime').textContent = formatTime(wibTime);
            document.getElementById('hubCurrentDate').textContent = formatDate(wibTime);
        }

        // Hitung durasi - DIPERBAIKI
        function calculateDuration(startTime) {
            const now = getWIBTime();
            const diffMs = now - startTime;
            const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            const diffSecs = Math.floor((diffMs % (1000 * 60)) / 1000);
            return `${diffHrs}h ${diffMins}m ${diffSecs}s`;
        }

        // Update durasi secara real-time - DIPERBAIKI
        function updateDuration() {
            if (checkInTime) {
                const now = getWIBTime();
                const diffMs = now - checkInTime;
                const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
                const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                const diffSecs = Math.floor((diffMs % (1000 * 60)) / 1000);
                
                document.getElementById('durationDisplay').textContent = `${diffHrs}h ${diffMins}m ${diffSecs}s`;
                document.getElementById('currentDurationValue').textContent = `${diffHrs}h ${diffMins}m ${diffSecs}s`;
            }
        }

        // Update status check-in/check-out
        function updateStatusUI() {
            const statusMessage = document.getElementById('statusMessage');
            const checkinBtn = document.getElementById('checkinBtn');
            const checkoutBtn = document.getElementById('checkoutBtn');
            const checkinDetails = document.getElementById('checkinDetails');
            const checkinTimeValue = document.getElementById('checkinTimeValue');
            
            if (checkInTime) {
                statusMessage.textContent = "You are currently checked in.";
                statusMessage.className = "status-message checked-in";
                checkinBtn.disabled = true;
                checkoutBtn.disabled = false;
                checkinDetails.classList.remove('hidden');
                checkinTimeValue.textContent = formatTime(checkInTime);
            } else {
                statusMessage.textContent = "You are currently checked out.";
                statusMessage.className = "status-message checked-out";
                checkinBtn.disabled = false;
                checkoutBtn.disabled = true;
                checkinDetails.classList.add('hidden');
                document.getElementById('durationDisplay').textContent = "0h 0m";
            }
        }

        // ==================== SISTEM AUTO DAY CHANGE ====================

    function handleDayChange() {
        if (!currentUser || !checkInTime) return;
        
        const now = getWIBTime();
        const currentDateStr = now.toISOString().split('T')[0];
        const checkInDateStr = checkInTime.toISOString().split('T')[0];
        
        // Jika sudah melewati tengah malam (00:01 atau lebih) dan check-in dari hari kemarin
        if (checkInDateStr !== currentDateStr) {
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            // Auto checkin baru di 00:01
            if (currentHour === 0 && currentMinute >= 1) {
                console.log('Pergantian hari terdeteksi, melakukan auto checkin baru...');
                
                // Simpan session kemarin dengan checkout di 23:59:59
                const yesterdayEnd = new Date(checkInTime);
                yesterdayEnd.setHours(23, 59, 59, 999);
                
                // Hitung durasi untuk hari kemarin
                const durationYesterday = calculateDurationForPeriod(checkInTime, yesterdayEnd);
                
                // Update check-out untuk session kemarin
                if (currentSessionId) {
                    db.collection('attendance').doc(currentSessionId).update({
                        checkOut: firebase.firestore.Timestamp.fromDate(yesterdayEnd),
                        duration: durationYesterday,
                        status: 'completed',
                        autoCheckout: true,
                        note: 'Automatically closed due to day change'
                    }).then(() => {
                        console.log('Auto checkout berhasil untuk hari kemarin');
                        
                        // Langsung buat check-in baru untuk hari ini
                        createNewCheckInForToday();
                    }).catch(error => {
                        console.error('Error auto checkout:', error);
                        // Jika error, tetap buat check-in baru
                        createNewCheckInForToday();
                    });
                } else {
                    // Jika tidak ada session ID, langsung buat check-in baru
                    createNewCheckInForToday();
                }
            }
        }
    }

        // Fungsi untuk menghitung durasi untuk periode tertentu
        function calculateDurationForPeriod(startTime, endTime) {
            const diffMs = endTime - startTime;
            const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            return `${diffHrs}h ${diffMins}m`;
        }

    // Fungsi untuk membuat check-in baru untuk hari ini - DIPERBAIKI
    function createNewCheckInForToday() {
        const now = getWIBTime();
        
        db.collection('attendance').add({
            employeeId: currentUser.id,
            employeeName: currentUser.name,
            checkIn: firebase.firestore.Timestamp.fromDate(now),
            date: now.toISOString().split('T')[0],
            status: 'active',
            autoCheckin: true,
            note: 'Auto checkin by system at day change'
        }).then((docRef) => {
            currentSessionId = docRef.id;
            checkInTime = now;
            
            // Update UI
            updateStatusUI();
            timerInterval = setInterval(updateDuration, 60000);
            updateDuration();
            
            console.log('Auto checkin berhasil untuk hari ini');
            
            // Simpan ke localStorage
            saveStateToLocalStorage();
            
            // Tampilkan notifikasi
            showNotification('System telah melakukan auto checkin untuk pergantian hari', 'info');
        }).catch(error => {
            console.error('Error auto checkin:', error);
        });
    }

        // Fungsi untuk mendapatkan jam sekarang
        function getCurrentHour() {
            const now = getWIBTime();
            return now.getHours();
        }

        // Fungsi untuk memeriksa session yang belum checkout saat login
    // Fungsi untuk memeriksa session yang belum checkout saat login - DIPERBAIKI
    function checkUnclosedSessions() {
        if (!currentUser) return;
        
        const today = getWIBTime();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        const todayStr = today.toISOString().split('T')[0];
        
        // Cari session yang masih aktif dari kemarin
        db.collection('attendance')
            .where('employeeId', '==', currentUser.id)
            .where('date', '==', yesterdayStr)
            .where('status', '==', 'active')
            .get()
            .then(querySnapshot => {
                if (!querySnapshot.empty) {
                    console.log('Menemukan session aktif dari kemarin, melakukan auto checkout dan checkin...');
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const checkInTimeData = getTimestampData(data, 'checkIn');
                        
                        // Auto checkout untuk session kemarin di 23:59:59
                        const yesterdayEnd = new Date(checkInTimeData);
                        yesterdayEnd.setHours(23, 59, 59, 999);
                        const durationYesterday = calculateDurationForPeriod(checkInTimeData, yesterdayEnd);
                        
                        db.collection('attendance').doc(doc.id).update({
                            checkOut: firebase.firestore.Timestamp.fromDate(yesterdayEnd),
                            duration: durationYesterday,
                            status: 'completed',
                            autoCheckout: true,
                            note: 'Auto closed by system - unclosed session from yesterday'
                        }).then(() => {
                            console.log('Session kemarin telah di auto checkout');
                            
                            // Cek apakah sudah ada checkin untuk hari ini
                            db.collection('attendance')
                                .where('employeeId', '==', currentUser.id)
                                .where('date', '==', todayStr)
                                .where('status', '==', 'active')
                                .get()
                                .then(todayQuery => {
                                    if (todayQuery.empty) {
                                        // Buat check-in untuk hari ini
                                        createNewCheckInForToday();
                                    }
                                });
                        });
                    });
                }
            }).catch(error => {
                console.error('Error checking unclosed sessions:', error);
            });
    }

    // Mulai monitor pergantian hari - DIPERBAIKI
    function startDayChangeMonitor() {
        // Hentikan interval sebelumnya jika ada
        if (dayChangeInterval) {
            clearInterval(dayChangeInterval);
        }
        
        // Monitor setiap menit untuk deteksi pergantian hari
        dayChangeInterval = setInterval(() => {
            if (currentUser && checkInTime) {
                const now = getWIBTime();
                const checkInDateStr = checkInTime.toISOString().split('T')[0];
                const currentDateStr = now.toISOString().split('T')[0];
                
                // Jika tanggal berbeda (sudah lewat tengah malam)
                if (checkInDateStr !== currentDateStr) {
                    const currentHour = now.getHours();
                    const currentMinute = now.getMinutes();
                    
                    // Tunggu sampai 00:01 untuk auto checkin
                    if (currentHour === 0 && currentMinute === 1) {
                        handleDayChange();
                    }
                }
            }
        }, 60000); // Cek setiap menit
    }

        // ==================== REAL-TIME LISTENERS ====================

        // Fungsi untuk membersihkan semua listener - DIPERBAIKI LENGKAP
        function cleanupAllListeners() {
            Object.keys(activeListeners).forEach(key => {
                if (activeListeners[key]) {
                    // Clear semua timer dari semua element yang memiliki data-timer-id
                    if (key === 'activeEmployees' || key === 'todayCheckins') {
                        const timerElements = document.querySelectorAll('[data-timer-id]');
                        timerElements.forEach(element => {
                            const timerId = element.getAttribute('data-timer-id');
                            if (timerId) {
                                clearInterval(parseInt(timerId));
                            }
                        });
                    }
                    
                    activeListeners[key]();
                    activeListeners[key] = null;
                }
            });
        }

        // Setup real-time listener untuk today's check-ins - DIPERBAIKI
        function setupTodayCheckinsListener() {
            const today = getWIBTime().toISOString().split('T')[0];
            const todayCheckinsElement = document.getElementById('todayCheckins');
            
            // Hapus listener sebelumnya jika ada
            if (activeListeners.todayCheckins) {
                activeListeners.todayCheckins();
            }
            
            // Setup real-time listener
            activeListeners.todayCheckins = db.collection('attendance')
                .where('date', '==', today)
                .orderBy('checkIn', 'desc')
                .onSnapshot(querySnapshot => {
                    todayCheckinsElement.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        todayCheckinsElement.innerHTML = '<li>Tidak ada check-in hari ini</li>';
                        return;
                    }
                    
                    // Array untuk menyimpan interval timer
                    const checkinTimers = [];
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const checkInTime = getTimestampData(data, 'checkIn');
                        const checkOutTime = getTimestampData(data, 'checkOut');
                        
                        const listItem = document.createElement('li');
                        listItem.className = 'attendance-item';
                        listItem.id = `checkin-${doc.id}`;
                        
                        if (checkInTime) {
                            if (checkOutTime) {
                                // Sudah check-out, tampilkan waktu tetap
                                listItem.innerHTML = `
                                    <span>${data.employeeName}</span>
                                    <span class="attendance-time">${formatTime(checkInTime)} - ${formatTime(checkOutTime)}</span>
                                `;
                            } else {
                                // Masih aktif, buat timer real-time
                                listItem.innerHTML = `
                                    <span>${data.employeeName}</span>
                                    <span class="attendance-time active-employee">${formatTime(checkInTime)} - Active (<span class="duration-timer">0h 0m 0s</span>)</span>
                                `;
                                
                                // Fungsi untuk update timer
                                function updateCheckinTimer() {
                                    const now = getWIBTime();
                                    const diffMs = now - checkInTime;
                                    const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
                                    const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                                    const diffSecs = Math.floor((diffMs % (1000 * 60)) / 1000);
                                    
                                    const timerSpan = listItem.querySelector('.duration-timer');
                                    if (timerSpan) {
                                        timerSpan.textContent = `${diffHrs}h ${diffMins}m ${diffSecs}s`;
                                    }
                                }
                                
                                // Update awal
                                updateCheckinTimer();
                                
                                // Buat timer
                                const timerId = setInterval(updateCheckinTimer, 1000);
                                checkinTimers.push({
                                    elementId: `checkin-${doc.id}`,
                                    timerId: timerId
                                });
                                
                                listItem.setAttribute('data-timer-id', timerId);
                            }
                            todayCheckinsElement.appendChild(listItem);
                        }
                    });
                    
                    // Clear semua timer saat listener di-destroy
                    return () => {
                        checkinTimers.forEach(timer => {
                            clearInterval(timer.timerId);
                        });
                    };
                }, error => {
                    console.error('Error listening to today check-ins:', error);
                    todayCheckinsElement.innerHTML = '<li>Error loading data</li>';
                });
        }

        // Setup real-time listener untuk active employees - DIPERBAIKI
        function setupActiveEmployeesListener() {
            const activeEmployeesElement = document.getElementById('activeEmployees');
            
            // Hapus listener sebelumnya jika ada
            if (activeListeners.activeEmployees) {
                activeListeners.activeEmployees();
            }
            
            // Setup real-time listener
            activeListeners.activeEmployees = db.collection('attendance')
                .where('status', '==', 'active')
                .onSnapshot(querySnapshot => {
                    activeEmployeesElement.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        activeEmployeesElement.innerHTML = '<p>There are no active employees</p>';
                        return;
                    }
                    
                    // Array untuk menyimpan interval timer
                    const activeTimers = [];
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const checkInTime = getTimestampData(data, 'checkIn');
                        
                        if (checkInTime) {
                            const employeeDiv = document.createElement('div');
                            employeeDiv.className = 'attendance-item active-employee';
                            employeeDiv.id = `active-employee-${doc.id}`;
                            
                            // Fungsi untuk update durasi real-time
                            function updateActiveEmployeeDuration() {
                                const now = getWIBTime();
                                const diffMs = now - checkInTime;
                                const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
                                const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                                const diffSecs = Math.floor((diffMs % (1000 * 60)) / 1000);
                                
                                const durationSpan = employeeDiv.querySelector('.attendance-time');
                                if (durationSpan) {
                                    durationSpan.textContent = `${diffHrs}h ${diffMins}m ${diffSecs}s`;
                                }
                            }
                            
                            // Update awal
                            updateActiveEmployeeDuration();
                            
                            // Buat timer untuk update real-time
                            const timerId = setInterval(updateActiveEmployeeDuration, 1000);
                            activeTimers.push({
                                elementId: `active-employee-${doc.id}`,
                                timerId: timerId
                            });
                            
                            // Simpan timer di element untuk bisa di-clear nanti
                            employeeDiv.setAttribute('data-timer-id', timerId);
                            
                            employeeDiv.innerHTML = `
                                <span>${data.employeeName}</span>
                                <span class="attendance-time">${calculateDuration(checkInTime)}</span>
                            `;
                            activeEmployeesElement.appendChild(employeeDiv);
                        }
                    });
                    
                    // Clear semua timer saat listener di-destroy
                    return () => {
                        activeTimers.forEach(timer => {
                            clearInterval(timer.timerId);
                        });
                    };
                }, error => {
                    console.error('Error listening to active employees:', error);
                    activeEmployeesElement.innerHTML = '<p>Error loading data</p>';
                });
        }

        // Setup real-time listener untuk attendance history
        function setupAttendanceHistoryListener() {
            const historyElement = document.getElementById('attendanceHistory');
            
            if (!currentUser) return;
            
            // Hapus listener sebelumnya jika ada
            if (activeListeners.attendanceHistory) {
                activeListeners.attendanceHistory();
            }
            
            // Setup real-time listener
            activeListeners.attendanceHistory = db.collection('attendance')
                .where('employeeId', '==', currentUser.id)
                .orderBy('checkIn', 'desc')
                .limit(5)
                .onSnapshot(querySnapshot => {
                    historyElement.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        historyElement.innerHTML = '<li>Tidak ada riwayat</li>';
                        return;
                    }
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const checkInTime = getTimestampData(data, 'checkIn');
                        const checkOutTime = getTimestampData(data, 'checkOut');
                        
                        if (checkInTime) {
                            const listItem = document.createElement('li');
                            listItem.className = 'attendance-item';
                            
                            if (checkOutTime) {
                                listItem.innerHTML = `
                                    <span>${formatDate(checkInTime)}</span>
                                    <span class="attendance-time">${formatTime(checkInTime)} - ${formatTime(checkOutTime)}</span>
                                `;
                            } else {
                                listItem.innerHTML = `
                                    <span>${formatDate(checkInTime)}</span>
                                    <span class="attendance-time active-employee">${formatTime(checkInTime)} - Active</span>
                                `;
                            }
                            
                            historyElement.appendChild(listItem);
                        }
                    });
                }, error => {
                    console.error('Error listening to attendance history:', error);
                    historyElement.innerHTML = '<li>Error loading data</li>';
                });
        }

// Setup real-time listener untuk current status - DENGAN PENGHORMATAN FLAG
function setupCurrentStatusListener() {
    if (!currentUser || isCheckingIn) {
        console.log('Skipping status listener - checking in or no user');
        return;
    }
    
    // Hapus listener sebelumnya jika ada
    if (activeListeners.currentStatus) {
        activeListeners.currentStatus();
    }
    
    console.log('Setting up current status listener for:', currentUser.name);
    
    // Setup real-time listener untuk status aktif user saat ini
    activeListeners.currentStatus = db.collection('attendance')
        .where('employeeId', '==', currentUser.id)
        .where('status', '==', 'active')
        .orderBy('checkIn', 'desc')
        .limit(1)
        .onSnapshot(querySnapshot => {
            // Skip jika sedang dalam proses check-in
            if (isCheckingIn) {
                console.log('Listener ignored - checking in process');
                return;
            }
            
            console.log('Current status snapshot:', querySnapshot.size, 'active sessions');
            
            if (querySnapshot.empty) {
                // Tidak ada session aktif di Firebase
                if (checkInTime) {
                    console.log('Session aktif di local tapi tidak di Firebase');
                    
                    // Tunggu 3 detik sebelum reset, mungkin ada delay sync
                    setTimeout(() => {
                        if (isCheckingIn) return; // Skip jika sedang check-in
                        
                        db.collection('attendance')
                            .where('employeeId', '==', currentUser.id)
                            .where('status', '==', 'active')
                            .get()
                            .then(recheckSnapshot => {
                                if (recheckSnapshot.empty && !isCheckingIn) {
                                    // Benar-benar tidak ada session aktif
                                    console.log('Confirmed: no active sessions');
                                    
                                    checkInTime = null;
                                    currentSessionId = null;
                                    clearInterval(timerInterval);
                                    updateStatusUI();
                                    clearStateFromLocalStorage();
                                    
                                    showNotification('Session telah berakhir', 'info');
                                }
                            });
                    }, 3000);
                }
            } else {
                // Ada session aktif di Firebase
                const doc = querySnapshot.docs[0];
                const data = doc.data();
                const checkInTimeData = getTimestampData(data, 'checkIn');
                
                if (checkInTimeData && !isCheckingIn) {
                    // Update state jika berbeda atau belum ada
                    if (!checkInTime || checkInTime.getTime() !== checkInTimeData.getTime()) {
                        console.log('Updating local state with session:', doc.id);
                        
                        checkInTime = checkInTimeData;
                        currentSessionId = doc.id;
                        
                        // Update localStorage
                        saveStateToLocalStorage();
                        
                        updateStatusUI();
                        
                        // Hentikan timer lama dan mulai yang baru
                        clearInterval(timerInterval);
                        timerInterval = setInterval(updateDuration, 1000);
                        updateDuration();
                    }
                }
            }
        }, error => {
            console.error('Error listening to current status:', error);
        });
}


// Fungsi untuk debug checkout
function debugCheckout() {
    console.log('=== CHECKOUT DEBUG ===');
    console.log('Current User:', currentUser?.name);
    console.log('CheckIn Time:', checkInTime ? formatTime(checkInTime) : 'null');
    console.log('Current Session ID:', currentSessionId);
    console.log('LocalStorage Checkin Data:', localStorage.getItem(STORAGE_KEYS.CHECKIN_DATA));
    
    if (currentUser) {
        // Cek semua session aktif di Firebase
        db.collection('attendance')
            .where('employeeId', '==', currentUser.id)
            .where('status', '==', 'active')
            .get()
            .then(snapshot => {
                console.log('Active sessions in Firebase:', snapshot.size);
                snapshot.forEach(doc => {
                    const data = doc.data();
                    console.log(`- ${doc.id}: ${formatTime(getTimestampData(data, 'checkIn'))}`);
                });
            });
    }
    console.log('=== END DEBUG ===');
}

// Tambahkan tombol debug di console
window.debugCheckout = debugCheckout;

// Helper function untuk membuat session baru
function createNewSession(wibTime) {
    return db.collection('attendance').add({
        employeeId: currentUser.id,
        employeeName: currentUser.name,
        checkIn: firebase.firestore.Timestamp.fromDate(wibTime),
        date: wibTime.toISOString().split('T')[0],
        status: 'active',
        browserClosed: false
    }).then((docRef) => {
        currentSessionId = docRef.id;
        checkInTime = wibTime;
        
        // Simpan ke localStorage
        saveStateToLocalStorage();
        
        // Update UI
        updateStatusUI();
        timerInterval = setInterval(updateDuration, 1000);
        updateDuration();
        
        return docRef;
    });
}

// ==================== FORCE CHECKOUT SYSTEM ====================

// Variabel untuk force checkout
let selectedForceCheckoutOption = null;

// Setup force checkout button
function setupForceCheckoutButton() {
    const forceCheckoutBtn = document.getElementById('forceCheckoutBtn');
    const forceCheckoutModal = document.getElementById('forceCheckoutModal');
    const forceCheckoutCancel = document.getElementById('forceCheckoutCancel');
    const forceCheckoutConfirm = document.getElementById('forceCheckoutConfirm');
    const forceCheckoutOptions = document.querySelectorAll('.force-checkout-option');
    
    // Tampilkan/sembunyikan button berdasarkan role
    function updateForceCheckoutButtonVisibility() {
        if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'boss')) {
            forceCheckoutBtn.classList.remove('hidden');
        } else {
            forceCheckoutBtn.classList.add('hidden');
        }
    }
    
    // Show force checkout modal
    forceCheckoutBtn.addEventListener('click', function() {
        if (!currentUser) return;
        
        // Update info di modal
        document.getElementById('forceCheckoutEmployeeName').textContent = currentUser.name;
        document.getElementById('forceCheckoutStatus').textContent = checkInTime ? 'Sedang Check-in' : 'Check-out';
        
        // Reset selected option
        selectedForceCheckoutOption = null;
        forceCheckoutOptions.forEach(opt => opt.classList.remove('selected'));
        updateForceCheckoutNote();
        
        forceCheckoutModal.classList.remove('hidden');
    });
    
    // Pilih opsi force checkout
    forceCheckoutOptions.forEach(option => {
        option.addEventListener('click', function() {
            forceCheckoutOptions.forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            selectedForceCheckoutOption = this.getAttribute('data-option');
            updateForceCheckoutNote();
        });
    });
    
    // Update catatan berdasarkan opsi yang dipilih
    function updateForceCheckoutNote() {
        const noteElement = document.getElementById('forceCheckoutNote');
        
        if (!selectedForceCheckoutOption) {
            noteElement.innerHTML = 'Pilih salah satu opsi di atas';
            return;
        }
        
        let note = '';
        switch(selectedForceCheckoutOption) {
            case 'current':
                note = `‚Ä¢ Akan menutup session aktif Anda<br>‚Ä¢ Durasi akan dihitung sampai waktu sekarang<br>‚Ä¢ Anda bisa check-in kembali setelahnya`;
                break;
            case 'all':
                note = `‚Ä¢ Akan menutup SEMUA session aktif Anda<br>‚Ä¢ Berguna jika ada multiple session<br>‚Ä¢ Semua akan tercatat sebagai "force checkout"`;
                break;
            case 'clear':
                note = `‚Ä¢ Akan membersihkan localStorage<br>‚Ä¢ Reset semua state aplikasi<br>‚Ä¢ Anda perlu login ulang setelahnya`;
                break;
        }
        
        noteElement.innerHTML = note;
    }
    
    // Cancel force checkout
    forceCheckoutCancel.addEventListener('click', function() {
        forceCheckoutModal.classList.add('hidden');
        selectedForceCheckoutOption = null;
    });
    
    // Confirm force checkout
    forceCheckoutConfirm.addEventListener('click', async function() {
        if (!selectedForceCheckoutOption || !currentUser) {
            showNotification('Pilih opsi terlebih dahulu', 'error');
            return;
        }
        
        if (!confirm(`Anda yakin ingin melakukan force checkout dengan opsi: ${selectedForceCheckoutOption.toUpperCase()}?`)) {
            return;
        }
        
        try {
            let message = '';
            
            switch(selectedForceCheckoutOption) {
                case 'current':
                    message = await forceCheckoutCurrentSession();
                    break;
                case 'all':
                    message = await forceCheckoutAllSessions();
                    break;
                case 'clear':
                    message = await forceClearAndReset();
                    break;
            }
            
            showNotification(message, 'success');
            forceCheckoutModal.classList.add('hidden');
            selectedForceCheckoutOption = null;
            
        } catch (error) {
            console.error('Error force checkout:', error);
            showNotification('Gagal melakukan force checkout: ' + error.message, 'error');
        }
    });
    
    // Update button visibility saat user login
    if (currentUser) {
        updateForceCheckoutButtonVisibility();
    }
    
    return updateForceCheckoutButtonVisibility;
}

// Force checkout session saat ini
async function forceCheckoutCurrentSession() {
    if (!currentUser || !checkInTime || !currentSessionId) {
        throw new Error('Tidak ada session aktif');
    }
    
    const now = getWIBTime();
    const duration = calculateDuration(checkInTime);
    
    await db.collection('attendance').doc(currentSessionId).update({
        checkOut: firebase.firestore.Timestamp.fromDate(now),
        duration: duration,
        status: 'completed',
        forceCheckout: true,
        note: 'Force closed by user via force checkout system'
    });
    
    // Update local state
    checkInTime = null;
    currentSessionId = null;
    isCheckingIn = false; // ‚Üê TAMBAHKAN INI
    clearInterval(timerInterval);
    clearStateFromLocalStorage();
    updateStatusUI();
    
    document.getElementById('checkinBtn').disabled = false;
    document.getElementById('checkinBtn').textContent = 'Check In';

    return 'Session berhasil di force checkout';
}

// Force checkout semua session aktif
async function forceCheckoutAllSessions() {
    if (!currentUser) {
        throw new Error('User tidak ditemukan');
    }
    
    const now = getWIBTime();
    const querySnapshot = await db.collection('attendance')
        .where('employeeId', '==', currentUser.id)
        .where('status', '==', 'active')
        .get();
    
    if (querySnapshot.empty) {
        throw new Error('Tidak ada session aktif ditemukan');
    }
    
    const promises = [];
    querySnapshot.forEach(doc => {
        const data = doc.data();
        const checkInTimeData = getTimestampData(data, 'checkIn');
        
        if (checkInTimeData) {
            const duration = calculateDurationForPeriod(checkInTimeData, now);
            
            promises.push(
                db.collection('attendance').doc(doc.id).update({
                    checkOut: firebase.firestore.Timestamp.fromDate(now),
                    duration: duration,
                    status: 'completed',
                    forceCheckout: true,
                    note: 'Force closed all sessions by user'
                })
            );
        }
    });
    
    await Promise.all(promises);
    
    // Update local state
    checkInTime = null;
    currentSessionId = null;
    clearInterval(timerInterval);
    clearStateFromLocalStorage();
    updateStatusUI();
    
    return `${promises.length} session berhasil di force checkout`;
}

// Clear dan reset semua
async function forceClearAndReset() {
    if (!currentUser) {
        throw new Error('User tidak ditemukan');
    }
    
    // Tutup semua session aktif terlebih dahulu
    try {
        await forceCheckoutAllSessions();
    } catch (error) {
        // Ignore jika tidak ada session aktif
    }
    
    // Bersihkan localStorage
    clearStateFromLocalStorage();
    
    // Reset semua state
    currentUser = null;
    checkInTime = null;
    currentSessionId = null;
    clearInterval(timerInterval);
    
    // Kembali ke login
    cleanupAllListeners();
    showLoginPopup();
    
    return 'System berhasil direset. Silakan login ulang.';
}

// Fungsi untuk memastikan hanya ada satu session aktif per user - DIPERBAIKI
function ensureSingleActiveSession() {
    if (!currentUser) return;
    
    console.log('Checking for multiple active sessions...');
    
    db.collection('attendance')
        .where('employeeId', '==', currentUser.id)
        .where('status', '==', 'active')
        .orderBy('checkIn', 'desc')
        .get()
        .then(querySnapshot => {
            if (querySnapshot.size > 1) {
                console.log(`User ${currentUser.name} memiliki ${querySnapshot.size} session aktif`);
                
                const sessions = [];
                querySnapshot.forEach(doc => {
                    sessions.push({
                        id: doc.id,
                        data: doc.data(),
                        checkIn: getTimestampData(doc.data(), 'checkIn')
                    });
                });
                
                // Sort by check-in time (terbaru ke terlama)
                sessions.sort((a, b) => b.checkIn - a.checkIn);
                
                // Ambil session terbaru
                const latestSession = sessions[0];
                
                // Update state dengan session terbaru
                if (latestSession) {
                    // Hanya update jika berbeda dengan current state
                    if (!currentSessionId || currentSessionId !== latestSession.id) {
                        console.log('Switching to latest session:', latestSession.id);
                        
                        // Update local state
                        checkInTime = latestSession.checkIn;
                        currentSessionId = latestSession.id;
                        
                        // Save to localStorage
                        saveStateToLocalStorage();
                        
                        // Update UI
                        updateStatusUI();
                        
                        // Hentikan timer lama dan mulai yang baru
                        clearInterval(timerInterval);
                        timerInterval = setInterval(updateDuration, 1000);
                        updateDuration();
                        
                        showNotification('System switched to your latest session', 'info');
                    }
                    
                    // TUTUP SEMUA SESSION LAIN KECUALI YANG TERBARU
                    const otherSessions = sessions.slice(1);
                    const now = getWIBTime();
                    
                    otherSessions.forEach(session => {
                        const duration = calculateDurationForPeriod(session.checkIn, now);
                        
                        db.collection('attendance').doc(session.id).update({
                            checkOut: firebase.firestore.Timestamp.fromDate(now),
                            duration: duration,
                            status: 'completed',
                            autoCheckout: true,
                            note: 'Auto closed - multiple active sessions detected'
                        }).then(() => {
                            console.log(`Session ${session.id} ditutup (multiple session cleanup)`);
                        });
                    });
                }
            }
        }).catch(error => {
            console.error('Error checking multiple sessions:', error);
        });
}

        function checkAndCleanMultipleSessions() {
            // Hanya jalankan jika user sedang check-in
            if (currentUser && checkInTime) {
                ensureSingleActiveSession();
            }
        }


        // Setup real-time listener untuk full history
        function setupFullHistoryListener() {
            const fullHistoryElement = document.getElementById('fullHistory');
            
            if (!currentUser) return;
            
            // Hapus listener sebelumnya jika ada
            if (activeListeners.fullHistory) {
                activeListeners.fullHistory();
            }
            
            // Setup real-time listener
            activeListeners.fullHistory = db.collection('attendance')
                .where('employeeId', '==', currentUser.id)
                .orderBy('checkIn', 'desc')
                .onSnapshot(querySnapshot => {
                    fullHistoryElement.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        fullHistoryElement.innerHTML = '<p>Tidak ada riwayat absensi</p>';
                        return;
                    }
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const checkInTime = getTimestampData(data, 'checkIn');
                        const checkOutTime = getTimestampData(data, 'checkOut');
                        
                        if (checkInTime) {
                            const historyItem = document.createElement('div');
                            historyItem.className = 'attendance-item';
                            
                            if (checkOutTime) {
                                historyItem.innerHTML = `
                                    <div>
                                        <strong>${formatDate(checkInTime)}</strong>
                                        <div class="attendance-time">${formatTime(checkInTime)} - ${formatTime(checkOutTime)}</div>
                                    </div>
                                    <div>${data.duration || calculateDuration(checkInTime)}</div>
                                `;
                            } else {
                                historyItem.innerHTML = `
                                    <div>
                                        <strong>${formatDate(checkInTime)}</strong>
                                        <div class="attendance-time active-employee">${formatTime(checkInTime)} - Active</div>
                                    </div>
                                    <div class="active-employee">Sedang aktif</div>
                                `;
                            }
                            
                            fullHistoryElement.appendChild(historyItem);
                        }
                    });
                }, error => {
                    console.error('Error listening to full history:', error);
                    fullHistoryElement.innerHTML = '<p>Error loading data</p>';
                });
        }

        // Setup real-time listener untuk all employees (boss view)
        function setupAllEmployeesListener() {
            const allEmployeesElement = document.getElementById('allEmployees');
            
            // Hapus listener sebelumnya jika ada
            if (activeListeners.allEmployees) {
                activeListeners.allEmployees();
            }
            
            const { start, end } = getWeekDates();
            
            // Setup real-time listener
            activeListeners.allEmployees = db.collection('attendance')
                .where('checkIn', '>=', start)
                .where('checkIn', '<=', end)
                .onSnapshot(querySnapshot => {
                    allEmployeesElement.innerHTML = '';
                    
                    // Buat peta untuk menyimpan jam kerja per karyawan
                    const employeeHoursMap = new Map();
                    
                    // Hitung jam kerja untuk setiap karyawan
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.checkOut) {
                            const checkInTime = getTimestampData(data, 'checkIn');
                            const checkOutTime = getTimestampData(data, 'checkOut');
                            
                            if (checkInTime && checkOutTime) {
                                const diffMs = checkOutTime - checkInTime;
                                const diffHours = diffMs / (1000 * 60 * 60);
                                
                                if (!employeeHoursMap.has(data.employeeId)) {
                                    employeeHoursMap.set(data.employeeId, {
                                        name: data.employeeName,
                                        totalHours: 0
                                    });
                                }
                                
                                const employeeData = employeeHoursMap.get(data.employeeId);
                                employeeData.totalHours += diffHours;
                            }
                        }
                    });
                    
                    // Tampilkan semua karyawan
                    employees.forEach(employee => {
                        if (employee.role !== 'admin') {
                            const employeeCard = document.createElement('div');
                            employeeCard.className = 'employee-card';
                            
                            // Dapatkan jam kerja dari map atau default 0
                            const hoursData = employeeHoursMap.get(employee.id) || { totalHours: 0 };
                            const hours = hoursData.totalHours;
                            
                            let warningHtml = '';
                            if (hours < 21) {
                                warningHtml = `<div class="hours-warning">${hours.toFixed(1)} jam (kurang dari 21 jam)</div>`;
                            }
                            
                            employeeCard.innerHTML = `
                                <div class="employee-name">${employee.name}</div>
                                <div class="employee-position">${employee.position}</div>
                                ${warningHtml}
                            `;
                            
                            employeeCard.addEventListener('click', function() {
                                showEmployeeDetail(employee);
                            });
                            
                            allEmployeesElement.appendChild(employeeCard);
                        }
                    });
                }, error => {
                    console.error('Error listening to all employees:', error);
                    allEmployeesElement.innerHTML = '<div class="no-data">Error loading employee data</div>';
                });
        }

        // Setup real-time listener untuk weekly overview
        function setupWeeklyOverviewListener() {
            const overviewElement = document.getElementById('weeklyOverview');
            
            // Hapus listener sebelumnya jika ada
            if (activeListeners.weeklyOverview) {
                activeListeners.weeklyOverview();
            }
            
            const { start, end } = getWeekDates();
            
            // Setup real-time listener
            activeListeners.weeklyOverview = db.collection('attendance')
                .where('checkIn', '>=', start)
                .where('checkIn', '<=', end)
                .onSnapshot(querySnapshot => {
                    const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];
                    const weekView = document.createElement('div');
                    weekView.className = 'week-view';
                    
                    const today = getWIBTime();
                    const startOfWeek = getStartOfWeek(today);
                    
                    // Buat array untuk menyimpan jam per hari
                    const dayHours = new Array(7).fill(0);
                    
                    // Hitung jam untuk setiap hari
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.checkOut) {
                            const checkInTime = getTimestampData(data, 'checkIn');
                            const checkOutTime = getTimestampData(data, 'checkOut');
                            
                            if (checkInTime && checkOutTime) {
                                const dayIndex = (checkInTime.getDay() + 6) % 7; // Konversi ke Senin-Minggu
                                const diffMs = checkOutTime - checkInTime;
                                const diffHours = diffMs / (1000 * 60 * 60);
                                
                                if (dayIndex >= 0 && dayIndex < 7) {
                                    dayHours[dayIndex] += diffHours;
                                }
                            }
                        }
                    });
                    
                    // Buat card untuk setiap hari
                    for (let i = 0; i < 7; i++) {
                        const day = new Date(startOfWeek);
                        day.setDate(startOfWeek.getDate() + i);
                        
                        const dayCard = document.createElement('div');
                        dayCard.className = 'day-card';
                        
                        const hours = dayHours[i];
                        let hoursClass = '';
                        if (hours < 3) {
                            hoursClass = 'low-hours';
                        } else {
                            hoursClass = 'good-hours';
                        }
                        
                        dayCard.innerHTML = `
                            <div class="day-name">${days[i]}</div>
                            <div class="day-hours ${hoursClass}">${hours.toFixed(1)} jam</div>
                        `;
                        
                        weekView.appendChild(dayCard);
                    }
                    
                    overviewElement.innerHTML = '';
                    overviewElement.appendChild(weekView);
                }, error => {
                    console.error('Error listening to weekly overview:', error);
                    overviewElement.innerHTML = '<div class="no-data">Error loading weekly data</div>';
                });
        }

        // Setup semua real-time listeners
        function setupAllRealTimeListeners() {
            setupTodayCheckinsListener();
            setupActiveEmployeesListener();
            setupAttendanceHistoryListener();
            setupCurrentStatusListener();
            
            if (currentUser.role === 'boss' || currentUser.role === 'admin') {
                setupAllEmployeesListener();
                setupWeeklyOverviewListener();
            }
        }

        // ==================== NOTIFICATION SYSTEM ====================

        // Fungsi untuk menampilkan notifikasi
        function showNotification(message, type = 'info') {
            // Buat elemen notifikasi
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            let icon = '‚ÑπÔ∏è';
            if (type === 'success') icon = '‚úÖ';
            if (type === 'warning') icon = '‚ö†Ô∏è';
            if (type === 'error') icon = '‚ùå';
            
            notification.innerHTML = `
                <span class="notification-icon">${icon}</span>
                <div class="notification-content">
                    <div class="notification-title">System Notification</div>
                    <div>${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Hapus notifikasi setelah 5 detik
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        // ==================== EVENT HANDLERS ====================

        // Toggle password visibility
        document.getElementById('togglePassword').addEventListener('click', function() {
            const passwordInput = document.getElementById('passwordInput');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üîí';
        });

        // Login
        document.getElementById('loginBtn').addEventListener('click', function() {
            const employeeSelect = document.getElementById('employeeSelect');
            const selectedEmployeeId = parseInt(employeeSelect.value);
            
            if (!selectedEmployeeId) {
                alert('Pilih karyawan terlebih dahulu!');
                return;
            }
            
            const employee = employees.find(emp => emp.id === selectedEmployeeId);
            if (employee) {
                // Cek apakah karyawan memerlukan password
                if (employee.role === 'boss' || employee.role === 'admin') {
                    // Tampilkan modal password
                    pendingEmployee = employee;
                    showPasswordModal(employee);
                } else {
                    // Login langsung untuk employee biasa
                    currentUser = employee;
                    showDashboard();
                }
            }
        });

        // Fungsi submit password - menggunakan EMPLOYEE_PASSWORDS dari config.js
        document.getElementById('submitPassword').addEventListener('click', function() {
            const passwordInput = document.getElementById('passwordInput');
            const password = passwordInput.value;
            
            if (!password) {
                alert('Masukkan password terlebih dahulu!');
                return;
            }
            
            if (pendingEmployee) {
                const correctPassword = EMPLOYEE_PASSWORDS[pendingEmployee.name];
                
                if (password === correctPassword) {
                    // Password benar
                    currentUser = pendingEmployee;
                    pendingEmployee = null;
                    passwordInput.value = '';
                    document.getElementById('passwordModal').classList.add('hidden');
                    showDashboard();
                    showNotification('Login berhasil!', 'success');
                } else {
                    alert('Password salah! Silakan coba lagi.');
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            }
        });

        // Cancel password
        document.getElementById('cancelPassword').addEventListener('click', function() {
            pendingEmployee = null;
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordModal').classList.add('hidden');
        });

        // Update fungsi logout untuk menyembunyikan force checkout button
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (checkInTime) {
                if (!confirm('Anda masih dalam keadaan check in. Yakin ingin logout?')) {
                    return;
                }
            }
            
                // Reset semua flag dan state
            isCheckingIn = false;

            // Bersihkan semua listener
            cleanupAllListeners();
            
            currentUser = null;
            checkInTime = null;
            currentSessionId = null;
            clearInterval(timerInterval);
            
            // Hentikan monitor pergantian hari
            if (dayChangeInterval) {
                clearInterval(dayChangeInterval);
                dayChangeInterval = null;
            }
            
            // Clear localStorage
            clearStateFromLocalStorage();
            
            // Sembunyikan force checkout button
            document.getElementById('forceCheckoutBtn').classList.add('hidden');
            document.getElementById('forceCheckoutModal').classList.add('hidden');
            
            showLoginPopup();
            showNotification('Anda telah logout dari sistem', 'info');
        });

        // Untuk admin, tambahkan opsi force checkout di employee detail
function setupAdminForceCheckout() {
    // Modifikasi fungsi showEmployeeDetail untuk admin
    const originalShowEmployeeDetail = showEmployeeDetail;
    showEmployeeDetail = function(employee) {
        originalShowEmployeeDetail.call(this, employee);
        
        // Jika user adalah admin/boss, tambahkan tombol force checkout di modal
        if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'boss')) {
            addForceCheckoutToEmployeeModal(employee);
        }
    };
}

// Tambahkan tombol force checkout di modal employee detail
function addForceCheckoutToEmployeeModal(employee) {
    const employeeDetailInfo = document.getElementById('employeeDetailInfo');
    
    // Cek apakah sudah ada tombol force checkout
    if (employeeDetailInfo.querySelector('.employee-force-checkout-btn')) {
        return;
    }
    
    const forceCheckoutBtn = document.createElement('button');
    forceCheckoutBtn.className = 'employee-force-checkout-btn';
    forceCheckoutBtn.innerHTML = 'üîß Force Checkout Karyawan Ini';
    forceCheckoutBtn.style.cssText = `
        margin-top: 10px;
        background: linear-gradient(135deg, #ff4757, #ff3838);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
    `;
    
    forceCheckoutBtn.addEventListener('click', async function() {
        if (!confirm(`Force checkout untuk ${employee.name}?`)) {
            return;
        }
        
        try {
            const now = getWIBTime();
            const querySnapshot = await db.collection('attendance')
                .where('employeeId', '==', employee.id)
                .where('status', '==', 'active')
                .get();
            
            if (querySnapshot.empty) {
                showNotification(`${employee.name} tidak memiliki session aktif`, 'info');
                return;
            }
            
            const promises = [];
            querySnapshot.forEach(doc => {
                const data = doc.data();
                const checkInTimeData = getTimestampData(data, 'checkIn');
                
                if (checkInTimeData) {
                    const duration = calculateDurationForPeriod(checkInTimeData, now);
                    
                    promises.push(
                        db.collection('attendance').doc(doc.id).update({
                            checkOut: firebase.firestore.Timestamp.fromDate(now),
                            duration: duration,
                            status: 'completed',
                            forceCheckout: true,
                            note: `Force closed by admin: ${currentUser.name}`
                        })
                    );
                }
            });
            
            await Promise.all(promises);
            showNotification(`${promises.length} session untuk ${employee.name} berhasil di force checkout`, 'success');
            
        } catch (error) {
            console.error('Error force checkout employee:', error);
            showNotification('Gagal force checkout: ' + error.message, 'error');
        }
    });
    
    employeeDetailInfo.appendChild(forceCheckoutBtn);
}

// Check In - DENGAN FLAG
document.getElementById('checkinBtn').addEventListener('click', async function() {
    if (!currentUser || isCheckingIn) return;
    
    // Set flag untuk mencegah konflik
    isCheckingIn = true;
    const checkinBtn = this;
    checkinBtn.disabled = true;
    checkinBtn.textContent = 'Checking in...';
    
    const wibTime = getWIBTime();
    
    try {
        // Hentikan current status listener sementara
        if (activeListeners.currentStatus) {
            activeListeners.currentStatus();
            activeListeners.currentStatus = null;
        }
        
        // Cek session aktif di Firebase
        const existingSessions = await db.collection('attendance')
            .where('employeeId', '==', currentUser.id)
            .where('status', '==', 'active')
            .get();
        
        if (existingSessions.size > 0) {
            // Ada session aktif, tanya user
            if (!confirm('Anda sudah memiliki session aktif. Buat session baru?')) {
                // Reset flag dan enable button
                isCheckingIn = false;
                checkinBtn.disabled = false;
                checkinBtn.textContent = 'Check In';
                setupCurrentStatusListener();
                return;
            }
            
            // Tutup semua session aktif sebelumnya
            const now = getWIBTime();
            const closePromises = [];
            
            existingSessions.forEach(doc => {
                const data = doc.data();
                const oldCheckIn = getTimestampData(data, 'checkIn');
                const duration = calculateDurationForPeriod(oldCheckIn, now);
                
                closePromises.push(
                    db.collection('attendance').doc(doc.id).update({
                        checkOut: firebase.firestore.Timestamp.fromDate(now),
                        duration: duration,
                        status: 'completed',
                        autoCheckout: true,
                        note: 'Auto closed due to new check-in'
                    })
                );
            });
            
            await Promise.all(closePromises);
            console.log('Semua session lama ditutup');
        }
        
        // Buat session baru
        const docRef = await db.collection('attendance').add({
            employeeId: currentUser.id,
            employeeName: currentUser.name,
            checkIn: firebase.firestore.Timestamp.fromDate(wibTime),
            date: wibTime.toISOString().split('T')[0],
            status: 'active',
            browserClosed: false
        });
        
        currentSessionId = docRef.id;
        checkInTime = wibTime;
        
        // Simpan ke localStorage
        saveStateToLocalStorage();
        
        // Update UI
        updateStatusUI();
        
        // Hentikan timer lama dan mulai yang baru
        clearInterval(timerInterval);
        timerInterval = setInterval(updateDuration, 1000);
        updateDuration();
        
        // Setup ulang listener setelah 2 detik
        setTimeout(() => {
            setupCurrentStatusListener();
        }, 2000);
        
        showNotification('Check-in berhasil!', 'success');
        
    } catch (error) {
        console.error('Error in check-in process:', error);
        showNotification('Gagal melakukan check-in. Silakan coba lagi.', 'error');
        
        // Setup ulang listener jika error
        setupCurrentStatusListener();
    } finally {
        // Reset flag dan enable button (dijalankan baik success maupun error)
        isCheckingIn = false;
        checkinBtn.disabled = false;
        checkinBtn.textContent = 'Check In';
    }
});


// Check Out - DIPERBAIKI LAGI
document.getElementById('checkoutBtn').addEventListener('click', function() {
    if (!currentUser || !checkInTime || !currentSessionId) return;
    
    const wibTime = getWIBTime();
    const duration = calculateDuration(checkInTime);
    
    console.log('Checkout initiated:', {
        employee: currentUser.name,
        sessionId: currentSessionId,
        checkInTime: formatTime(checkInTime),
        duration: duration
    });
    
    // Update di Firebase
    db.collection('attendance').doc(currentSessionId).update({
        checkOut: firebase.firestore.Timestamp.fromDate(wibTime),
        duration: duration,
        status: 'completed',
        browserClosed: false
    }).then(() => {
        console.log('Checkout successful in Firebase');
        
        // Update local state
        checkInTime = null;
        currentSessionId = null;
        clearInterval(timerInterval);
        
        // Clear dari localStorage
        clearStateFromLocalStorage();
        
        // Hentikan real-time listener untuk status saat ini
        if (activeListeners.currentStatus) {
            activeListeners.currentStatus();
            activeListeners.currentStatus = null;
        }
        
        // Setup ulang listener untuk status
        setTimeout(() => {
            setupCurrentStatusListener();
        }, 1000);
        
        // Update UI
        updateStatusUI();
        
        showNotification('Check-out berhasil!', 'success');
    }).catch(error => {
        console.error('Error updating check-out:', error);
        console.error('Error details:', error.message, error.code);
        
        // Coba force update dengan approach berbeda
        if (error.code === 'permission-denied') {
            showNotification('Gagal check-out: Akses ditolak. Coba logout dan login kembali.', 'error');
        } else if (error.code === 'not-found') {
            showNotification('Session tidak ditemukan di database. Membersihkan state lokal...', 'warning');
            
            // Clear local state
            checkInTime = null;
            currentSessionId = null;
            clearInterval(timerInterval);
            clearStateFromLocalStorage();
            updateStatusUI();
        } else {
            showNotification('Gagal melakukan check-out. Silakan coba lagi.', 'error');
        }
    });
});

        // Navigasi tab
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.nav-item').forEach(nav => {
                    nav.classList.remove('active');
                });
                
                this.classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.add('hidden');
                });
                
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.remove('hidden');
                
                if (tabId === 'history-tab') {
                    setupFullHistoryListener();
                } else if (tabId === 'weekly-tab') {
                    loadWeeklyReport();
                }
            });
        });

        // Navigasi mingguan
        document.getElementById('prevWeek').addEventListener('click', function() {
            currentWeekOffset--;
            loadWeeklyReport();
        });

        document.getElementById('nextWeek').addEventListener('click', function() {
            currentWeekOffset++;
            loadWeeklyReport();
        });

        // Navigasi mingguan di modal karyawan
        document.getElementById('prevEmployeeWeek').addEventListener('click', function() {
            currentEmployeeWeekOffset--;
            loadEmployeeWeeklyDetail(selectedEmployee);
        });

        document.getElementById('nextEmployeeWeek').addEventListener('click', function() {
            currentEmployeeWeekOffset++;
            loadEmployeeWeeklyDetail(selectedEmployee);
        });

        // Tutup modal karyawan
        document.getElementById('closeEmployeeDetail').addEventListener('click', function() {
            document.getElementById('employeeDetailModal').classList.add('hidden');
        });

        // ==================== DASHBOARD FUNCTIONS ====================

        // Tampilkan login popup
        function showLoginPopup() {
            document.getElementById('loginPopup').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('employeeDetailModal').classList.add('hidden');
            
            // Reset form
            document.getElementById('passwordInput').value = '';
            pendingEmployee = null;
            
            // Isi dropdown karyawan
            const employeeSelect = document.getElementById('employeeSelect');
            employeeSelect.innerHTML = '<option value="">Pilih Karyawan</option>';
            
            // Group karyawan berdasarkan role
            const groups = {
                'admin': 'Administrator',
                'boss': 'Pimpinan',
                'employee': 'Karyawan'
            };
            
            Object.keys(groups).forEach(role => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = groups[role];
                optgroup.className = 'optgroup';
                
                employees.forEach(employee => {
                    if (employee.role === role) {
                        const option = document.createElement('option');
                        option.value = employee.id;
                        option.textContent = `${employee.name} (${employee.position})`;
                        optgroup.appendChild(option);
                    }
                });
                
                if (optgroup.children.length > 0) {
                    employeeSelect.appendChild(optgroup);
                }
            });
        }

        // Tampilkan modal password
        function showPasswordModal(employee) {
            document.getElementById('selectedEmployeeName').textContent = employee.name;
            document.getElementById('selectedEmployeeRole').textContent = employee.role.toUpperCase();
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordInput').focus();
            document.getElementById('passwordModal').classList.remove('hidden');
        }

        // Update fungsi showDashboard untuk menambahkan force checkout button
        function showDashboard() {
            document.getElementById('loginPopup').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('forceCheckoutModal').classList.add('hidden');
            
            // Update info user
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.position;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
            
            // Tampilkan/hilangkan menu boss
            if (currentUser.role === 'boss' || currentUser.role === 'admin') {
                document.getElementById('bossNav').classList.remove('hidden');
                document.getElementById('weeklyNav').classList.remove('hidden');
                
                // Setup force checkout button
                const updateButtonVisibility = setupForceCheckoutButton();
                if (updateButtonVisibility) {
                    updateButtonVisibility();
                }
            } else {
                document.getElementById('bossNav').classList.add('hidden');
                document.getElementById('weeklyNav').classList.add('hidden');
                document.getElementById('forceCheckoutBtn').classList.add('hidden');
            }
            
            // Setup semua real-time listeners
            setupAllRealTimeListeners();
            
            // Cek session yang belum checkout dari kemarin
            checkUnclosedSessions();
            
            // Pastikan hanya ada satu session aktif
            ensureSingleActiveSession();
            
            // Mulai monitor pergantian hari
            startDayChangeMonitor();
            
            // Update status UI awal
            updateStatusUI();
            
            // Save state ke localStorage
            saveStateToLocalStorage();
        }

        // ==================== FUNGSI UTILITY TAMBAHAN ====================

    // Fungsi untuk debugging - tampilkan info session
    function debugSessionInfo() {
        console.log('=== DEBUG SESSION INFO ===');
        console.log('Current User:', currentUser?.name);
        console.log('CheckIn Time:', checkInTime);
        console.log('Current Session ID:', currentSessionId);
        console.log('LocalStorage State:', loadStateFromLocalStorage());
        console.log('WIB Time Now:', getWIBTime());
        console.log('==========================');
    }
        // ==================== EMPLOYEE DETAIL FUNCTIONS ====================

        // Tampilkan modal detail karyawan
        function showEmployeeDetail(employee) {
            selectedEmployee = employee;
            currentEmployeeWeekOffset = 0;
            
            document.getElementById('employeeDetailTitle').textContent = `Detail Karyawan - ${employee.name}`;
            document.getElementById('employeeDetailInfo').innerHTML = `
                <div><strong>Nama:</strong> ${employee.name}</div>
                <div><strong>Posisi:</strong> ${employee.position}</div>
                <div><strong>Role:</strong> ${employee.role}</div>
            `;
            
            loadEmployeeWeeklyDetail(employee);
            document.getElementById('employeeDetailModal').classList.remove('hidden');
        }

        // Load detail mingguan untuk karyawan tertentu - DIPERBAIKI
        function loadEmployeeWeeklyDetail(employee) {
            const { start, end } = getWeekDates(currentEmployeeWeekOffset);
            
            // Perbaiki tampilan range
            document.getElementById('employeeWeekRange').textContent = `Minggu ${formatWeekRange(start, end)}`;
            displayEmployeeWeeklyCalendar(employee, start);
        }

// Tampilkan kalender mingguan untuk karyawan tertentu - DIPERBAIKI
function displayEmployeeWeeklyCalendar(employee, startOfWeek) {
    const employeeDetailWeekElement = document.getElementById('employeeDetailWeek');
    employeeDetailWeekElement.innerHTML = '';
    
    const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];
    
    for (let i = 0; i < 7; i++) {
        const day = getDayOfWeek(startOfWeek, i);
        const dateString = day.toISOString().split('T')[0];
        
        const dayCard = document.createElement('div');
        dayCard.className = 'employee-day-card';
        dayCard.setAttribute('data-date', dateString);
        
        // Tampilkan info dasar dulu
        dayCard.innerHTML = `
            <div class="day-name">${days[i]}</div>
            <div class="day-date">${formatShortDate(day)}</div>
            <div class="day-hours">Loading...</div>
        `;
        
        // Kemudian load data attendance
        getEmployeeDayAttendance(employee.id, dateString).then(attendanceData => {
            let totalHours = 0;
            let sessionsHtml = '';
            
            if (attendanceData.length > 0) {
                dayCard.classList.add('has-data');
                
                attendanceData.forEach(session => {
                    if (session.checkIn) {
                        const checkInTime = formatTime(session.checkIn);
                        const checkOutTime = session.checkOut ? formatTime(session.checkOut) : 'Active';
                        const duration = session.duration || (session.checkOut ? calculateDuration(session.checkIn) : '0h 0m');
                        
                        sessionsHtml += `<div class="employee-session">${checkInTime} - ${checkOutTime}</div>`;
                        
                        if (session.checkOut) {
                            const diffMs = session.checkOut - session.checkIn;
                            totalHours += diffMs / (1000 * 60 * 60);
                        }
                    }
                });
            }
            
            dayCard.innerHTML = `
                <div class="day-name">${days[i]}</div>
                <div class="day-date">${formatShortDate(day)}</div>
                ${attendanceData.length > 0 ? 
                    `<div class="day-hours">${totalHours.toFixed(1)} jam</div>
                    <div class="employee-day-sessions">${sessionsHtml}</div>` : 
                    '<div class="day-hours">0 jam</div>'
                }
            `;
            
            dayCard.addEventListener('click', function() {
                const selectedDate = this.getAttribute('data-date');
                loadEmployeeDailyAttendance(employee, selectedDate);
            });
        });
        
        employeeDetailWeekElement.appendChild(dayCard);
    }
}

function debugDateCalculation() {
    const today = getWIBTime();
    console.log('Today:', today, formatDate(today));
    
    const startOfWeek = getStartOfWeek(today);
    const endOfWeek = getEndOfWeek(today);
    
    console.log('Start of week (Senin):', startOfWeek, formatDate(startOfWeek));
    console.log('End of week (Minggu):', endOfWeek, formatDate(endOfWeek));
    
    for (let i = 0; i < 7; i++) {
        const day = getDayOfWeek(startOfWeek, i);
        console.log(`Day ${i}:`, day, formatDate(day));
    }
}

        // Ambil data absensi karyawan untuk hari tertentu
        function getEmployeeDayAttendance(employeeId, dateString) {
            return new Promise((resolve) => {
                db.collection('attendance')
                    .where('employeeId', '==', employeeId)
                    .where('date', '==', dateString)
                    .get()
                    .then(querySnapshot => {
                        const attendanceData = [];
                        
                        querySnapshot.forEach(doc => {
                            const data = doc.data();
                            attendanceData.push({
                                checkIn: getTimestampData(data, 'checkIn'),
                                checkOut: getTimestampData(data, 'checkOut'),
                                duration: data.duration
                            });
                        });
                        
                        resolve(attendanceData);
                    }).catch(error => {
                        console.error('Error fetching employee day attendance:', error);
                        resolve([]);
                    });
            });
        }

        function loadEmployeeDailyAttendance(employee, dateString) {
            const employeeSelectedDayTitle = document.getElementById('employeeSelectedDayTitle');
            const employeeDailyAttendanceList = document.getElementById('employeeDailyAttendanceList');
            
            const date = new Date(dateString);
            employeeSelectedDayTitle.textContent = `Detail Absensi ${employee.name} - ${formatDate(date)}`;
            
            getEmployeeDayAttendance(employee.id, dateString).then(attendanceData => {
                employeeDailyAttendanceList.innerHTML = '';
                
                if (attendanceData.length === 0) {
                    employeeDailyAttendanceList.innerHTML = '<div class="no-data">Tidak ada absensi pada hari ini</div>';
                    return;
                }
                
                let totalDurationMinutes = 0;
                
                attendanceData.forEach(session => {
                    if (session.checkIn) {
                        const sessionItem = document.createElement('div');
                        sessionItem.className = 'daily-attendance-item';
                        
                        const checkInTime = formatTime(session.checkIn);
                        const checkOutTime = session.checkOut ? formatTime(session.checkOut) : 'Active';
                        const duration = session.duration || (session.checkOut ? calculateDuration(session.checkIn) : '0h 0m');
                        
                        sessionItem.innerHTML = `
                            <div class="daily-attendance-info">
                                <div class="daily-attendance-time">${checkInTime} - ${checkOutTime}</div>
                            </div>
                            <div class="daily-attendance-duration">${duration}</div>
                        `;
                        
                        employeeDailyAttendanceList.appendChild(sessionItem);
                        
                        if (session.checkOut) {
                            const diffMs = session.checkOut - session.checkIn;
                            totalDurationMinutes += diffMs / (1000 * 60);
                        }
                    }
                });
                
                const totalHours = Math.floor(totalDurationMinutes / 60);
                const totalMins = Math.floor(totalDurationMinutes % 60);
                const totalItem = document.createElement('div');
                totalItem.className = 'daily-attendance-item';
                totalItem.style.borderTop = '2px solid var(--accent-color)';
                totalItem.style.fontWeight = 'bold';
                totalItem.innerHTML = `
                    <div class="daily-attendance-info">
                        <div class="daily-attendance-name">Total</div>
                    </div>
                    <div class="daily-attendance-duration">${totalHours}h ${totalMins}m</div>
                `;
                
                employeeDailyAttendanceList.appendChild(totalItem);
            });
        }

        // ==================== WEEKLY REPORT FUNCTIONS ====================

        function loadWeeklyReport() {
            if (!currentUser || (currentUser.role !== 'boss' && currentUser.role !== 'admin')) return;
            
            const { start, end } = getWeekDates(currentWeekOffset);
            
            // Debug
            debugFullWeekCalculation();
            
            // Perbaiki tampilan range
            document.getElementById('currentWeekRange').textContent = `Minggu ${formatWeekRange(start, end)}`;
            calculateWeeklyStats(start, end);
            displayWeeklyCalendar(start);
        }

        // Hitung statistik mingguan
        function calculateWeeklyStats(startOfWeek, endOfWeek) {
            const totalEmployeesElement = document.getElementById('totalEmployees');
            const avgHoursElement = document.getElementById('avgHours');
            const underperformingElement = document.getElementById('underperforming');
            
            const totalEmployees = employees.filter(emp => emp.role !== 'admin').length;
            totalEmployeesElement.textContent = totalEmployees;
            
            let totalHoursAll = 0;
            let underperformingCount = 0;
            let employeeCount = 0;
            
            const promises = employees
                .filter(emp => emp.role !== 'admin')
                .map(employee => {
                    return calculateEmployeeWeeklyHoursForDateRange(employee.id, startOfWeek, endOfWeek)
                        .then(hours => {
                            totalHoursAll += hours;
                            employeeCount++;
                            if (hours < 21) {
                                underperformingCount++;
                            }
                        });
                });
            
            Promise.all(promises).then(() => {
                const avgHours = employeeCount > 0 ? totalHoursAll / employeeCount : 0;
                avgHoursElement.textContent = `${avgHours.toFixed(1)}h`;
                underperformingElement.textContent = underperformingCount;
            });
        }

        // Hitung jam kerja mingguan untuk rentang tanggal tertentu
        function calculateEmployeeWeeklyHoursForDateRange(employeeId, startDate, endDate) {
            return new Promise((resolve) => {
                db.collection('attendance')
                    .where('employeeId', '==', employeeId)
                    .get()
                    .then(querySnapshot => {
                        let totalMinutes = 0;
                        
                        querySnapshot.forEach(doc => {
                            const data = doc.data();
                            const checkInTime = getTimestampData(data, 'checkIn');
                            
                            if (checkInTime >= startDate && checkInTime <= endDate && data.checkOut) {
                                const checkOutTime = getTimestampData(data, 'checkOut');
                                const diffMs = checkOutTime - checkInTime;
                                totalMinutes += diffMs / (1000 * 60);
                            }
                        });
                        
                        const totalHours = totalMinutes / 60;
                        resolve(totalHours);
                    }).catch(error => {
                        console.error('Error calculating employee weekly hours:', error);
                        resolve(0);
                    });
            });
        }

// Tampilkan kalender mingguan - DIPERBAIKI (FIX DATA QUERY)
function displayWeeklyCalendar(startOfWeek) {
    const weeklyCalendarElement = document.getElementById('weeklyCalendar');
    weeklyCalendarElement.innerHTML = '';
    
    const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];
    
    console.log('=== DEBUG DISPLAY CALENDAR ===');
    console.log('Start of Week (Monday):', formatDate(startOfWeek));
    
    for (let i = 0; i < 7; i++) {
        const day = getDayOfWeek(startOfWeek, i);
        const dateString = getDateString(day); // Gunakan fungsi ini
        
        console.log(`${days[i]} (index ${i}):`, formatDate(day), 'Date String:', dateString);
        
        const dayCard = document.createElement('div');
        dayCard.className = 'day-card';
        dayCard.setAttribute('data-date', dateString);
        dayCard.setAttribute('data-day-index', i);
        
        // Tampilkan tanggal dan nama hari
        dayCard.innerHTML = `
            <div class="day-name">${days[i]}</div>
            <div class="day-date">${formatShortDate(day)}</div>
            <div class="day-hours">Loading...</div>
        `;
        
        // Load data attendance untuk hari ini
        // Pastikan query ke Firebase menggunakan dateString yang sama
        setTimeout(() => {
            calculateDayTotalHours(dateString).then(totalHours => {
                let hoursClass = '';
                if (totalHours === 0) {
                    hoursClass = 'low-hours';
                } else if (totalHours < 10) {
                    hoursClass = 'low-hours';
                } else {
                    hoursClass = 'good-hours';
                }
                
                const hoursElement = dayCard.querySelector('.day-hours');
                hoursElement.className = `day-hours ${hoursClass}`;
                hoursElement.textContent = `${totalHours.toFixed(1)} jam`;
                
                console.log(`Set ${days[i]} (${dateString}) to ${totalHours.toFixed(1)} hours`);
            });
        }, i * 100);
        
        dayCard.addEventListener('click', function() {
            const selectedDate = this.getAttribute('data-date');
            const dayIndex = this.getAttribute('data-day-index');
            console.log(`Clicked ${days[dayIndex]}:`, selectedDate);
            loadDailyAttendance(selectedDate);
        });
        
        weeklyCalendarElement.appendChild(dayCard);
    }
    console.log('=== END DEBUG ===');
}

// Fungsi untuk convert tanggal ke string YYYY-MM-DD
function getDateString(date) {
    const d = new Date(date);
    // Gunakan WIB time untuk konsistensi
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}


// Hitung total jam untuk hari tertentu - DIPERBAIKI (FIX QUERY)
function calculateDayTotalHours(dateString) {
    return new Promise((resolve) => {
        console.log(`Querying hours for date: ${dateString}`);
        
        // Query menggunakan field 'date' yang sudah ada di Firebase
        db.collection('attendance')
            .where('date', '==', dateString)
            .get()
            .then(querySnapshot => {
                console.log(`Found ${querySnapshot.size} records for ${dateString}`);
                
                let totalMinutes = 0;
                let count = 0;
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    count++;
                    
                    if (data.checkOut) {
                        const checkInTime = getTimestampData(data, 'checkIn');
                        const checkOutTime = getTimestampData(data, 'checkOut');
                        
                        if (checkInTime && checkOutTime) {
                            const diffMs = checkOutTime - checkInTime;
                            const minutes = diffMs / (1000 * 60);
                            totalMinutes += minutes;
                            console.log(`Record ${count}: ${data.employeeName} - ${minutes.toFixed(2)} min`);
                        }
                    }
                });
                
                const totalHours = totalMinutes / 60;
                console.log(`Total for ${dateString}: ${totalHours.toFixed(2)} hours from ${count} records`);
                resolve(totalHours);
            }).catch(error => {
                console.error('Error calculating day total hours:', error);
                resolve(0);
            });
    });
}

        // Load daily attendance details
        function loadDailyAttendance(dateString) {
            const selectedDayTitle = document.getElementById('selectedDayTitle');
            const dailyAttendanceList = document.getElementById('dailyAttendanceList');
            
            // Parse date string dengan benar
            const [year, month, day] = dateString.split('-');
            const date = new Date(year, month - 1, day); // month - 1 karena JavaScript month 0-based
            
            // Dapatkan nama hari dalam bahasa Indonesia
            const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const dayName = dayNames[date.getDay()];
            
            // Format tanggal dengan benar
            const formattedDate = date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

           selectedDayTitle.textContent = `Detail Absensi - ${dayName}, ${formattedDate}`;

            console.log('Loading attendance for:', dateString, 'Day:', dayName);
            
            db.collection('attendance')
                .where('date', '==', dateString)
                .get()
                .then(querySnapshot => {
                    dailyAttendanceList.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        dailyAttendanceList.innerHTML = '<div class="no-data">Tidak ada absensi pada hari ini</div>';
                        return;
                    }
                    
                    const attendanceByEmployee = {};
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const employeeId = data.employeeId;
                        
                        if (!attendanceByEmployee[employeeId]) {
                            attendanceByEmployee[employeeId] = {
                                name: data.employeeName,
                                sessions: []
                            };
                        }
                        
                        attendanceByEmployee[employeeId].sessions.push({
                            checkIn: getTimestampData(data, 'checkIn'),
                            checkOut: getTimestampData(data, 'checkOut'),
                            duration: data.duration
                        });
                    });
                    
                    Object.values(attendanceByEmployee).forEach(employeeData => {
                        const employeeItem = document.createElement('div');
                        employeeItem.className = 'daily-attendance-item';
                        
                        let totalDurationMinutes = 0;
                        let sessionsHtml = '';
                        
                        employeeData.sessions.forEach(session => {
                            const checkInTime = formatTime(session.checkIn);
                            const checkOutTime = session.checkOut ? formatTime(session.checkOut) : 'Active';
                            const duration = session.duration || (session.checkOut ? calculateDuration(session.checkIn) : '0h 0m');
                            
                            sessionsHtml += `<div class="daily-attendance-time">${checkInTime} - ${checkOutTime}</div>`;
                            
                            if (session.checkOut) {
                                const diffMs = session.checkOut - session.checkIn;
                                totalDurationMinutes += diffMs / (1000 * 60);
                            }
                        });
                        
                        const totalHours = Math.floor(totalDurationMinutes / 60);
                        const totalMins = Math.floor(totalDurationMinutes % 60);
                        const totalDuration = `${totalHours}h ${totalMins}m`;
                        
                        employeeItem.innerHTML = `
                            <div class="daily-attendance-info">
                                <div class="daily-attendance-name">${employeeData.name}</div>
                                ${sessionsHtml}
                            </div>
                            <div class="daily-attendance-duration">${totalDuration}</div>
                        `;
                        
                        dailyAttendanceList.appendChild(employeeItem);
                    });
                }).catch(error => {
                    console.error('Error loading daily attendance:', error);
                    dailyAttendanceList.innerHTML = '<div class="no-data">Error loading data</div>';
                });
        }

        // Fungsi untuk debug lengkap
function debugFullWeekCalculation() {
    const today = getWIBTime();
    console.log('=== FULL WEEK DEBUG ===');
    console.log('Hari ini:', formatDate(today));
    console.log('Hari (0=Minggu, 1=Senin):', today.getDay());
    
    const { start, end } = getWeekDates(currentWeekOffset);
    console.log('Minggu offset:', currentWeekOffset);
    console.log('Start of Week (harus Senin):', formatDate(start), 'Date String:', getDateString(start));
    console.log('End of Week (harus Minggu):', formatDate(end), 'Date String:', getDateString(end));
    
    console.log('\nHari-hari dalam kalender:');
    const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];
    for (let i = 0; i < 7; i++) {
        const day = getDayOfWeek(start, i);
        console.log(`${days[i]}: ${formatDate(day)} - Date String: ${getDateString(day)}`);
    }
    
    // Cek data di Firebase untuk setiap hari
    console.log('\nChecking Firebase data for each day:');
    for (let i = 0; i < 7; i++) {
        const day = getDayOfWeek(start, i);
        const dateString = getDateString(day);
        
        setTimeout(() => {
            db.collection('attendance')
                .where('date', '==', dateString)
                .get()
                .then(snapshot => {
                    console.log(`${days[i]} (${dateString}): ${snapshot.size} records`);
                });
        }, i * 200);
    }
    
    console.log('=== END DEBUG ===');
}

        // ==================== INITIALIZATION ====================

    function initApp() {
        setInterval(updateTime, 1000);
        updateTime();
        
        // Start timer untuk update waktu utama
        setInterval(updateTime, 1000);
        
        // Update waktu dashboard hub
        setInterval(() => {
            const wibTime = getWIBTime();
            document.getElementById('hubCurrentTime').textContent = formatTime(wibTime);
            document.getElementById('hubCurrentDate').textContent = formatDate(wibTime);
        }, 1000);
        
        document.getElementById('employeeDetailModal').classList.add('hidden');
        document.getElementById('passwordModal').classList.add('hidden');
        

        
        // Setup beforeunload listener
        setupBeforeUnloadListener();

        startSessionCleanupMonitor();

        setupAdminForceCheckout();
        
        // Coba recover session terlebih dahulu
        setTimeout(async () => {
            const recovered = await checkAndRecoverSession();
            if (!recovered) {
                // Jika tidak ada session yang di-recover, tampilkan login
                showLoginPopup();
            }
        }, 500);
        
        console.log('Attendance System initialized with improved day change handling');
    }

                // Fungsi untuk membersihkan session yang "terjebak"
        function cleanupStuckSessions() {
            // Cek semua session yang browserClosed: true dan belum checkout selama > 1 jam
            const oneHourAgo = new Date(getWIBTime().getTime() - (60 * 60 * 1000));
            
            db.collection('attendance')
                .where('status', '==', 'active')
                .where('browserClosed', '==', true)
                .where('checkIn', '<', firebase.firestore.Timestamp.fromDate(oneHourAgo))
                .get()
                .then(querySnapshot => {
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const checkInTimeData = getTimestampData(data, 'checkIn');
                        
                        if (checkInTimeData) {
                            const now = getWIBTime();
                            const diffMs = now - checkInTimeData;
                            const diffHours = diffMs / (1000 * 60 * 60);
                            
                            if (diffHours > 24) {
                                // Session lebih dari 24 jam, auto checkout
                                const duration = calculateDurationForPeriod(checkInTimeData, now);
                                
                                db.collection('attendance').doc(doc.id).update({
                                    checkOut: firebase.firestore.Timestamp.fromDate(now),
                                    duration: duration,
                                    status: 'completed',
                                    autoCheckout: true,
                                    note: 'Auto closed by system - browser closed for too long'
                                }).then(() => {
                                    console.log(`Auto closed stuck session: ${doc.id}`);
                                });
                            }
                        }
                    });
                }).catch(error => {
                    console.error('Error cleaning stuck sessions:', error);
                });
        }

        // Jalankan cleanup stuck sessions setiap 5 menit
        setInterval(cleanupStuckSessions, 5 * 60 * 1000);

        // Jalankan aplikasi saat halaman dimuat
        window.addEventListener('load', initApp);

        // Tambahkan event listener untuk dropdown
        document.getElementById('employeeSelect').addEventListener('change', function() {
            const select = this;
            
            // Reset semua class
            select.classList.remove('error', 'success', 'loading');
            
            if (select.value) {
                select.classList.add('success');
            } else {
                select.classList.add('error');
            }
        });
    </script>
</body>
</html>